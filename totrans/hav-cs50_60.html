<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
  "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Lecture 3</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>Lecture 3</h1>
<blockquote>原文：<a href="https://cs50.harvard.edu/sql/notes/3/">https://cs50.harvard.edu/sql/notes/3/</a></blockquote>

                    

<ul id="markdown-toc">
  <li><a href="#introduction" id="markdown-toc-introduction">Introduction</a></li>
  <li><a href="#database-schema" id="markdown-toc-database-schema">Database Schema</a></li>
  <li><a href="#inserting-data" id="markdown-toc-inserting-data">Inserting Data</a>    <ul>
      <li><a href="#questions" id="markdown-toc-questions">Questions</a></li>
    </ul>
  </li>
  <li><a href="#other-constraints" id="markdown-toc-other-constraints">Other Constraints</a></li>
  <li><a href="#inserting-multiple-rows" id="markdown-toc-inserting-multiple-rows">Inserting Multiple Rows</a>    <ul>
      <li><a href="#questions-1" id="markdown-toc-questions-1">Questions</a></li>
    </ul>
  </li>
  <li><a href="#deleting-data" id="markdown-toc-deleting-data">Deleting Data</a>    <ul>
      <li><a href="#questions-2" id="markdown-toc-questions-2">Questions</a></li>
    </ul>
  </li>
  <li><a href="#updating-data" id="markdown-toc-updating-data">Updating Data</a></li>
  <li><a href="#triggers" id="markdown-toc-triggers">Triggers</a>    <ul>
      <li><a href="#creating-a-sell-trigger" id="markdown-toc-creating-a-sell-trigger">Creating a “Sell” Trigger</a></li>
      <li><a href="#creating-a-buy-trigger" id="markdown-toc-creating-a-buy-trigger">Creating a “Buy” Trigger</a></li>
      <li><a href="#questions-3" id="markdown-toc-questions-3">Questions</a></li>
    </ul>
  </li>
  <li><a href="#soft-deletions" id="markdown-toc-soft-deletions">Soft Deletions</a></li>
  <li><a href="#fin" id="markdown-toc-fin">Fin</a></li>
</ul>

<h2 id="introduction">Introduction</h2>

<ul>
  <li data-marker="*">Last week, we learned how to create our own database schema. In this lecture, we’ll explore how to add, update, and delete data in our databases.</li>
  <li data-marker="*">The Boston MFA (Museum of Fine Arts) is a century-old museum in Boston. The MFA manages a vast collection of historical and contemporary artifacts and artwork. They likely use a database of some kind to store data about their art and artifacts.</li>
  <li data-marker="*">When a new artifact is added to their collection, we can imagine they would insert the corresponding data to their database. Similarly, there are use cases in which data might need to be read, updated or deleted.</li>
  <li data-marker="*">We will focus now on the creation (or insertion) of data in a Boston MFA database.</li>
</ul>

<h2 id="database-schema">Database Schema</h2>

<ul>
  <li data-marker="*">
    <p>Consider this schema that the MFA might use for its collection.</p>

    <p class="w-50"><img src="../Images/1d4a6ad032325ea7543c7f7885755730.png" alt="&quot;MFA Collections Table containing IDs, titles of artwork and other information&quot;" data-original-src="https://cs50.harvard.edu/sql/notes/3/images/11.jpg"/></p>
  </li>
  <li data-marker="*">Each row of data contains the title for a piece of artwork along with the <code class="language-plaintext highlighter-rouge">accession_number</code> which is a unique ID used by the museum internally. There is, too, a date indicating when the art was acquired.</li>
  <li data-marker="*">The table contains an ID which serves as the primary key.</li>
  <li data-marker="*">We can imagine that the database administrator of the MFA runs an SQL query to insert each of these pieces of artwork into the table.</li>
  <li data-marker="*">To understand how this works, let us first create a database called <code class="language-plaintext highlighter-rouge">mfa.db</code>. Next, we read the schema file <code class="language-plaintext highlighter-rouge">schema.sql</code> into the database. This schema file, already given to us, helps us create the table <code class="language-plaintext highlighter-rouge">collections</code>.</li>
  <li data-marker="*">
    <p>To confirm that the table has been created, we can select from the table.</p>

    <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="nv">"collections"</span><span class="p">;</span>
</code></pre></div>    </div>

    <p>This should give us an empty result, because the table doesn’t have any data yet.</p>
  </li>
</ul>

<h2 id="inserting-data">Inserting Data</h2>
<ul>
  <li data-marker="*">
    <p>The SQL statement <code class="language-plaintext highlighter-rouge">INSERT INTO</code> is used to insert a row of data into a given table.</p>

    <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">INSERT</span> <span class="k">INTO</span> <span class="nv">"collections"</span> <span class="p">(</span><span class="nv">"id"</span><span class="p">,</span> <span class="nv">"title"</span><span class="p">,</span> <span class="nv">"accession_number"</span><span class="p">,</span> <span class="nv">"acquired"</span><span class="p">)</span>
<span class="k">VALUES</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">'Profusion of flowers'</span><span class="p">,</span> <span class="s1">'56.257'</span><span class="p">,</span> <span class="s1">'1956-04-12'</span><span class="p">);</span>
</code></pre></div>    </div>

    <p>We can see that this command requires the list of columns in the table that will receive new data and the values to be added to each column, in the same order.</p>
  </li>
  <li data-marker="*">
    <p>Running the <code class="language-plaintext highlighter-rouge">INSERT INTO</code> command returns nothing, but we can run a query to confirm that the row is now present in <code class="language-plaintext highlighter-rouge">collections</code>.</p>

    <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="nv">"collections"</span><span class="p">;</span>
</code></pre></div>    </div>
  </li>
  <li data-marker="*">
    <p>We can add more rows to the database by inserting multiple times. However, typing out the value of the primary key manually (as 1, 2, 3 etc.) might result in errors. Thankfully, SQLite can fill out the primary key values automatically. To make use of this functionality, we omit the ID column altogether while inserting a row.</p>

    <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">INSERT</span> <span class="k">INTO</span> <span class="nv">"collections"</span> <span class="p">(</span><span class="nv">"title"</span><span class="p">,</span> <span class="nv">"accession_number"</span><span class="p">,</span> <span class="nv">"acquired"</span><span class="p">)</span>
<span class="k">VALUES</span> <span class="p">(</span><span class="s1">'Farmers working at dawn'</span><span class="p">,</span> <span class="s1">'11.6152'</span><span class="p">,</span> <span class="s1">'1911-08-03'</span><span class="p">);</span>
</code></pre></div>    </div>

    <p>We can check that this row has been inserted with an <code class="language-plaintext highlighter-rouge">id</code> of 2 by running</p>

    <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="nv">"collections"</span><span class="p">;</span>
</code></pre></div>    </div>

    <p>Notice that the way SQLite fills out the primary key values is by incrementing the previous primary key—in this case, 1.</p>
  </li>
</ul>

<h3 id="questions">Questions</h3>

<blockquote>
  <p>If we delete a row with the primary key 1, will SQLite automatically assign a primary key of 1 to the next inserted row?</p>
</blockquote>

<ul>
  <li data-marker="*">No, SQLite actually selects the highest primary key value in the table and increments it to generate the next primary key value.</li>
</ul>

<h2 id="other-constraints">Other Constraints</h2>

<ul>
  <li data-marker="*">
    <p>Opening the file <code class="language-plaintext highlighter-rouge">schema.sql</code> will pull up the schema for the database.</p>

    <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="nv">"collections"</span> <span class="p">(</span>
    <span class="nv">"id"</span> <span class="nb">INTEGER</span><span class="p">,</span>
    <span class="nv">"title"</span> <span class="nb">TEXT</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="nv">"accession_number"</span> <span class="nb">TEXT</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">UNIQUE</span><span class="p">,</span>
    <span class="nv">"acquired"</span> <span class="nb">NUMERIC</span><span class="p">,</span>
    <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">(</span><span class="nv">"id"</span><span class="p">)</span>
<span class="p">);</span>
</code></pre></div>    </div>
  </li>
  <li data-marker="*">It is specified that the accession number is unique. If we try to insert a row with a repeated accession number, we will trigger a error that looks like <code class="language-plaintext highlighter-rouge">Runtime error: UNIQUE constraint failed: collections.accession_number (19)</code>.</li>
  <li data-marker="*">This error informs us that the row we are trying to insert violates a constraint in the schema—specifically the <code class="language-plaintext highlighter-rouge">UNIQUE</code> constraint in this scenario.</li>
  <li data-marker="*">
    <p>Similarly, we can try to add a row with a <code class="language-plaintext highlighter-rouge">NULL</code> title, violating the <code class="language-plaintext highlighter-rouge">NOT NULL</code> constraint.</p>

    <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">INSERT</span> <span class="k">INTO</span> <span class="nv">"collections"</span> <span class="p">(</span><span class="nv">"title"</span><span class="p">,</span> <span class="nv">"accession_number"</span><span class="p">,</span> <span class="nv">"acquired"</span><span class="p">)</span>
<span class="k">VALUES</span><span class="p">(</span><span class="k">NULL</span><span class="p">,</span> <span class="k">NULL</span><span class="p">,</span> <span class="s1">'1900-01-10'</span><span class="p">);</span>
</code></pre></div>    </div>

    <p>On running this, we will again see an error that looks like <code class="language-plaintext highlighter-rouge">Runtime error: NOT NULL constraint failed: collections.title (19)</code>.</p>
  </li>
  <li data-marker="*">In this manner, the schema constraints are guardrails that protect us from adding rows that do not follow the schema of our database.</li>
</ul>

<h2 id="inserting-multiple-rows">Inserting Multiple Rows</h2>

<ul>
  <li data-marker="*">
    <p>We may need to insert more than one row at a time while writing into a database. One way to do this is to separate out the rows using commas in the <code class="language-plaintext highlighter-rouge">INSERT INTO</code> command.</p>

    <p class="w-50"><img src="../Images/ff24439bb0c509f1c81bf0ee7ee4a194.png" alt="&quot;Inserting multiple rows at once separated by commas&quot;" data-original-src="https://cs50.harvard.edu/sql/notes/3/images/13.jpg"/></p>

    <p>Inserting multiple rows at once in this manner allows the programmer some convenience. It is also a faster, more efficient way of inserting rows into a database.</p>
  </li>
  <li data-marker="*">
    <p>Let us now insert two new paintings into the <code class="language-plaintext highlighter-rouge">collections</code> table.</p>

    <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">INSERT</span> <span class="k">INTO</span> <span class="nv">"collections"</span> <span class="p">(</span><span class="nv">"title"</span><span class="p">,</span> <span class="nv">"accession_number"</span><span class="p">,</span> <span class="nv">"acquired"</span><span class="p">)</span> 
<span class="k">VALUES</span> 
<span class="p">(</span><span class="s1">'Imaginative landscape'</span><span class="p">,</span> <span class="s1">'56.496'</span><span class="p">,</span> <span class="k">NULL</span><span class="p">),</span>
<span class="p">(</span><span class="s1">'Peonies and butterfly'</span><span class="p">,</span> <span class="s1">'06.1899'</span><span class="p">,</span> <span class="s1">'1906-01-01'</span><span class="p">);</span>
</code></pre></div>    </div>

    <p>The museum may not always know exactly when a painting was acquired, hence it is possible for the <code class="language-plaintext highlighter-rouge">acquired</code> value to be <code class="language-plaintext highlighter-rouge">NULL</code>, as is the case for the first painting we just inserted.</p>
  </li>
  <li data-marker="*">
    <p>To see the updated table, we can select all rows from the table as always.</p>

    <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="nv">"collections"</span><span class="p">;</span>
</code></pre></div>    </div>
  </li>
  <li data-marker="*">
    <p>Our data could also be stored in a <a href="https://en.wikipedia.org/wiki/Comma-separated_values">comma-separated values</a> format, or CSV. Observe in the following example how the values in each row are separated by a comma.</p>

    <p class="w-50"><img src="../Images/e789fafb524dd0bc004121131620fa3c.png" alt="&quot;Paintings data in comma-separated values format&quot;" data-original-src="https://cs50.harvard.edu/sql/notes/3/images/14.jpg"/></p>
  </li>
  <li data-marker="*">SQLite makes it possible to import a CSV file directly into our database. To do this, we need to start from scratch. Let us leave this database <code class="language-plaintext highlighter-rouge">mfa.db</code> and then remove it.</li>
  <li data-marker="*">We already have a CSV file called <code class="language-plaintext highlighter-rouge">mfa.csv</code> that contains the data we need. On opening up this file, we can note that the first row contains the column names, which match exactly with the column names of our table <code class="language-plaintext highlighter-rouge">collections</code> as per the schema.</li>
  <li data-marker="*">First, let us create again the database <code class="language-plaintext highlighter-rouge">mfa.db</code> and read the schema file as we did earlier.</li>
  <li data-marker="*">
    <p>Next, we can import the CSV by running a SQLite command.</p>

    <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">.</span><span class="n">import</span> <span class="c1">--csv --skip 1 mfa.csv collections</span>
</code></pre></div>    </div>

    <p>The first argument, <code class="language-plaintext highlighter-rouge">--csv</code> indicates to SQLite that we are importing a CSV file. This will help SQLite parse the file correctly. The second argument indicates that the first row of the CSV file (the header row) needs to be skipped, or not inserted into the table.</p>
  </li>
  <li data-marker="*">We can select all the data from the <code class="language-plaintext highlighter-rouge">collections</code> table to see that every painting from <code class="language-plaintext highlighter-rouge">mfa.csv</code> has been successfully imported into the table.</li>
  <li data-marker="*">The CSV file we just inserted contained primary key values (1, 2, 3 etc.) for each row of data. However, it is more likely that CSV files we work with will not contain the ID or primary key values. How can we have SQLite insert them automatically?</li>
  <li data-marker="*">
    <p>To try this out, let’s open up <code class="language-plaintext highlighter-rouge">mfa.csv</code> in our codespace and delete the <code class="language-plaintext highlighter-rouge">id</code> column from the header row, along with the values in each column. This is what <code class="language-plaintext highlighter-rouge">mfa.csv</code> should look like once we finish editing:</p>

    <pre><code class="language-csv">title,accession_number,acquired
Profusion of flowers,56.257,1956-04-12
Farmers working at dawn,11.6152,1911-08-03
Spring outing,14.76,1914-01-08
Imaginative landscape,56.496,
Peonies and butterfly,06.1899,1906-01-01
</code></pre>
  </li>
  <li data-marker="*">
    <p>We will also delete all the rows that are already within the <code class="language-plaintext highlighter-rouge">collections</code> table.</p>

    <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">DELETE</span> <span class="k">FROM</span> <span class="nv">"collections"</span><span class="p">;</span>
</code></pre></div>    </div>
  </li>
  <li data-marker="*">Now, we want to import this CSV file into a table. However, the <code class="language-plaintext highlighter-rouge">collections</code> table (as per our schema) must have four columns in every row. This new CSV file contains only three columns for every row. Hence, we cannot proceed to import in the same way we did before.</li>
  <li data-marker="*">
    <p>To successfully import the CSV file without ID values, we will to use a temporary table:</p>

    <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">.</span><span class="n">import</span> <span class="c1">--csv mfa.csv temp</span>
</code></pre></div>    </div>

    <p>Notice how we don’t use the argument <code class="language-plaintext highlighter-rouge">--skip 1</code> with this command. This is because SQLite is capable of recognizing the very first row of CSV data as the header row, and converts those into the column names of the new <code class="language-plaintext highlighter-rouge">temp</code> table.</p>
  </li>
  <li data-marker="*">
    <p>We can see the data within the <code class="language-plaintext highlighter-rouge">temp</code> table by querying it.</p>

    <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="nv">"temp"</span><span class="p">;</span>
</code></pre></div>    </div>
  </li>
  <li data-marker="*">
    <p>Next, we will select the data (without primary keys) from <code class="language-plaintext highlighter-rouge">temp</code> and move it to <code class="language-plaintext highlighter-rouge">collections</code>, which was the goal all along! We can use the following command to achieve this.</p>

    <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">INSERT</span> <span class="k">INTO</span> <span class="nv">"collections"</span> <span class="p">(</span><span class="nv">"title"</span><span class="p">,</span> <span class="nv">"accession_number"</span><span class="p">,</span> <span class="nv">"acquired"</span><span class="p">)</span> 
<span class="k">SELECT</span> <span class="nv">"title"</span><span class="p">,</span> <span class="nv">"accession_number"</span><span class="p">,</span> <span class="nv">"acquired"</span> <span class="k">FROM</span> <span class="nv">"temp"</span><span class="p">;</span>
</code></pre></div>    </div>

    <p>In this process, SQLite will automatically add the primary key values in the <code class="language-plaintext highlighter-rouge">id</code> column.</p>
  </li>
  <li data-marker="*">
    <p>Just to clean up our database, we can also drop the <code class="language-plaintext highlighter-rouge">temp</code> table once we’re done moving data.</p>

    <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">DROP</span> <span class="k">TABLE</span> <span class="nv">"temp"</span><span class="p">;</span>
</code></pre></div>    </div>
  </li>
</ul>

<h3 id="questions-1">Questions</h3>

<blockquote>
  <p>Can we place columns in specific positions while inserting into a table?</p>
</blockquote>

<ul>
  <li data-marker="*">While we can change the ordering of values in the <code class="language-plaintext highlighter-rouge">INSERT INTO</code> command, we usually can’t change the ordering of the column names themselves. The order of column names follows the same order used while creating the table.</li>
</ul>

<blockquote>
  <p>What happens if one of the multiple rows we are trying to insert violates a table constraint?</p>
</blockquote>

<ul>
  <li data-marker="*">While trying to insert multiple rows into a table, if even one of them violates a constraint, the insertion command will result in an error and none of the rows will be inserted!</li>
</ul>

<blockquote>
  <p>After inserting data from the CSV, one of the cells was empty and not <code class="language-plaintext highlighter-rouge">NULL</code>. Why did this happen?</p>
</blockquote>

<ul>
  <li data-marker="*">When we imported data from the CSV file, one of the <code class="language-plaintext highlighter-rouge">acquired</code> values was missing! This was interpreted as text and hence, read into the table as an empty text value. We can run queries on the table after importing to convert these empty values into <code class="language-plaintext highlighter-rouge">NULL</code> if required.</li>
</ul>

<h2 id="deleting-data">Deleting Data</h2>

<ul>
  <li data-marker="*">
    <p>We saw previously that running the following command deleted all rows from the table <code class="language-plaintext highlighter-rouge">collections</code>. (We don’t want to actually run this command now or we’ll lose all the data in the table!)</p>

    <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">DELETE</span> <span class="k">FROM</span> <span class="nv">"collections"</span><span class="p">;</span>
</code></pre></div>    </div>
  </li>
  <li data-marker="*">
    <p>We can also delete rows that match specific conditions. For example, to delete the painting “Spring outing” from our table <code class="language-plaintext highlighter-rouge">collections</code> we can run:</p>

    <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">DELETE</span> <span class="k">FROM</span> <span class="nv">"collections"</span>
<span class="k">WHERE</span> <span class="nv">"title"</span> <span class="o">=</span> <span class="s1">'Spring outing'</span><span class="p">;</span>
</code></pre></div>    </div>
  </li>
  <li data-marker="*">
    <p>To delete any paintings with the date acquired as <code class="language-plaintext highlighter-rouge">NULL</code> we can run</p>

    <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">DELETE</span> <span class="k">FROM</span> <span class="nv">"collections"</span>
<span class="k">WHERE</span> <span class="nv">"acquired"</span> <span class="k">IS</span> <span class="k">NULL</span><span class="p">;</span>
</code></pre></div>    </div>
  </li>
  <li data-marker="*">
    <p>As we always do, we will make sure the deletion worked as expected by selecting all data from the table.</p>

    <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="nv">"collections"</span><span class="p">;</span>
</code></pre></div>    </div>

    <p>We see that the “Spring outing” and “Imaginative landscape” paintings are not in the table anymore.</p>
  </li>
  <li data-marker="*">
    <p>To delete rows pertaining to paintings older than 1909, we can run</p>

    <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">DELETE</span> <span class="k">FROM</span> <span class="nv">"collections"</span>
<span class="k">WHERE</span> <span class="nv">"acquired"</span> <span class="o">&lt;</span> <span class="s1">'1909-01-01'</span><span class="p">;</span>
</code></pre></div>    </div>

    <p>Using the <code class="language-plaintext highlighter-rouge">&lt;</code> operator here, we are finding the paintings acquired <strong>before</strong> January 1, 1909. These are the paintings that will be deleted on running the query.</p>
  </li>
  <li data-marker="*">There might be cases where deleting some data could impact the integrity of a database. Foreign key constraints are a good example. A foreign key column references the primary key of a different table. If we were to delete the primary key, the foreign key column would have nothing to reference!</li>
  <li data-marker="*">
    <p>Consider now an updated schema for the MFA database, containing information not just about artwork but also artists. The two entities Artist and Collection have a many-to-many relationship—a painting can be created by many artists and a single artist can also create many pieces of artwork.</p>

    <p class="w-50"><img src="../Images/f58f93a48e8212621493f29a34edc06f.png" alt="&quot;Updated schema with artist and collection entities&quot;" data-original-src="https://cs50.harvard.edu/sql/notes/3/images/29.jpg"/></p>
  </li>
  <li data-marker="*">
    <p>Here is a database implementing the above ER Diagram.</p>

    <p class="w-50"><img src="../Images/a46c676e9328b03f588d06f29f307160.png" alt="&quot;Three tables: artists, created, collections&quot;" data-original-src="https://cs50.harvard.edu/sql/notes/3/images/30.jpg"/></p>

    <p>The <code class="language-plaintext highlighter-rouge">artists</code> and <code class="language-plaintext highlighter-rouge">collections</code> tables have primary keys—the ID columns. The <code class="language-plaintext highlighter-rouge">created</code> table references these IDs in its two foreign key columns.</p>
  </li>
  <li data-marker="*">Given this database, if we choose to delete the unidentified artist (with the ID 3), what would happen to the rows in the table <code class="language-plaintext highlighter-rouge">created</code> with an <code class="language-plaintext highlighter-rouge">artist_id</code> of 3? Let’s try it out.</li>
  <li data-marker="*">After opening up <code class="language-plaintext highlighter-rouge">mfa.db</code>, we can now see the updated schema by running the <code class="language-plaintext highlighter-rouge">.schema</code> command. The <code class="language-plaintext highlighter-rouge">created</code> table does indeed have two foreign key constraints, one for the artist ID and one for the collection ID.</li>
  <li data-marker="*">
    <p>Now, we can try to delete from the <code class="language-plaintext highlighter-rouge">artists</code> table.</p>

    <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">DELETE</span> <span class="k">FROM</span> <span class="nv">"artists"</span>
<span class="k">WHERE</span> <span class="nv">"name"</span> <span class="o">=</span> <span class="s1">'Unidentified artist'</span><span class="p">;</span>
</code></pre></div>    </div>

    <p>On running this, we get an error very similar to ones we have seen before in this class: <code class="language-plaintext highlighter-rouge">Runtime error: FOREIGN KEY constraint failed (19)</code>. This error notifies us that deleting this data would violate the foreign key constraint set up in the <code class="language-plaintext highlighter-rouge">created</code> table.</p>
  </li>
  <li data-marker="*">
    <p>How do we ensure that the constraint is not violated? One possibility is to delete the corresponding rows from the <code class="language-plaintext highlighter-rouge">created</code> table before deleting from the <code class="language-plaintext highlighter-rouge">artists</code> table.</p>

    <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">DELETE</span> <span class="k">FROM</span> <span class="nv">"created"</span>
<span class="k">WHERE</span> <span class="nv">"artist_id"</span> <span class="o">=</span> <span class="p">(</span>
    <span class="k">SELECT</span> <span class="nv">"id"</span>
    <span class="k">FROM</span> <span class="nv">"artists"</span>
    <span class="k">WHERE</span> <span class="nv">"name"</span> <span class="o">=</span> <span class="s1">'Unidentified artist'</span>
<span class="p">);</span>
</code></pre></div>    </div>

    <p>This query effectively deletes the artist’s <em>affiliation</em> with their work. Once the affiliation no longer exists, we can delete the artist’s data without violating the foreign key constraint. To do this, we can run</p>

    <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">DELETE</span> <span class="k">FROM</span> <span class="nv">"artists"</span>
<span class="k">WHERE</span> <span class="nv">"name"</span> <span class="o">=</span> <span class="s1">'Unidentified artist'</span><span class="p">;</span>
</code></pre></div>    </div>
  </li>
  <li data-marker="*">In another possibility, we can specify the action to be taken when an ID referenced by a foreign key is deleted. To do this, we use the keyword <code class="language-plaintext highlighter-rouge">ON DELETE</code> followed by the action to be taken.
    <ul>
      <li data-marker="*"><code class="language-plaintext highlighter-rouge">ON DELETE RESTRICT</code>: This restricts us from deleting IDs when the foreign key constraint is violated.</li>
      <li data-marker="*"><code class="language-plaintext highlighter-rouge">ON DELETE NO ACTION</code>: This allows the deletion of IDs that are referenced by a foreign key and nothing happens.</li>
      <li data-marker="*"><code class="language-plaintext highlighter-rouge">ON DELETE SET NULL</code>: This allows the deletion of IDs that are referenced by a foreign key and sets the foreign key references to <code class="language-plaintext highlighter-rouge">NULL</code>.</li>
      <li data-marker="*"><code class="language-plaintext highlighter-rouge">ON DELETE SET DEFAULT</code>: This does the same as the previous, but allows us to set a default value instead of <code class="language-plaintext highlighter-rouge">NULL</code>.</li>
      <li data-marker="*"><code class="language-plaintext highlighter-rouge">ON DELETE CASCADE</code>: This allows the deletion of IDs that are referenced by a foreign key and also proceeds to cascadingly delete the referencing foreign key rows. For example, if we used this to delete an artist ID, all the artist’s affiliations with the artwork would also be deleted from the <code class="language-plaintext highlighter-rouge">created</code> table.</li>
    </ul>
  </li>
  <li data-marker="*">
    <p>The latest version of the schema file implements the above method. The foreign key constraints now look like</p>

    <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">FOREIGN</span> <span class="k">KEY</span><span class="p">(</span><span class="nv">"artist_id"</span><span class="p">)</span> <span class="k">REFERENCES</span> <span class="nv">"artists"</span><span class="p">(</span><span class="nv">"id"</span><span class="p">)</span> <span class="k">ON</span> <span class="k">DELETE</span> <span class="k">CASCADE</span>
<span class="k">FOREIGN</span> <span class="k">KEY</span><span class="p">(</span><span class="nv">"collection_id"</span><span class="p">)</span> <span class="k">REFERENCES</span> <span class="nv">"collections"</span><span class="p">(</span><span class="nv">"id"</span><span class="p">)</span> <span class="k">ON</span> <span class="k">DELETE</span> <span class="k">CASCADE</span>
</code></pre></div>    </div>

    <p>Now running the following <code class="language-plaintext highlighter-rouge">DELETE</code> statement will not result in an error, and will cascade the deletion from the <code class="language-plaintext highlighter-rouge">artists</code> table to the <code class="language-plaintext highlighter-rouge">created</code> table:</p>

    <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">DELETE</span> <span class="k">FROM</span> <span class="nv">"artists"</span>
<span class="k">WHERE</span> <span class="nv">"name"</span> <span class="o">=</span> <span class="s1">'Unidentified artist'</span><span class="p">;</span>
</code></pre></div>    </div>

    <p>To check that this cascading deletion worked, we can query the <code class="language-plaintext highlighter-rouge">created</code> table:</p>

    <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="nv">"created"</span><span class="p">;</span>
</code></pre></div>    </div>

    <p>We observe that none of the rows have an ID of 3 (the ID of the artist deleted from the <code class="language-plaintext highlighter-rouge">artists</code> table).</p>
  </li>
</ul>

<h3 id="questions-2">Questions</h3>

<blockquote>
  <p>We just deleted an artist with the ID of 3. Is there any way to make the next inserted row have an ID of 3?</p>
</blockquote>

<ul>
  <li data-marker="*">By default, as we discussed before, SQLite will select the largest ID present in the table and increment it to obtain the next ID. But we can use the <code class="language-plaintext highlighter-rouge">AUTOINCREMENT</code> keyword while creating a column to indicate that any deleted ID should be repurposed for a new row being inserted into the table.</li>
</ul>

<h2 id="updating-data">Updating Data</h2>

<ul>
  <li data-marker="*">We can easily imagine scenarios in which data in a database would need to be updated. Perhaps, in the case of the MFA database, we find out that the painting “Farmers working at dawn” originally mapped to an “Unidentified artist” was actually created by the artist Li Yin.</li>
  <li data-marker="*">
    <p>We can use the update command to make changes to say, the affiliation of a painting. Here is the syntax of the update command.</p>

    <p class="w-50"><img src="../Images/f4d431ce171f05cc1c883af7cf6854a7.png" alt="&quot;Update command syntax&quot;" data-original-src="https://cs50.harvard.edu/sql/notes/3/images/49.jpg"/></p>
  </li>
  <li data-marker="*">
    <p>Let’s change this affiliation for “Farmers working at dawn” in the <code class="language-plaintext highlighter-rouge">created</code> table using the above syntax.</p>

    <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">UPDATE</span> <span class="nv">"created"</span>
<span class="k">SET</span> <span class="nv">"artist_id"</span> <span class="o">=</span> <span class="p">(</span>
    <span class="k">SELECT</span> <span class="nv">"id"</span>
    <span class="k">FROM</span> <span class="nv">"artists"</span>
    <span class="k">WHERE</span> <span class="nv">"name"</span> <span class="o">=</span> <span class="s1">'Li Yin'</span>
<span class="p">)</span>
<span class="k">WHERE</span> <span class="nv">"collection_id"</span> <span class="o">=</span> <span class="p">(</span>
    <span class="k">SELECT</span> <span class="nv">"id"</span>
    <span class="k">FROM</span> <span class="nv">"collections"</span>
    <span class="k">WHERE</span> <span class="nv">"title"</span> <span class="o">=</span> <span class="s1">'Farmers working at dawn'</span>
<span class="p">);</span>
</code></pre></div>    </div>

    <p>The first part of this query specifies the table to be updated. The next part retrieves the ID of Li Yin to set as the new ID. The last part selects the row(s) in <code class="language-plaintext highlighter-rouge">created</code> which will be updated with the ID of Li Yin, which is the painting “Farmers working at dawn”!</p>
  </li>
</ul>

<h2 id="triggers">Triggers</h2>

<ul>
  <li data-marker="*">A <strong>trigger</strong> is a SQL statement that runs automatically in response to another SQL statement, such as an <code class="language-plaintext highlighter-rouge">INSERT</code>, <code class="language-plaintext highlighter-rouge">UPDATE</code>, or <code class="language-plaintext highlighter-rouge">DELETE</code>.</li>
  <li data-marker="*">Triggers are useful for maintaining data consistency and automating tasks across related tables.</li>
</ul>

<h3 id="creating-a-sell-trigger">Creating a “Sell” Trigger</h3>

<ul>
  <li data-marker="*">
    <p>Consider the MFA database with a <code class="language-plaintext highlighter-rouge">collections</code> table and a new <code class="language-plaintext highlighter-rouge">transactions</code> table.</p>

    <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="nv">"transactions"</span> <span class="p">(</span>
    <span class="nv">"id"</span> <span class="nb">INTEGER</span><span class="p">,</span>
    <span class="nv">"title"</span> <span class="nb">TEXT</span><span class="p">,</span>
    <span class="nv">"action"</span> <span class="nb">TEXT</span><span class="p">,</span>
    <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">(</span><span class="nv">"id"</span><span class="p">)</span>
<span class="p">);</span>
</code></pre></div>    </div>
  </li>
  <li data-marker="*">
    <p>When artwork is sold (deleted from <code class="language-plaintext highlighter-rouge">collections</code>), we want it automatically logged in <code class="language-plaintext highlighter-rouge">transactions</code> with an action of “sold”.</p>

    <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">TRIGGER</span> <span class="nv">"sell"</span> 
<span class="k">BEFORE</span> <span class="k">DELETE</span> <span class="k">ON</span> <span class="nv">"collections"</span>
<span class="k">BEGIN</span>
    <span class="k">INSERT</span> <span class="k">INTO</span> <span class="nv">"transactions"</span> <span class="p">(</span><span class="nv">"title"</span><span class="p">,</span> <span class="nv">"action"</span><span class="p">)</span>
    <span class="k">VALUES</span> <span class="p">(</span><span class="k">OLD</span><span class="p">.</span><span class="nv">"title"</span><span class="p">,</span> <span class="s1">'sold'</span><span class="p">);</span>
<span class="k">END</span><span class="p">;</span>
</code></pre></div>    </div>
  </li>
  <li data-marker="*">This trigger runs before a row is deleted from <code class="language-plaintext highlighter-rouge">collections</code>.</li>
  <li data-marker="*"><strong>OLD</strong> is a special keyword that refers to the row being deleted.</li>
  <li data-marker="*"><code class="language-plaintext highlighter-rouge">OLD."title"</code> accesses the title column of the row about to be deleted.</li>
  <li data-marker="*">The trigger automatically inserts a record into <code class="language-plaintext highlighter-rouge">transactions</code> with the action “sold”.</li>
</ul>

<h3 id="creating-a-buy-trigger">Creating a “Buy” Trigger</h3>

<ul>
  <li data-marker="*">
    <p>When artwork is bought (inserted into <code class="language-plaintext highlighter-rouge">collections</code>), we want it logged in <code class="language-plaintext highlighter-rouge">transactions</code> with an action of “bought”.</p>

    <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">TRIGGER</span> <span class="nv">"buy"</span> 
<span class="k">AFTER</span> <span class="k">INSERT</span> <span class="k">ON</span> <span class="nv">"collections"</span>
<span class="k">BEGIN</span>
    <span class="k">INSERT</span> <span class="k">INTO</span> <span class="nv">"transactions"</span> <span class="p">(</span><span class="nv">"title"</span><span class="p">,</span> <span class="nv">"action"</span><span class="p">)</span>
    <span class="k">VALUES</span> <span class="p">(</span><span class="k">NEW</span><span class="p">.</span><span class="nv">"title"</span><span class="p">,</span> <span class="s1">'bought'</span><span class="p">);</span>
<span class="k">END</span><span class="p">;</span>
</code></pre></div>    </div>
  </li>
  <li data-marker="*">This trigger runs after a new row is inserted into <code class="language-plaintext highlighter-rouge">collections</code>.</li>
  <li data-marker="*"><strong>NEW</strong> is a special keyword that refers to the row being inserted.</li>
  <li data-marker="*"><code class="language-plaintext highlighter-rouge">NEW."title"</code> accesses the title column of the newly inserted row.</li>
</ul>

<h3 id="questions-3">Questions</h3>

<blockquote>
  <p>Can we have multiple SQL statements inside a trigger?</p>
</blockquote>

<ul>
  <li data-marker="*">Yes, you can have multiple statements inside the <code class="language-plaintext highlighter-rouge">BEGIN</code> and <code class="language-plaintext highlighter-rouge">END</code> blocks, separated by semicolons.</li>
</ul>

<h2 id="soft-deletions">Soft Deletions</h2>

<ul>
  <li data-marker="*"><strong>Soft deletion</strong> (or a <strong>soft delete</strong>) means marking data as deleted rather than actually removing it from the database.</li>
  <li data-marker="*">
    <p>For example, we could add a <code class="language-plaintext highlighter-rouge">deleted</code> column to the <code class="language-plaintext highlighter-rouge">collections</code> table with a default value of 0:</p>

    <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="nv">"collections"</span>
<span class="k">ADD</span> <span class="k">COLUMN</span> <span class="nv">"deleted"</span> <span class="nb">INTEGER</span> <span class="k">DEFAULT</span> <span class="mi">0</span><span class="p">;</span>
</code></pre></div>    </div>
  </li>
  <li data-marker="*">
    <p>To “delete” a row, we would update the <code class="language-plaintext highlighter-rouge">deleted</code> column to 1:</p>

    <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">UPDATE</span> <span class="nv">"collections"</span>
<span class="k">SET</span> <span class="nv">"deleted"</span> <span class="o">=</span> <span class="mi">1</span>
<span class="k">WHERE</span> <span class="nv">"title"</span> <span class="o">=</span> <span class="s1">'Farmers working at dawn'</span><span class="p">;</span>
</code></pre></div>    </div>
  </li>
  <li data-marker="*">
    <p>Then, to query only non-deleted rows:</p>

    <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="nv">"collections"</span>
<span class="k">WHERE</span> <span class="nv">"deleted"</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">;</span>
</code></pre></div>    </div>
  </li>
  <li data-marker="*">This way, data can be recovered if needed and maintains a complete historical record.</li>
  <li data-marker="*">However, it’s still important to comply with data privacy regulations that require data to be truly deleted.</li>
</ul>

<h2 id="fin">Fin</h2>

<ul>
  <li data-marker="*">This brings us to the conclusion of Lecture 3 about Writing in SQL!</li>
</ul>


                    
</body>
</html>