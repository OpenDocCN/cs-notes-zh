# CS110 è¯¾ç¨‹ç¬”è®° P6ï¼šexecvp, pipe, dup2, signals ğŸš€

åœ¨æœ¬èŠ‚è¯¾ä¸­ï¼Œæˆ‘ä»¬å°†è¦å­¦ä¹ å¤šè¿›ç¨‹ç¼–ç¨‹ä¸­çš„å‡ ä¸ªæ ¸å¿ƒæ¦‚å¿µï¼šå¦‚ä½•ä½¿ç”¨ `execvp` è¿è¡Œæ–°ç¨‹åºï¼Œå¦‚ä½•é€šè¿‡ `pipe` å’Œ `dup2` åœ¨è¿›ç¨‹é—´å»ºç«‹é€šä¿¡ç®¡é“ï¼Œä»¥åŠå¦‚ä½•åˆ©ç”¨ `signals` å¤„ç†è¿›ç¨‹é—´çš„äº‹ä»¶é€šçŸ¥ã€‚è¿™äº›æ˜¯æ„å»ºæ›´å¤æ‚ç¨‹åºï¼ˆå¦‚ä½ è‡ªå·±çš„shellï¼‰çš„åŸºç¡€ã€‚

## æ¦‚è¿°ï¼šå¤šè¿›ç¨‹ä¸è¿›ç¨‹é—´é€šä¿¡

ä¸Šä¸€èŠ‚æˆ‘ä»¬ä»‹ç»äº† `fork` ç³»ç»Ÿè°ƒç”¨ï¼Œå®ƒå…è®¸æˆ‘ä»¬åˆ›å»ºæ–°çš„è¿›ç¨‹ã€‚æœ¬èŠ‚ä¸­æˆ‘ä»¬æ¥çœ‹çœ‹å¦‚ä½•è®©æ–°è¿›ç¨‹æ‰§è¡Œä¸åŒçš„ç¨‹åºï¼Œä»¥åŠå¦‚ä½•è®©çˆ¶å­è¿›ç¨‹ä¹‹é—´è¿›è¡Œæ•°æ®äº¤æ¢å’Œäº‹ä»¶é€šçŸ¥ã€‚

![](img/e8c16a216dab678dec1c79e51f021b08_1.png)

![](img/e8c16a216dab678dec1c79e51f021b08_3.png)

æˆ‘ä»¬å°†é€šè¿‡æ„å»ºä¸€ä¸ªç®€å•çš„ `shell` ç¨‹åºæ¥ä¸²è”è¿™äº›æ¦‚å¿µï¼Œå®ƒèƒ½è¿è¡Œå‘½ä»¤ã€å¤„ç†åå°è¿›ç¨‹ï¼Œå¹¶ç®¡ç†è¿›ç¨‹é—´çš„è¾“å…¥è¾“å‡ºã€‚

![](img/e8c16a216dab678dec1c79e51f021b08_5.png)

![](img/e8c16a216dab678dec1c79e51f021b08_7.png)

![](img/e8c16a216dab678dec1c79e51f021b08_9.png)

![](img/e8c16a216dab678dec1c79e51f021b08_11.png)

---

![](img/e8c16a216dab678dec1c79e51f021b08_12.png)

![](img/e8c16a216dab678dec1c79e51f021b08_14.png)

## 1. ä½¿ç”¨ execvp è¿è¡Œæ–°ç¨‹åº ğŸ”„

![](img/e8c16a216dab678dec1c79e51f021b08_16.png)

![](img/e8c16a216dab678dec1c79e51f021b08_18.png)

![](img/e8c16a216dab678dec1c79e51f021b08_20.png)

![](img/e8c16a216dab678dec1c79e51f021b08_22.png)

`execvp` æ˜¯ `exec` å‡½æ•°å®¶æ—çš„ä¸€å‘˜ï¼Œå®ƒçš„ä½œç”¨æ˜¯**ç”¨å¦ä¸€ä¸ªç¨‹åºæ›¿æ¢å½“å‰è¿›ç¨‹çš„å†…å­˜æ˜ åƒ**ã€‚è¿™æ„å‘³ç€è°ƒç”¨ `execvp` åï¼ŒåŸè¿›ç¨‹çš„ä»£ç å°±ä¸å†è¿è¡Œï¼Œè½¬è€Œæ‰§è¡Œæ–°çš„ç¨‹åºã€‚

![](img/e8c16a216dab678dec1c79e51f021b08_24.png)

![](img/e8c16a216dab678dec1c79e51f021b08_26.png)

![](img/e8c16a216dab678dec1c79e51f021b08_28.png)

**æ ¸å¿ƒå…¬å¼**ï¼š
```c
int execvp(const char *file, char *const argv[]);
```
*   `file`: è¦æ‰§è¡Œçš„ç¨‹åºåã€‚
*   `argv`: ä¼ é€’ç»™æ–°ç¨‹åºçš„å‚æ•°åˆ—è¡¨ï¼ˆç±»ä¼¼äº `main` å‡½æ•°çš„ `argv`ï¼‰ï¼Œå¿…é¡»ä»¥ `NULL` æŒ‡é’ˆç»“æŸã€‚

![](img/e8c16a216dab678dec1c79e51f021b08_30.png)

é€šå¸¸ï¼Œæˆ‘ä»¬ä¸ä¼šç›´æ¥åœ¨çˆ¶è¿›ç¨‹ä¸­è°ƒç”¨ `execvp`ï¼Œå› ä¸ºè¿™ä¼šç»ˆæ­¢çˆ¶è¿›ç¨‹ã€‚æ›´å¸¸è§çš„æ¨¡å¼æ˜¯ï¼š
1.  çˆ¶è¿›ç¨‹è°ƒç”¨ `fork()` åˆ›å»ºå­è¿›ç¨‹ã€‚
2.  åœ¨å­è¿›ç¨‹ä¸­è°ƒç”¨ `execvp()` æ¥è¿è¡Œæ–°ç¨‹åºã€‚
3.  çˆ¶è¿›ç¨‹ç»§ç»­æ‰§è¡ŒåŸæœ‰é€»è¾‘ã€‚

![](img/e8c16a216dab678dec1c79e51f021b08_32.png)

ä»¥ä¸‹æ˜¯ä¸€ä¸ªç®€å•ç¤ºä¾‹ `mysystem` å‡½æ•°ï¼Œå®ƒæ¨¡æ‹Ÿäº†ç³»ç»Ÿè°ƒç”¨ `system()` çš„éƒ¨åˆ†åŠŸèƒ½ï¼š

![](img/e8c16a216dab678dec1c79e51f021b08_34.png)

![](img/e8c16a216dab678dec1c79e51f021b08_36.png)

![](img/e8c16a216dab678dec1c79e51f021b08_38.png)

```c
pid_t pid = fork();
if (pid == 0) {
    // å­è¿›ç¨‹ï¼šè¿è¡Œ /bin/sh æ¥è§£é‡Šæ‰§è¡Œå‘½ä»¤
    char *args[] = {"/bin/sh", "-c", command, NULL};
    execvp(args[0], args);
    // å¦‚æœ execvp æˆåŠŸï¼Œä¸ä¼šæ‰§è¡Œåˆ°è¿™é‡Œ
    exit(1);
} else {
    // çˆ¶è¿›ç¨‹ï¼šç­‰å¾…å­è¿›ç¨‹ç»“æŸ
    waitpid(pid, &status, 0);
}
```

åœ¨è¿™ä¸ªæ¨¡å¼ä¸­ï¼Œå­è¿›ç¨‹è¢« `/bin/sh`ï¼ˆå³shellç¨‹åºï¼‰â€œåå™¬â€ï¼Œå¹¶ç”±å®ƒæ¥æ‰§è¡Œç”¨æˆ·è¾“å…¥çš„å‘½ä»¤ï¼ˆå¦‚ `ls`ï¼‰ã€‚

![](img/e8c16a216dab678dec1c79e51f021b08_40.png)

![](img/e8c16a216dab678dec1c79e51f021b08_42.png)

---

![](img/e8c16a216dab678dec1c79e51f021b08_44.png)

![](img/e8c16a216dab678dec1c79e51f021b08_46.png)

![](img/e8c16a216dab678dec1c79e51f021b08_48.png)

![](img/e8c16a216dab678dec1c79e51f021b08_49.png)

![](img/e8c16a216dab678dec1c79e51f021b08_51.png)

## 2. å®ç°ä¸€ä¸ªç®€å•çš„åå° Shell ğŸš

![](img/e8c16a216dab678dec1c79e51f021b08_53.png)

![](img/e8c16a216dab678dec1c79e51f021b08_55.png)

åŸºäº `fork` å’Œ `execvp`ï¼Œæˆ‘ä»¬å¯ä»¥æ„å»ºä¸€ä¸ªèƒ½å¤„ç†å‰å°å’Œåå°å‘½ä»¤çš„ç®€æ˜“shellã€‚

![](img/e8c16a216dab678dec1c79e51f021b08_57.png)

![](img/e8c16a216dab678dec1c79e51f021b08_59.png)

**æ ¸å¿ƒé€»è¾‘**ï¼š
*   è¯»å–ç”¨æˆ·è¾“å…¥çš„å‘½ä»¤ã€‚
*   å¦‚æœå‘½ä»¤ä»¥ `&` ç»“å°¾ï¼Œåˆ™æ ‡è®°ä¸º**åå°è¿è¡Œ**ã€‚
*   `fork` å‡ºå­è¿›ç¨‹ï¼Œåœ¨å­è¿›ç¨‹ä¸­ç”¨ `execvp` æ‰§è¡Œå‘½ä»¤ã€‚
*   åœ¨çˆ¶è¿›ç¨‹ä¸­ï¼š
    *   å¦‚æœæ˜¯**å‰å°å‘½ä»¤**ï¼Œåˆ™è°ƒç”¨ `waitpid` ç­‰å¾…å­è¿›ç¨‹ç»“æŸï¼Œå†æ˜¾ç¤ºä¸‹ä¸€ä¸ªæç¤ºç¬¦ã€‚
    *   å¦‚æœæ˜¯**åå°å‘½ä»¤**ï¼Œåˆ™**ä¸ç­‰å¾…**ï¼Œç›´æ¥æ˜¾ç¤ºä¸‹ä¸€ä¸ªæç¤ºç¬¦ï¼Œè®©å­è¿›ç¨‹åœ¨åå°ç‹¬ç«‹è¿è¡Œã€‚

![](img/e8c16a216dab678dec1c79e51f021b08_61.png)

ä»¥ä¸‹æ˜¯å…³é”®ä»£ç ç‰‡æ®µï¼š

![](img/e8c16a216dab678dec1c79e51f021b08_63.png)

```c
// è§£æå‘½ä»¤ï¼Œåˆ¤æ–­æ˜¯å¦ä»¥ '&' ç»“å°¾
int run_in_background = is_background_command(args);

pid_t pid = fork();
if (pid == 0) {
    // å­è¿›ç¨‹æ‰§è¡Œå‘½ä»¤
    execvp(args[0], args);
    exit(1); // execvp å¤±è´¥æ—¶æ‰æ‰§è¡Œ
} else if (pid > 0) {
    // çˆ¶è¿›ç¨‹
    if (!run_in_background) {
        // å‰å°è¿è¡Œï¼šç­‰å¾…å­è¿›ç¨‹
        waitpid(pid, &status, 0);
    } else {
        // åå°è¿è¡Œï¼šæ‰“å°è¿›ç¨‹IDåç«‹å³è¿”å›
        printf("[%d] %s\n", pid, command);
    }
}
```
è¿™æ ·ï¼Œå½“ç”¨æˆ·è¾“å…¥ `sleep 10 &` æ—¶ï¼Œshellä¼šç«‹åˆ»è¿”å›æç¤ºç¬¦ï¼Œè€Œ `sleep` å‘½ä»¤åˆ™åœ¨åå°ç»§ç»­æ‰§è¡Œã€‚

---

## 3. ä½¿ç”¨ pipe å»ºç«‹è¿›ç¨‹é—´é€šä¿¡ç®¡é“ ğŸš°

![](img/e8c16a216dab678dec1c79e51f021b08_65.png)

![](img/e8c16a216dab678dec1c79e51f021b08_67.png)

![](img/e8c16a216dab678dec1c79e51f021b08_69.png)

`pipe` ç³»ç»Ÿè°ƒç”¨åˆ›å»ºäº†ä¸€ä¸ª**å•å‘é€šä¿¡é€šé“**ï¼Œç”¨äºä¸¤ä¸ªè¿›ç¨‹ï¼ˆé€šå¸¸æ˜¯çˆ¶å­è¿›ç¨‹ï¼‰é—´ä¼ é€’æ•°æ®ã€‚å®ƒè¿”å›ä¸¤ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼ˆfile descriptorï¼‰ï¼šä¸€ä¸ªç”¨äºè¯»å–ï¼Œä¸€ä¸ªç”¨äºå†™å…¥ã€‚

![](img/e8c16a216dab678dec1c79e51f021b08_71.png)

![](img/e8c16a216dab678dec1c79e51f021b08_73.png)

**æ ¸å¿ƒå…¬å¼**ï¼š
```c
int pipe(int fds[2]);
```
è°ƒç”¨æˆåŠŸåï¼š
*   `fds[0]` æˆä¸ºç®¡é“çš„**è¯»å–ç«¯**ã€‚
*   `fds[1]` æˆä¸ºç®¡é“çš„**å†™å…¥ç«¯**ã€‚
*   å†™å…¥ `fds[1]` çš„æ•°æ®å¯ä»¥ä» `fds[0]` è¯»å–ã€‚

![](img/e8c16a216dab678dec1c79e51f021b08_75.png)

**é‡è¦ç‰¹æ€§**ï¼šè°ƒç”¨ `fork` åï¼Œå­è¿›ç¨‹ä¼šç»§æ‰¿çˆ¶è¿›ç¨‹æ‰“å¼€çš„æ–‡ä»¶æè¿°ç¬¦ã€‚å› æ­¤ï¼Œçˆ¶å­è¿›ç¨‹å¯ä»¥é€šè¿‡åŒä¸€ä¸ªç®¡é“è¿›è¡Œé€šä¿¡ã€‚é€šå¸¸çš„ç”¨æ³•æ˜¯ï¼š
*   çˆ¶è¿›ç¨‹å…³é—­è¯»å–ç«¯ (`fds[0]`)ï¼Œåªä¿ç•™å†™å…¥ç«¯ï¼Œå‘ç®¡é“å†™æ•°æ®ã€‚
*   å­è¿›ç¨‹å…³é—­å†™å…¥ç«¯ (`fds[1]`)ï¼Œåªä¿ç•™è¯»å–ç«¯ï¼Œä»ç®¡é“è¯»æ•°æ®ã€‚

![](img/e8c16a216dab678dec1c79e51f021b08_77.png)

ä»¥ä¸‹æ˜¯ä¸€ä¸ªç®€å•çš„ç®¡é“ç¤ºä¾‹ï¼Œçˆ¶è¿›ç¨‹å‘å­è¿›ç¨‹å‘é€å­—ç¬¦ä¸²ï¼š

```c
int fds[2];
pipe(fds); // åˆ›å»ºç®¡é“

![](img/e8c16a216dab678dec1c79e51f021b08_79.png)

pid_t pid = fork();
if (pid == 0) {
    // å­è¿›ç¨‹ï¼šå…³é—­å†™å…¥ç«¯ï¼Œå‡†å¤‡è¯»å–
    close(fds[1]);
    char buffer[128];
    read(fds[0], buffer, sizeof(buffer));
    printf("Child read: %s\n", buffer);
    close(fds[0]);
    exit(0);
} else {
    // çˆ¶è¿›ç¨‹ï¼šå…³é—­è¯»å–ç«¯ï¼Œå‡†å¤‡å†™å…¥
    close(fds[0]);
    write(fds[1], "Hello from parent", 18);
    close(fds[1]); // å…³é—­å†™å…¥ç«¯è¡¨ç¤ºæ•°æ®å‘é€å®Œæ¯•
    waitpid(pid, NULL, 0); // ç­‰å¾…å­è¿›ç¨‹
}
```
**æ³¨æ„**ï¼š`read` è°ƒç”¨ä¼š**é˜»å¡**ï¼Œç›´åˆ°æœ‰æ•°æ®å¯è¯»æˆ–ç®¡é“å†™å…¥ç«¯å…¨éƒ¨å…³é—­ã€‚çˆ¶è¿›ç¨‹å…³é—­å†™å…¥ç«¯ (`fds[1]`) æ˜¯é€šçŸ¥å­è¿›ç¨‹â€œæ•°æ®å·²å‘é€å®Œâ€çš„å…³é”®ã€‚

![](img/e8c16a216dab678dec1c79e51f021b08_81.png)

![](img/e8c16a216dab678dec1c79e51f021b08_83.png)

---

## 4. ä½¿ç”¨ dup2 é‡å®šå‘æ ‡å‡†è¾“å…¥è¾“å‡º ğŸ”€

![](img/e8c16a216dab678dec1c79e51f021b08_85.png)

`dup2` ç³»ç»Ÿè°ƒç”¨ç”¨äº**å¤åˆ¶ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦**ã€‚æœ€å¸¸è§çš„ç”¨é€”æ˜¯é‡å®šå‘è¿›ç¨‹çš„æ ‡å‡†è¾“å…¥ï¼ˆ`STDIN_FILENO`, 0ï¼‰ã€æ ‡å‡†è¾“å‡ºï¼ˆ`STDOUT_FILENO`, 1ï¼‰æˆ–æ ‡å‡†é”™è¯¯ï¼ˆ`STDERR_FILENO`, 2ï¼‰ã€‚

![](img/e8c16a216dab678dec1c79e51f021b08_87.png)

**æ ¸å¿ƒå…¬å¼**ï¼š
```c
int dup2(int oldfd, int newfd);
```
å®ƒä½¿ `newfd` æˆä¸º `oldfd` çš„å‰¯æœ¬ã€‚å¦‚æœ `newfd` å·²ç»æ‰“å¼€ï¼Œä¼šå…ˆå°†å…¶å…³é—­ã€‚

![](img/e8c16a216dab678dec1c79e51f021b08_89.png)

![](img/e8c16a216dab678dec1c79e51f021b08_91.png)

åœ¨ç®¡é“é€šä¿¡ä¸­ï¼Œæˆ‘ä»¬å¸¸ç”¨ `dup2` å°†å­è¿›ç¨‹çš„æ ‡å‡†è¾“å…¥é‡å®šå‘åˆ°ç®¡é“çš„è¯»å–ç«¯ã€‚è¿™æ ·ï¼Œå­è¿›ç¨‹åœ¨æ‰§è¡Œæ—¶ï¼ˆä¾‹å¦‚è¿è¡Œ `sort` å‘½ä»¤ï¼‰ï¼Œå°±ä¼šä»ç®¡é“è¯»å–æ•°æ®ï¼Œè€Œä¸æ˜¯ä»é”®ç›˜è¾“å…¥ã€‚

![](img/e8c16a216dab678dec1c79e51f021b08_93.png)

ä»¥ä¸‹æ˜¯å°†ç®¡é“è¯»å–ç«¯é‡å®šå‘ä¸ºæ ‡å‡†è¾“å…¥çš„å…¸å‹ç”¨æ³•ï¼š

![](img/e8c16a216dab678dec1c79e51f021b08_95.png)

```c
// å‡è®¾åœ¨å­è¿›ç¨‹ä¸­ï¼Œfds[0]æ˜¯ç®¡é“çš„è¯»å–ç«¯
close(fds[1]); // å­è¿›ç¨‹ä¸éœ€è¦å†™å…¥ç«¯
dup2(fds[0], STDIN_FILENO); // å°†æ ‡å‡†è¾“å…¥é‡å®šå‘åˆ°ç®¡é“è¯»å–ç«¯
close(fds[0]); // é‡å®šå‘åï¼ŒåŸå§‹çš„fds[0]å¯ä»¥å…³é—­äº†

// ç°åœ¨æ‰§è¡Œç¨‹åºï¼Œä¾‹å¦‚ sortï¼Œå®ƒä¼šä»ç®¡é“è¯»å–è¾“å…¥
execlp("sort", "sort", NULL);
```

---

![](img/e8c16a216dab678dec1c79e51f021b08_97.png)

## 5. ç»¼åˆç¤ºä¾‹ï¼šåˆ›å»ºå­è¿›ç¨‹å¹¶ä¼ é€’æ•°æ® ğŸ§©

![](img/e8c16a216dab678dec1c79e51f021b08_99.png)

![](img/e8c16a216dab678dec1c79e51f021b08_101.png)

![](img/e8c16a216dab678dec1c79e51f021b08_103.png)

ç»“åˆ `pipe`ã€`fork`ã€`dup2` å’Œ `execvp`ï¼Œæˆ‘ä»¬å¯ä»¥ç¼–å†™ä¸€ä¸ª `subprocess` å‡½æ•°ã€‚è¯¥å‡½æ•°å¯åŠ¨ä¸€ä¸ªå­è¿›ç¨‹ï¼ˆå¦‚ `sort`ï¼‰ï¼Œå¹¶è¿”å›ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ç»™çˆ¶è¿›ç¨‹ã€‚çˆ¶è¿›ç¨‹å‘è¿™ä¸ªæ–‡ä»¶æè¿°ç¬¦å†™å…¥æ•°æ®ï¼Œæ•°æ®å°±ä¼šæˆä¸ºå­è¿›ç¨‹çš„è¾“å…¥ã€‚

ä»¥ä¸‹æ˜¯ `subprocess` å‡½æ•°çš„ç®€åŒ–æ¡†æ¶å’Œ `main` å‡½æ•°ä¸­çš„ç”¨æ³•ï¼š

```c
// subprocess_t ç»“æ„ä½“ï¼Œç”¨äºè¿”å›å­è¿›ç¨‹ä¿¡æ¯
typedef struct {
    pid_t pid;   // å­è¿›ç¨‹ID
    int supply_fd; // çˆ¶è¿›ç¨‹å†™å…¥æ­¤fdï¼Œæ•°æ®ä¼šä¾›ç»™å­è¿›ç¨‹
} subprocess_t;

subprocess_t subprocess(char *command) {
    int fds[2];
    pipe(fds);
    pid_t pid = fork();

    if (pid == 0) {
        // å­è¿›ç¨‹
        close(fds[1]); // å…³é—­å†™å…¥ç«¯
        dup2(fds[0], STDIN_FILENO); // é‡å®šå‘æ ‡å‡†è¾“å…¥åˆ°ç®¡é“
        close(fds[0]);
        // æ‰§è¡Œå‘½ä»¤
        execlp("/bin/sh", "sh", "-c", command, NULL);
        exit(1);
    } else {
        // çˆ¶è¿›ç¨‹
        close(fds[0]); // å…³é—­è¯»å–ç«¯
        subprocess_t sp = {pid, fds[1]};
        return sp;
    }
}

![](img/e8c16a216dab678dec1c79e51f021b08_105.png)

![](img/e8c16a216dab678dec1c79e51f021b08_107.png)

// åœ¨ main å‡½æ•°ä¸­ä½¿ç”¨
int main() {
    // å¯åŠ¨ sort å‘½ä»¤ä½œä¸ºå­è¿›ç¨‹
    subprocess_t sp = subprocess("/usr/bin/sort");

    // çˆ¶è¿›ç¨‹å‘å­è¿›ç¨‹ä¾›ç»™æ•°æ®
    char *words[] = {"banana", "apple", "cherry"};
    for (int i = 0; i < 3; i++) {
        dprintf(sp.supply_fd, "%s\n", words[i]);
    }
    close(sp.supply_fd); // å…³é—­ä¾›ç»™ç«¯ï¼Œå‘ŠçŸ¥å­è¿›ç¨‹è¾“å…¥ç»“æŸ

    waitpid(sp.pid, &status, 0); // ç­‰å¾…å­è¿›ç¨‹ç»“æŸ
    return 0;
}
```
è¿è¡Œæ­¤ç¨‹åºï¼Œ`sort` å­è¿›ç¨‹ä¼šæ”¶åˆ°å•è¯åˆ—è¡¨ï¼Œæ’åºåè¾“å‡ºåˆ°ç»ˆç«¯ã€‚çˆ¶è¿›ç¨‹å…³é—­ `supply_fd` è‡³å…³é‡è¦ï¼Œå®ƒç›¸å½“äºåœ¨ç»ˆç«¯æŒ‰ä¸‹ `Ctrl+D`ï¼Œå‘Šè¯‰ `sort` è¾“å…¥å·²ç»“æŸï¼Œå¯ä»¥å¼€å§‹æ’åºäº†ã€‚

![](img/e8c16a216dab678dec1c79e51f021b08_109.png)

![](img/e8c16a216dab678dec1c79e51f021b08_111.png)

---

![](img/e8c16a216dab678dec1c79e51f021b08_113.png)

![](img/e8c16a216dab678dec1c79e51f021b08_115.png)

![](img/e8c16a216dab678dec1c79e51f021b08_117.png)

## 6. ä½¿ç”¨ signals å¤„ç†è¿›ç¨‹äº‹ä»¶ ğŸ“

![](img/e8c16a216dab678dec1c79e51f021b08_119.png)

ä¿¡å·ï¼ˆSignalï¼‰æ˜¯å†…æ ¸å‘è¿›ç¨‹å‘é€çš„**å¼‚æ­¥äº‹ä»¶é€šçŸ¥**ã€‚ä¾‹å¦‚ï¼ŒæŒ‰ä¸‹ `Ctrl+C`ï¼ˆå‘é€ `SIGINT`ï¼‰å¯ä»¥ç»ˆæ­¢å‰å°è¿›ç¨‹ï¼Œå­è¿›ç¨‹ç»“æŸæ—¶ä¼šå‘çˆ¶è¿›ç¨‹å‘é€ `SIGCHLD` ä¿¡å·ã€‚

![](img/e8c16a216dab678dec1c79e51f021b08_121.png)

![](img/e8c16a216dab678dec1c79e51f021b08_123.png)

æˆ‘ä»¬å¯ä»¥ä¸ºç‰¹å®šä¿¡å·æ³¨å†Œä¸€ä¸ª**ä¿¡å·å¤„ç†å‡½æ•°**ï¼ˆsignal handlerï¼‰ï¼Œå½“ä¿¡å·å‘ç”Ÿæ—¶ï¼Œè¯¥å‡½æ•°ä¼šè¢«è°ƒç”¨ã€‚

**æ ¸å¿ƒæ¦‚å¿µ**ï¼š
*   `SIGCHLD`ï¼šå­è¿›ç¨‹çŠ¶æ€æ”¹å˜ï¼ˆç»ˆæ­¢ã€åœæ­¢ã€ç»§ç»­ï¼‰æ—¶å‘é€ç»™çˆ¶è¿›ç¨‹ã€‚
*   `signal(int signum, void (*handler)(int))`ï¼šè®¾ç½®ä¿¡å·å¤„ç†å‡½æ•°ã€‚

ä¸€ä¸ªå¸¸è§çš„ç”¨é€”æ˜¯å¤„ç†åƒµå°¸è¿›ç¨‹ã€‚å¦‚æœçˆ¶è¿›ç¨‹ä¸è°ƒç”¨ `waitpid` å›æ”¶å·²ç»ˆæ­¢çš„å­è¿›ç¨‹ï¼Œå­è¿›ç¨‹ä¼šå˜æˆâ€œåƒµå°¸â€ã€‚é€šè¿‡æ•è· `SIGCHLD` ä¿¡å·å¹¶åœ¨å¤„ç†å‡½æ•°ä¸­è°ƒç”¨ `waitpid`ï¼Œå¯ä»¥åŠæ—¶æ¸…ç†å­è¿›ç¨‹ã€‚

ä»¥ä¸‹æ˜¯ä¸€ä¸ªâ€œè¿ªå£«å°¼ä¹å›­â€çš„ä¾‹å­ï¼Œæ¼”ç¤ºäº†çˆ¶è¿›ç¨‹åœ¨å­è¿›ç¨‹ï¼ˆå­©å­ä»¬ï¼‰ç©è€æ—¶å°ç¡ï¼Œå¹¶åœ¨å­©å­å›æ¥æ—¶è¢«å”¤é†’ï¼š

```c
#include <signal.h>
#include <unistd.h>
#include <sys/wait.h>

int children_done = 0;
void reap_child(int sig) {
    waitpid(-1, NULL, 0); // å›æ”¶ä»»æ„ä¸€ä¸ªå·²ç»ˆæ­¢çš„å­è¿›ç¨‹
    children_done++;
}

int main() {
    signal(SIGCHLD, reap_child); // è®¾ç½® SIGCHLD çš„å¤„ç†å‡½æ•°

    for (int i = 0; i < 5; i++) {
        if (fork() == 0) {
            // å­è¿›ç¨‹ï¼šæ¨¡æ‹Ÿç©è€æ—¶é—´
            sleep(3 * (i + 1));
            exit(0);
        }
    }

    // çˆ¶è¿›ç¨‹ï¼šç­‰å¾…æ‰€æœ‰å­©å­å›æ¥
    while (children_done < 5) {
        printf("At least one child is playing, dad naps.\n");
        sleep(5); // sleep ä¼šè¢«åˆ°æ¥çš„ SIGCHLD ä¿¡å·ä¸­æ–­
        printf("Dad wakes up!\n");
    }
    printf("All children back home. Let's leave!\n");
    return 0;
}
```
åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œ`sleep` ä¼šè¢« `SIGCHLD` ä¿¡å·ä¸­æ–­ï¼Œçˆ¶è¿›ç¨‹æ¯æ¬¡è¢«å”¤é†’å°±æ£€æŸ¥æ˜¯å¦æœ‰å­©å­å›æ¥ã€‚ä½¿ç”¨ä¿¡å·å¤„ç†ä½¿å¾—çˆ¶è¿›ç¨‹æ— éœ€ä¸»åŠ¨è½®è¯¢å­è¿›ç¨‹çŠ¶æ€ã€‚

![](img/e8c16a216dab678dec1c79e51f021b08_125.png)

![](img/e8c16a216dab678dec1c79e51f021b08_127.png)

**æ³¨æ„**ï¼šä¸€äº›ä¿¡å·ï¼ˆå¦‚ `SIGKILL`, `SIGSTOP`ï¼‰ä¸èƒ½è¢«æ•è·æˆ–å¿½ç•¥ã€‚åœ¨ä¿¡å·å¤„ç†å‡½æ•°ä¸­åº”å°½é‡åªåšç®€å•æ“ä½œï¼Œé¿å…ä½¿ç”¨ä¸å¯é‡å…¥å‡½æ•°ï¼ˆå¦‚ `printf`ï¼‰ï¼Œæœ¬ä¾‹ä»…ä¸ºæ¼”ç¤ºã€‚

![](img/e8c16a216dab678dec1c79e51f021b08_129.png)

![](img/e8c16a216dab678dec1c79e51f021b08_131.png)

---

![](img/e8c16a216dab678dec1c79e51f021b08_133.png)

![](img/e8c16a216dab678dec1c79e51f021b08_135.png)

![](img/e8c16a216dab678dec1c79e51f021b08_137.png)

## æ€»ç»“ ğŸ¯

![](img/e8c16a216dab678dec1c79e51f021b08_139.png)

![](img/e8c16a216dab678dec1c79e51f021b08_141.png)

æœ¬èŠ‚è¯¾ä¸­æˆ‘ä»¬ä¸€èµ·å­¦ä¹ äº†å¤šè¿›ç¨‹ç¼–ç¨‹çš„æ ¸å¿ƒå·¥å…·é“¾ï¼š

1.  **`execvp`**ï¼šç”¨äºåœ¨å­è¿›ç¨‹ä¸­åŠ è½½å¹¶æ‰§è¡Œå…¨æ–°çš„ç¨‹åºã€‚
2.  **Shell å®ç°**ï¼šç»“åˆ `fork` å’Œ `execvp`ï¼Œå¯ä»¥æ„å»ºæ”¯æŒå‰åå°ä»»åŠ¡ç®¡ç†çš„ç®€å•shellã€‚
3.  **`pipe`**ï¼šåˆ›å»ºå•å‘é€šä¿¡ç®¡é“ï¼Œæ˜¯è¿›ç¨‹é—´é€šä¿¡ï¼ˆIPCï¼‰çš„åŸºæœ¬æ–¹å¼ä¹‹ä¸€ã€‚
4.  **`dup2`**ï¼šé‡å®šå‘æ–‡ä»¶æè¿°ç¬¦ï¼Œå¸¸ç”¨äºå°†ç®¡é“çš„ä¸€ç«¯è¿æ¥åˆ°è¿›ç¨‹çš„æ ‡å‡†è¾“å…¥æˆ–è¾“å‡ºã€‚
5.  **ç»¼åˆåº”ç”¨**ï¼šé€šè¿‡ `subprocess` æ¨¡å¼ï¼Œå¯ä»¥çµæ´»åœ°å¯åŠ¨å­è¿›ç¨‹å¹¶æ§åˆ¶å…¶è¾“å…¥æºã€‚
6.  **`signals`**ï¼šå¤„ç†å¼‚æ­¥äº‹ä»¶ï¼Œå¦‚ä½¿ç”¨ `SIGCHLD` ä¿¡å·é«˜æ•ˆåœ°å›æ”¶å­è¿›ç¨‹èµ„æºã€‚

![](img/e8c16a216dab678dec1c79e51f021b08_143.png)

æŒæ¡è¿™äº›æ¦‚å¿µå’Œç³»ç»Ÿè°ƒç”¨ï¼Œä½ å°±æœ‰èƒ½åŠ›ç¼–å†™å‡ºåƒ `shell` ä¸€æ ·å¯ä»¥åˆ›å»ºã€ç®¡ç†ã€å¹¶ä¸å¤šä¸ªè¿›ç¨‹äº¤äº’çš„å¤æ‚ç¨‹åºã€‚åœ¨æ¥ä¸‹æ¥çš„ä½œä¸šä¸­ï¼Œä½ å°†æœ‰æœºä¼šå®è·µè¿™äº›çŸ¥è¯†ï¼Œæ„å»ºæ›´å¼ºå¤§çš„å·¥å…·ã€‚