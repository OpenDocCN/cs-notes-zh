# è¯¾ç¨‹ P11ï¼šç¬¬10è®² ä»Cçº¿ç¨‹åˆ°C++çº¿ç¨‹ ğŸ§µ

![](img/87f93b0bc9a9d8e944eb7fb7dd38f262_1.png)

![](img/87f93b0bc9a9d8e944eb7fb7dd38f262_2.png)

åœ¨æœ¬èŠ‚è¯¾ä¸­ï¼Œæˆ‘ä»¬å°†å­¦ä¹ å¦‚ä½•ä»Cè¯­è¨€çš„Pthreadsè¿‡æ¸¡åˆ°C++11å†…ç½®çš„çº¿ç¨‹åº“ã€‚æˆ‘ä»¬å°†æ¢è®¨C++çº¿ç¨‹çš„åŸºæœ¬ç”¨æ³•ã€å¦‚ä½•ä¼ é€’å‚æ•°ã€ä»¥åŠå¦‚ä½•å¤„ç†å¤šçº¿ç¨‹ç¼–ç¨‹ä¸­å¸¸è§çš„ç«äº‰æ¡ä»¶é—®é¢˜ã€‚

![](img/87f93b0bc9a9d8e944eb7fb7dd38f262_4.png)

---

## æœŸä¸­è€ƒè¯•å®‰æ’ ğŸ“

ä¸Šä¸€èŠ‚æˆ‘ä»¬ä»‹ç»äº†å¤šè¿›ç¨‹å’Œå¤šçº¿ç¨‹çš„åŸºæœ¬æ¦‚å¿µï¼Œæœ¬èŠ‚ä¸­æˆ‘ä»¬æ¥çœ‹çœ‹æœ¬å‘¨çš„é‡è¦å®‰æ’ã€‚

æœŸä¸­è€ƒè¯•å®šäºæœ¬å‘¨å››æ™šä¸Š6ç‚¹åˆ°8ç‚¹ï¼Œåœ°ç‚¹åœ¨Hewlett 200æ•™å®¤ã€‚è€ƒè¯•å°†ä½¿ç”¨Blue Bookç³»ç»Ÿè¿›è¡Œã€‚

ä»¥ä¸‹æ˜¯å…³äºè€ƒè¯•çš„é‡è¦ä¿¡æ¯åˆ—è¡¨ï¼š
*   è€ƒè¯•å½¢å¼ä¸ºåœ¨ç¬”è®°æœ¬ç”µè„‘ä¸Šä½¿ç”¨Blue Bookç¨‹åºç­”é¢˜å¹¶æäº¤ã€‚
*   è€ƒè¯•å†…å®¹åŠ å¯†ï¼Œå°†åœ¨è€ƒå‰å‘å¸ƒï¼Œè¿›å…¥è€ƒåœºåè·å¾—å¯†ç å³å¯å¼€å§‹ã€‚
*   è€ƒè¯•æ—¶é•¿ä¸ºä¸¤å°æ—¶ï¼Œä½†é¢„è®¡å¤šæ•°åŒå­¦å¯åœ¨ä¸€ä¸ªåŠå°æ—¶å†…å®Œæˆã€‚
*   å…è®¸æºå¸¦ä¸€å¼ æ­£åé¢å†™æœ‰ä¸ªäººç¬”è®°çš„çº¸å¼ è¿›å…¥è€ƒåœºã€‚
*   è€ƒè¯•æ—¶ä¼šæä¾›ä¸€ä»½æœ‰é™çš„å‚è€ƒèµ„æ–™ï¼ŒåŒ…å«å¸¸ç”¨å‡½æ•°åŸå‹å’Œå¸¸é‡ã€‚
*   å¦‚æœéœ€è¦ç‰¹æ®Šè€ƒè¯•å®‰æ’ï¼Œè¯·åŠ¡å¿…æå‰é€šè¿‡é‚®ä»¶è”ç³»è€å¸ˆã€‚

![](img/87f93b0bc9a9d8e944eb7fb7dd38f262_6.png)

![](img/87f93b0bc9a9d8e944eb7fb7dd38f262_8.png)

![](img/87f93b0bc9a9d8e944eb7fb7dd38f262_9.png)

![](img/87f93b0bc9a9d8e944eb7fb7dd38f262_11.png)

![](img/87f93b0bc9a9d8e944eb7fb7dd38f262_13.png)

è€ƒè¯•å†…å®¹å°†æ¶µç›–ä¿¡å·å¤„ç†ã€å¤šè¿›ç¨‹ç¼–ç¨‹ç­‰ï¼Œå½¢å¼ä¸ç»ƒä¹ é¢˜ç›¸ä¼¼ï¼ŒåŒ…æ‹¬ç¼–ç¨‹é¢˜å’Œç®€ç­”é¢˜ã€‚

![](img/87f93b0bc9a9d8e944eb7fb7dd38f262_15.png)

![](img/87f93b0bc9a9d8e944eb7fb7dd38f262_17.png)

![](img/87f93b0bc9a9d8e944eb7fb7dd38f262_19.png)

![](img/87f93b0bc9a9d8e944eb7fb7dd38f262_21.png)

![](img/87f93b0bc9a9d8e944eb7fb7dd38f262_23.png)

![](img/87f93b0bc9a9d8e944eb7fb7dd38f262_25.png)

---

![](img/87f93b0bc9a9d8e944eb7fb7dd38f262_27.png)

![](img/87f93b0bc9a9d8e944eb7fb7dd38f262_29.png)

![](img/87f93b0bc9a9d8e944eb7fb7dd38f262_31.png)

![](img/87f93b0bc9a9d8e944eb7fb7dd38f262_33.png)

![](img/87f93b0bc9a9d8e944eb7fb7dd38f262_35.png)

## æœ¬å‘¨ä½œä¸šï¼šæ–¯å¦ç¦Shell ğŸš

![](img/87f93b0bc9a9d8e944eb7fb7dd38f262_37.png)

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬çœ‹çœ‹æœ¬å‘¨çš„ä½œä¸šã€‚è¿™æ˜¯ä¸€ä¸ªæ„å»ºç®€æ˜“Shellçš„ç¨‹åºï¼Œåä¸ºâ€œæ–¯å¦ç¦Shellâ€(Stanford Shell)ã€‚

![](img/87f93b0bc9a9d8e944eb7fb7dd38f262_39.png)

![](img/87f93b0bc9a9d8e944eb7fb7dd38f262_41.png)

![](img/87f93b0bc9a9d8e944eb7fb7dd38f262_43.png)

è¿™ä¸ªä½œä¸šè¦æ±‚ä½ å®ç°ä¸€ä¸ªåŠŸèƒ½ç›¸å¯¹å®Œæ•´çš„Shellï¼Œéœ€è¦å¤„ç†ä»¥ä¸‹æ ¸å¿ƒåŠŸèƒ½ï¼š
*   æ‰§è¡ŒåŸºæœ¬å‘½ä»¤ï¼Œå¹¶æ”¯æŒå‰å°/åå°è¿è¡Œã€‚
*   ä½¿ç”¨ `jobs` å‘½ä»¤æŸ¥çœ‹æ‰€æœ‰åå°ä½œä¸šã€‚
*   ä½¿ç”¨ `fg` å‘½ä»¤å°†åå°ä½œä¸šè°ƒè‡³å‰å°ã€‚
*   ä½¿ç”¨ `bg` å‘½ä»¤é‡å¯ä¸€ä¸ªå·²åœæ­¢çš„åå°ä½œä¸šã€‚
*   ä½¿ç”¨ `slay` å‘½ä»¤å‘æ•´ä¸ªè¿›ç¨‹ç»„å‘é€ä¿¡å·ä»¥ç»ˆæ­¢ä¸€ç»„è¿›ç¨‹ã€‚
*   æ”¯æŒç®¡é“æ“ä½œï¼Œä¾‹å¦‚ `ls | grep | cut`ã€‚
*   æ”¯æŒè¾“å…¥/è¾“å‡ºé‡å®šå‘ã€‚
*   æ­£ç¡®å¤„ç† `Ctrl+C` (SIGINT) å’Œ `Ctrl+Z` (SIGTSTP) ä¿¡å·ï¼Œä½¿å…¶å½±å“å‰å°è¿›ç¨‹è€ŒéShellæœ¬èº«ã€‚

![](img/87f93b0bc9a9d8e944eb7fb7dd38f262_45.png)

ä½œä¸šçš„æ ¸å¿ƒéš¾ç‚¹åœ¨äºç®¡ç†å¤šä¸ªå­è¿›ç¨‹ã€å®ç°ç®¡é“ä»¥åŠå¤„ç†ä¿¡å·ã€‚å»ºè®®æŒ‰ç…§æä¾›çš„é‡Œç¨‹ç¢‘é¡ºåºå®Œæˆï¼Œå¹¶å……åˆ†åˆ©ç”¨æµ‹è¯•é©±åŠ¨æ–‡ä»¶è¿›è¡Œè°ƒè¯•ã€‚ä½œä¸šæˆªæ­¢æ—¥æœŸä¸ºä¸‹å‘¨ä¸‰ã€‚

![](img/87f93b0bc9a9d8e944eb7fb7dd38f262_47.png)

![](img/87f93b0bc9a9d8e944eb7fb7dd38f262_49.png)

![](img/87f93b0bc9a9d8e944eb7fb7dd38f262_51.png)

---

![](img/87f93b0bc9a9d8e944eb7fb7dd38f262_53.png)

## ä»Cçš„Pthreadsåˆ°C++çº¿ç¨‹ ğŸ”„

ç°åœ¨ï¼Œè®©æˆ‘ä»¬æ­£å¼è¿›å…¥C++çº¿ç¨‹çš„ä¸–ç•Œã€‚ä¸Cçš„Pthreadsç›¸æ¯”ï¼ŒC++11å†…ç½®çš„çº¿ç¨‹åº“è¯­æ³•æ›´ç®€æ´ï¼Œé›†æˆåº¦æ›´é«˜ã€‚

C++çº¿ç¨‹åŒæ ·å…±äº«è¿›ç¨‹å†…å­˜ï¼Œæ¯ä¸ªçº¿ç¨‹æ‹¥æœ‰ç‹¬ç«‹çš„æ ˆï¼Œä½†å¯ä»¥è®¿é—®å…±äº«çš„å…¨å±€æ•°æ®ã€‚å®ƒä»¬è¢«è®¤ä¸ºæ˜¯â€œè½»é‡çº§è¿›ç¨‹â€ï¼Œèƒ½å¤ŸçœŸæ­£åœ¨å¤šæ ¸CPUä¸Šå¹¶è¡Œæ‰§è¡Œã€‚

![](img/87f93b0bc9a9d8e944eb7fb7dd38f262_55.png)

![](img/87f93b0bc9a9d8e944eb7fb7dd38f262_57.png)

![](img/87f93b0bc9a9d8e944eb7fb7dd38f262_59.png)

### åŸºç¡€ç¤ºä¾‹ï¼šå……ç”µç¨‹åº

![](img/87f93b0bc9a9d8e944eb7fb7dd38f262_61.png)

æˆ‘ä»¬ä»ä¸€ä¸ªç®€å•çš„ç¨‹åºå¼€å§‹ï¼Œåˆ›å»ºå¤šä¸ªçº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹æ‰“å°ä¸€æ¡ä¿¡æ¯ã€‚

![](img/87f93b0bc9a9d8e944eb7fb7dd38f262_63.png)

![](img/87f93b0bc9a9d8e944eb7fb7dd38f262_65.png)

![](img/87f93b0bc9a9d8e944eb7fb7dd38f262_67.png)

```cpp
#include <iostream>
#include <thread>
#include <vector>
// éœ€è¦åŒ…å«è‡ªå®šä¹‰çš„ oslock.h æ¥ä¿è¯ cout çš„çº¿ç¨‹å®‰å…¨
#include "oslock.h"

![](img/87f93b0bc9a9d8e944eb7fb7dd38f262_69.png)

![](img/87f93b0bc9a9d8e944eb7fb7dd38f262_71.png)

![](img/87f93b0bc9a9d8e944eb7fb7dd38f262_73.png)

void recharge() {
    oslock lock;
    std::cout << "I recharge by spending time alone." << std::endl;
    osunlock unlock;
}

![](img/87f93b0bc9a9d8e944eb7fb7dd38f262_75.png)

int main(int argc, char *argv[]) {
    const size_t kNumIntroverts = 6;
    std::vector<std::thread> introverts(kNumIntroverts);
    for (size_t i = 0; i < kNumIntroverts; ++i) {
        // åˆ›å»ºçº¿ç¨‹å¹¶æ‰§è¡Œ recharge å‡½æ•°
        std::thread t(recharge);
        // ä½¿ç”¨ swap å°†çº¿ç¨‹å¯¹è±¡ç§»å…¥æ•°ç»„
        introverts[i].swap(t);
    }
    for (std::thread& introvert : introverts) {
        introvert.join(); // ç­‰å¾…æ‰€æœ‰çº¿ç¨‹ç»“æŸ
    }
    return 0;
}
```
**å…³é”®ç‚¹è¯´æ˜**ï¼š
*   `std::thread t(recharge)`ï¼šåˆ›å»ºå¹¶å¯åŠ¨ä¸€ä¸ªæ‰§è¡Œ `recharge` å‡½æ•°çš„æ–°çº¿ç¨‹ã€‚
*   `introverts[i].swap(t)`ï¼šè¿™æ˜¯ä¸€ä¸ªC++çš„â€œç§»åŠ¨â€æ“ä½œï¼Œå°†æ–°åˆ›å»ºçš„çº¿ç¨‹å¯¹è±¡ `t` ç§»å…¥æ•°ç»„ `introverts`ï¼Œé¿å…ä¸å¿…è¦çš„æ‹·è´ã€‚
*   `introvert.join()`ï¼šä¸»çº¿ç¨‹ç­‰å¾…è¯¥å­çº¿ç¨‹æ‰§è¡Œå®Œæ¯•ã€‚

![](img/87f93b0bc9a9d8e944eb7fb7dd38f262_77.png)

![](img/87f93b0bc9a9d8e944eb7fb7dd38f262_79.png)

![](img/87f93b0bc9a9d8e944eb7fb7dd38f262_81.png)

![](img/87f93b0bc9a9d8e944eb7fb7dd38f262_83.png)

![](img/87f93b0bc9a9d8e944eb7fb7dd38f262_85.png)

---

![](img/87f93b0bc9a9d8e944eb7fb7dd38f262_87.png)

![](img/87f93b0bc9a9d8e944eb7fb7dd38f262_89.png)

![](img/87f93b0bc9a9d8e944eb7fb7dd38f262_91.png)

### å‘çº¿ç¨‹ä¼ é€’å‚æ•° ğŸ“¨

![](img/87f93b0bc9a9d8e944eb7fb7dd38f262_93.png)

çº¿ç¨‹å‡½æ•°å¯ä»¥æ¥å—å‚æ•°ã€‚C++çº¿ç¨‹åº“å…è®¸ä½ ä»¥å€¼ä¼ é€’æˆ–å¼•ç”¨ä¼ é€’çš„æ–¹å¼å‘çº¿ç¨‹å‡½æ•°ä¼ å‚ã€‚

![](img/87f93b0bc9a9d8e944eb7fb7dd38f262_95.png)

![](img/87f93b0bc9a9d8e944eb7fb7dd38f262_97.png)

![](img/87f93b0bc9a9d8e944eb7fb7dd38f262_99.png)

![](img/87f93b0bc9a9d8e944eb7fb7dd38f262_100.png)

ä»¥ä¸‹æ˜¯ä¼ é€’å‚æ•°çš„ç¤ºä¾‹ç¨‹åºï¼š
```cpp
#include <iostream>
#include <thread>
#include <vector>
#include "oslock.h"

![](img/87f93b0bc9a9d8e944eb7fb7dd38f262_102.png)

![](img/87f93b0bc9a9d8e944eb7fb7dd38f262_103.png)

![](img/87f93b0bc9a9d8e944eb7fb7dd38f262_105.png)

![](img/87f93b0bc9a9d8e944eb7fb7dd38f262_107.png)

![](img/87f93b0bc9a9d8e944eb7fb7dd38f262_109.png)

![](img/87f93b0bc9a9d8e944eb7fb7dd38f262_111.png)

![](img/87f93b0bc9a9d8e944eb7fb7dd38f262_113.png)

void greeter(size_t id, size_t numTimes) {
    for (size_t i = 0; i < numTimes; ++i) {
        oslock lock;
        std::cout << "Greeter #" << id << " says 'Hello!'" << std::endl;
        osunlock unlock;
        // æ¨¡æ‹Ÿä¸€äº›å¤„ç†æ—¶é—´
        struct timespec ts = {0, random() % 1000000000};
        nanosleep(&ts, NULL);
    }
    oslock lock;
    std::cout << "Greeter #" << id << " has issued all greetings and goes home." << std::endl;
    osunlock unlock;
}

![](img/87f93b0bc9a9d8e944eb7fb7dd38f262_115.png)

![](img/87f93b0bc9a9d8e944eb7fb7dd38f262_117.png)

![](img/87f93b0bc9a9d8e944eb7fb7dd38f262_119.png)

![](img/87f93b0bc9a9d8e944eb7fb7dd38f262_121.png)

int main(int argc, char *argv[]) {
    std::cout << "Welcome to Greetland!" << std::endl;
    const size_t kNumGreeters = 6;
    std::thread greeters[kNumGreeters];
    for (size_t i = 0; i < kNumGreeters; ++i) {
        // åˆ›å»ºçº¿ç¨‹ï¼Œå¹¶ä¼ é€’å‚æ•° i+1 (å€¼ä¼ é€’)
        greeters[i] = std::thread(greeter, i + 1, i + 1);
    }
    for (std::thread& greeter : greeters) {
        greeter.join();
    }
    std::cout << "Everyone has been greeted. The end." << std::endl;
    return 0;
}
```
**å…³é”®ç‚¹è¯´æ˜**ï¼š
*   `std::thread(greeter, i + 1, i + 1)`ï¼šç¬¬ä¸€ä¸ª `greeter` æ˜¯å‡½æ•°åï¼Œåç»­å‚æ•° `i+1` å°†æŒ‰å€¼ä¼ é€’ç»™ `greeter` å‡½æ•°ã€‚
*   è‹¥éœ€ä¼ é€’å¼•ç”¨ï¼Œéœ€ä½¿ç”¨ `std::ref()` è¿›è¡ŒåŒ…è£…ï¼Œä¾‹å¦‚ `std::ref(sharedVariable)`ã€‚

![](img/87f93b0bc9a9d8e944eb7fb7dd38f262_123.png)

![](img/87f93b0bc9a9d8e944eb7fb7dd38f262_125.png)

![](img/87f93b0bc9a9d8e944eb7fb7dd38f262_127.png)

![](img/87f93b0bc9a9d8e944eb7fb7dd38f262_129.png)

![](img/87f93b0bc9a9d8e944eb7fb7dd38f262_131.png)

---

![](img/87f93b0bc9a9d8e944eb7fb7dd38f262_133.png)

![](img/87f93b0bc9a9d8e944eb7fb7dd38f262_135.png)

![](img/87f93b0bc9a9d8e944eb7fb7dd38f262_137.png)

![](img/87f93b0bc9a9d8e944eb7fb7dd38f262_139.png)

![](img/87f93b0bc9a9d8e944eb7fb7dd38f262_141.png)

![](img/87f93b0bc9a9d8e944eb7fb7dd38f262_143.png)

![](img/87f93b0bc9a9d8e944eb7fb7dd38f262_145.png)

## å¤„ç†ç«äº‰æ¡ä»¶ä¸äº’æ–¥é” ğŸ”

å¤šçº¿ç¨‹è®¿é—®å…±äº«èµ„æºæ—¶ï¼Œä¼šäº§ç”Ÿç«äº‰æ¡ä»¶ã€‚æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªæ¨¡æ‹Ÿå”®ç¥¨çš„ç¨‹åºæ¥æ¼”ç¤ºè¿™ä¸ªé—®é¢˜åŠå…¶è§£å†³æ–¹æ¡ˆã€‚

![](img/87f93b0bc9a9d8e944eb7fb7dd38f262_147.png)

### å­˜åœ¨ç«äº‰æ¡ä»¶çš„ç‰ˆæœ¬

![](img/87f93b0bc9a9d8e944eb7fb7dd38f262_149.png)

![](img/87f93b0bc9a9d8e944eb7fb7dd38f262_150.png)

![](img/87f93b0bc9a9d8e944eb7fb7dd38f262_152.png)

å‡è®¾æœ‰å¤šä¸ªå”®ç¥¨ä»£ç†çº¿ç¨‹å…±äº«ä¸€ä¸ªå‰©ä½™ç¥¨æ•°å˜é‡ã€‚
```cpp
size_t remainingTickets = 250; // å…±äº«å˜é‡

void ticketAgent(size_t id, size_t& tickets) {
    while (tickets > 0) {
        // æ¨¡æ‹Ÿå¤„ç†ç¥¨åŠ¡çš„æ—¶é—´
        handleCall();
        tickets--; // éåŸå­æ“ä½œï¼Œå­˜åœ¨ç«äº‰æ¡ä»¶ï¼
        oslock lock;
        std::cout << "Agent #" << id << " sold a ticket (" << tickets << " more to be sold)." << std::endl;
        osunlock unlock;
        takeBreak();
    }
    oslock lock;
    std::cout << "Agent #" << id << " notices all tickets are sold and goes home." << std::endl;
    osunlock unlock;
}
```
**é—®é¢˜**ï¼š`tickets--` ä¸æ˜¯åŸå­æ“ä½œï¼Œå¤šä¸ªçº¿ç¨‹å¯èƒ½åŒæ—¶è¯»å–ã€ä¿®æ”¹è¯¥å˜é‡ï¼Œå¯¼è‡´ç¥¨æ•°è®¡ç®—é”™è¯¯ï¼ˆå¦‚å–è¶…æˆ–è´Ÿæ•°ï¼‰ã€‚

![](img/87f93b0bc9a9d8e944eb7fb7dd38f262_154.png)

![](img/87f93b0bc9a9d8e944eb7fb7dd38f262_156.png)

![](img/87f93b0bc9a9d8e944eb7fb7dd38f262_158.png)

### ä½¿ç”¨äº’æ–¥é”è§£å†³é—®é¢˜

![](img/87f93b0bc9a9d8e944eb7fb7dd38f262_160.png)

![](img/87f93b0bc9a9d8e944eb7fb7dd38f262_162.png)

![](img/87f93b0bc9a9d8e944eb7fb7dd38f262_164.png)

äº’æ–¥é”å¯ä»¥ç¡®ä¿åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½è¿›å…¥è¢«é”ä¿æŠ¤çš„â€œä¸´ç•ŒåŒºâ€ä»£ç ã€‚
```cpp
#include <mutex>

![](img/87f93b0bc9a9d8e944eb7fb7dd38f262_166.png)

![](img/87f93b0bc9a9d8e944eb7fb7dd38f262_168.png)

![](img/87f93b0bc9a9d8e944eb7fb7dd38f262_170.png)

std::mutex ticketLock; // å…¨å±€äº’æ–¥é”
size_t remainingTickets = 250;

![](img/87f93b0bc9a9d8e944eb7fb7dd38f262_172.png)

void ticketAgent(size_t id, size_t& tickets, std::mutex& lock) {
    while (true) {
        lock.lock(); // åŠ é”
        if (tickets == 0) {
            lock.unlock(); // æ£€æŸ¥åç«‹å³è§£é”
            break;
        }
        tickets--; // åœ¨é”çš„ä¿æŠ¤ä¸‹ä¿®æ”¹å…±äº«å˜é‡
        size_t myTicket = tickets;
        lock.unlock(); // å°½å¿«è§£é”ï¼Œè®©å…¶ä»–çº¿ç¨‹è¿›å…¥

        // åœ¨é”å¤–æ‰§è¡Œè€—æ—¶çš„æ“ä½œï¼ˆå¦‚æ‰“å°ã€æ¨¡æ‹Ÿå·¥ä½œï¼‰
        handleCall();
        oslock outLock;
        std::cout << "Agent #" << id << " sold a ticket (" << myTicket << " more to be sold)." << std::endl;
        osunlock outUnlock;
        takeBreak();
    }
    oslock lock;
    std::cout << "Agent #" << id << " notices all tickets are sold and goes home." << std::endl;
    osunlock unlock;
}

![](img/87f93b0bc9a9d8e944eb7fb7dd38f262_174.png)

![](img/87f93b0bc9a9d8e944eb7fb7dd38f262_176.png)

![](img/87f93b0bc9a9d8e944eb7fb7dd38f262_178.png)

int main() {
    std::thread agents[10];
    for (size_t i = 0; i < 10; ++i) {
        // ä¼ é€’å…±äº«å˜é‡å’Œäº’æ–¥é”çš„å¼•ç”¨
        agents[i] = std::thread(ticketAgent, 100 + i, std::ref(remainingTickets), std::ref(ticketLock));
    }
    for (std::thread& agent : agents) { agent.join(); }
    return 0;
}
```
**å…³é”®ç‚¹è¯´æ˜**ï¼š
*   `std::mutex`ï¼šå®šä¹‰äº’æ–¥é”ã€‚
*   `lock.lock()` / `lock.unlock()`ï¼šæ‰‹åŠ¨åŠ é”ä¸è§£é”ã€‚ç¡®ä¿é”çš„ç²’åº¦å°½å¯èƒ½å°ï¼ŒåªåŒ…å›´è®¿é—®å…±äº«èµ„æºçš„ä»£ç ï¼Œé¿å…é•¿æ—¶é—´æŒæœ‰é”å¯¼è‡´æ€§èƒ½ä¸‹é™ã€‚
*   `std::ref()`ï¼šç”¨äºå‘çº¿ç¨‹å‡½æ•°ä¼ é€’å¼•ç”¨ç±»å‹çš„å‚æ•°ï¼ˆå¦‚ `remainingTickets` å’Œ `ticketLock`ï¼‰ã€‚

![](img/87f93b0bc9a9d8e944eb7fb7dd38f262_180.png)

![](img/87f93b0bc9a9d8e944eb7fb7dd38f262_182.png)

---

![](img/87f93b0bc9a9d8e944eb7fb7dd38f262_184.png)

![](img/87f93b0bc9a9d8e944eb7fb7dd38f262_186.png)

## æ€»ç»“ ğŸ¯

![](img/87f93b0bc9a9d8e944eb7fb7dd38f262_188.png)

![](img/87f93b0bc9a9d8e944eb7fb7dd38f262_189.png)

æœ¬èŠ‚è¯¾ä¸­æˆ‘ä»¬ä¸€èµ·å­¦ä¹ äº†ï¼š
1.  **C++çº¿ç¨‹åŸºç¡€**ï¼šå¦‚ä½•ä½¿ç”¨ `std::thread` åˆ›å»ºçº¿ç¨‹ã€ä¼ é€’å‚æ•°ä»¥åŠä½¿ç”¨ `join` ç­‰å¾…çº¿ç¨‹ç»“æŸã€‚
2.  **çº¿ç¨‹å®‰å…¨è¾“å‡º**ï¼šé€šè¿‡è‡ªå®šä¹‰çš„ `oslock`/`osunlock` ä¿è¯ `std::cout` åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹çš„è¾“å‡ºå®Œæ•´æ€§ã€‚
3.  **ç«äº‰æ¡ä»¶**ï¼šç†è§£äº†å¤šçº¿ç¨‹å¹¶å‘ä¿®æ”¹å…±äº«æ•°æ®æ—¶å¯¼è‡´çš„é—®é¢˜ã€‚
4.  **äº’æ–¥é”**ï¼šæŒæ¡äº†ä½¿ç”¨ `std::mutex` ä¿æŠ¤ä¸´ç•ŒåŒºï¼Œè§£å†³ç«äº‰æ¡ä»¶çš„åŸºæœ¬æ–¹æ³•ã€‚è®°ä½è¦å°½é‡ç¼©çŸ­é”çš„æŒæœ‰æ—¶é—´ä»¥æé«˜ç¨‹åºæ•ˆç‡ã€‚

![](img/87f93b0bc9a9d8e944eb7fb7dd38f262_191.png)

ä»Cçš„Pthreadsåˆ°C++çº¿ç¨‹ï¼Œæˆ‘ä»¬æ‹¥æœ‰äº†æ›´ç°ä»£ã€æ›´æ˜“ç”¨çš„å·¥å…·æ¥å¤„ç†å¹¶å‘ç¼–ç¨‹ã€‚åœ¨æ¥ä¸‹æ¥çš„è¯¾ç¨‹ä¸­ï¼Œæˆ‘ä»¬å°†æ¢è®¨æ›´é«˜çº§çš„åŒæ­¥æœºåˆ¶ï¼Œå¦‚æ¡ä»¶å˜é‡å’Œä¿¡å·é‡ã€‚