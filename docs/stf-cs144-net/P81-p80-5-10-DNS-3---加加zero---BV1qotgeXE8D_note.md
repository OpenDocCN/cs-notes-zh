# 课程 P81：DNS 查询与响应详解 🔍

在本节课中，我们将深入探讨 DNS 查询与响应的实际过程。我们将了解查询序列如何工作、各种 DNS 记录类型的作用，以及如何通过“胶水记录”解决 DNS 解析中的循环依赖问题。课程内容将结合具体示例，帮助你理解 DNS 协议在实际网络中的运作细节。

---

## DNS 查询序列概述

上一节我们介绍了 DNS 资源记录的基本概念。本节中，我们来看看客户端发出 DNS 查询后，查询在网络中传递的实际序列。

从高层次看，客户端发出递归查询，解析器则发出一系列非递归查询，最终获取目标域名（如 `stanford.edu`）的地址记录。但我们需要了解这些查询和响应的具体内容、每个服务器需要知道的信息。这在配置名称服务器和域名时至关重要。

---

## 名称服务器遍历与“鸡与蛋”问题

一个主要挑战来自遍历 DNS 区域的概念。名称服务器通常从一个根缓存文件开始，其中包含根服务器的 IP 地址。从那里，可以获取顶级域（如 `.edu`）的名称服务器地址，进而获取二级域（如 `stanford.edu`）的名称服务器地址。

然而，这里存在一个“鸡与蛋”问题。考虑 NS 记录：当你查询一个域的名称服务器时，DNS 记录返回的是主机名。例如，查询 `stanford.edu` 的名称服务器，会得到类似 `argus.stanford.edu` 的主机名。但问题在于，我们如何获取这些名称服务器本身的 IP 地址？我们需要 IP 地址才能向它们发起查询，但它们只给出了主机名。

---

## 解决方案：胶水记录

DNS 系统中的解决方案是使用“胶水记录”。当 `.edu` 服务器提供 `stanford.edu` 的 NS 记录时，它不仅提供服务器的主机名，还会附加这些名称服务器的地址记录（A 记录或 AAAA 记录）。这些附加的记录就是胶水记录，它们存储在父区域（此处为 `.edu`）的服务器中。

这意味着，`.edu` 服务器在提供 `stanford.edu` 的 NS 记录时，会一并提供这些 NS 记录对应服务器的 IP 地址，从而打破了循环依赖，让解析器能够继续向下查询。

---

## 查询序列逐步解析

让我们通过一个具体例子，逐步解析查询 `www.cs.stanford.edu` 的 A 记录过程。我们假设本地没有任何缓存，并使用“非递归”模式进行查询。

以下是查询步骤：

1.  **查询根服务器**：客户端向根服务器发起非递归查询，询问 `.edu` 域的名称服务器。根服务器响应，提供一组可用的 `.edu` 名称服务器及其 IP 地址（胶水记录）。

2.  **查询 .edu 服务器**：客户端使用上一步获得的 IP 地址，向一个 `.edu` 名称服务器查询 `stanford.edu` 的名称服务器。`.edu` 服务器响应，提供 `stanford.edu` 的名称服务器（如 `argus.stanford.edu`）及其 IP 地址（胶水记录）。

3.  **查询 stanford.edu 服务器**：客户端向 `argus.stanford.edu` 查询 `cs.stanford.edu` 的名称服务器。`argus.stanford.edu` 响应，提供 `cs.stanford.edu` 的名称服务器（如 `mission.cs.stanford.edu`）及其 IP 地址。

4.  **查询 cs.stanford.edu 服务器**：客户端向 `mission.cs.stanford.edu` 查询 `www.cs.stanford.edu` 的 A 记录。最终，`mission.cs.stanford.edu` 返回 `www.cs.stanford.edu` 对应的 IP 地址。

通过这个过程，解析器将获得的记录（包括胶水记录）缓存起来，以提高后续查询的效率。

---

## 其他重要的 DNS 记录类型

除了 A 记录和 NS 记录，DNS 还定义了其他几种关键记录类型。

以下是几种常见且重要的记录类型：

*   **CNAME 记录**：规范名称记录。它表明一个域名是另一个域名的别名。例如，`www.stanford.edu` 可能是一个 CNAME，指向 `www-v6.stanford.edu`。**关键规则**：如果一个域名有 CNAME 记录，则它不能同时拥有任何其他类型的记录（如 A、MX 记录）。
    ```dns
    www.stanford.edu.    IN    CNAME    www-v6.stanford.edu.
    ```

*   **MX 记录**：邮件交换记录。它指定负责接收发送到该域名的电子邮件的服务器。例如，查询 `cs.stanford.edu` 的 MX 记录，会返回其邮件服务器的主机名。与 NS 记录类似，响应通常也会包含邮件服务器的 A 记录作为附加部分。MX 记录包含一个“优先级”值，用于在有多个邮件服务器时确定首选服务器。
    ```dns
    cs.stanford.edu.    IN    MX    10    mailgate.cs.stanford.edu.
    ```

*   **SOA 记录**：起始授权机构记录。它提供关于该 DNS 区域的管理信息，如主名称服务器、区域管理员的邮箱、序列号、刷新间隔等。

*   **TXT 记录**：文本记录。允许将任意文本与域名关联，常用于域名所有权验证、邮件安全策略（如 SPF、DKIM）等。

*   **PTR 记录**：指针记录。用于反向 DNS 查找，根据 IP 地址查询对应的域名。

*   **AAAA 记录**：IPv6 地址记录。用于将主机名映射到 IPv6 地址（128 位）。
    ```dns
    host.example.com.    IN    AAAA    2001:db8::1
    ```

---

## 记录类型间的交互与注意事项

不同记录类型间的交互可能产生微妙影响。一个重要的案例是 **MX 记录不应指向 CNAME 别名**。

原因在于：MX 记录是供邮件传输代理等机器使用的。如果 MX 记录指向一个 CNAME，则解析器需要先解析 CNAME 找到规范名，再查询规范名的 A 记录，这引入了额外的查询层次，降低了效率且可能增加故障点。此外，由于 CNAME 记录不能与其他记录共存，这种设计实际上形成了一种“负激励”，鼓励管理员直接将 MX 记录指向具有 A 记录的主机名。

例如，如果 `cs144.stanford.edu` 是一个 CNAME，而你将 MX 记录指向它，那么在查询 MX 记录时，虽然会返回 `cs144.stanford.edu`，但无法同时附加其 A 记录（因为它没有 A 记录），迫使邮件服务器必须进行额外的 DNS 查询来解析这个 CNAME。

---

## 总结

本节课中，我们一起学习了 DNS 查询与响应的详细过程。我们探讨了 DNS 解析中遍历区域时遇到的“鸡与蛋”问题，并了解了通过 **胶水记录** 如何解决 NS 记录的循环依赖。我们还逐步解析了一个完整的 DNS 查询序列。

此外，我们介绍了多种重要的 DNS 记录类型，包括 **CNAME**、**MX**、**SOA**、**TXT**、**PTR** 和 **AAAA** 记录，并特别讨论了 MX 记录不应指向 CNAME 别名的最佳实践及其背后的设计考量。理解这些细节对于配置和管理可靠的 DNS 服务至关重要。

---

![](img/52560257f2d4b87ece511d34e74192fb_1.png)

![](img/52560257f2d4b87ece511d34e74192fb_1.png)

![](img/52560257f2d4b87ece511d34e74192fb_2.png)

![](img/52560257f2d4b87ece511d34e74192fb_2.png)