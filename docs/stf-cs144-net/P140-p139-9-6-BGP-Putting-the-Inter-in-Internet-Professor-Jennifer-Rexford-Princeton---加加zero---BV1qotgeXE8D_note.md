# 课程 P140：BGP - 互联网的粘合剂 🧩

在本节课中，我们将学习边界网关协议（BGP）的历史、工作原理、优势与挑战。BGP是连接互联网不同自治系统的核心协议，理解它对于理解互联网的运作至关重要。

---

## BGP的起源与演变

上一节我们介绍了课程概述，本节中我们来看看BGP是如何诞生的。

BGP本质上是将互联网不同部分粘合在一起的“胶水”。它与互联网共同成长。在20世纪80年代ARPANET运行时，网络本质上是一个树状结构，核心是ARPANET本身，其他网络连接到它。当时并不需要一个复杂的域间路由协议。

当NSFnet投入使用时，网络需要支持更灵活的互联方式。网络之间不仅连接到NSFnet骨干网，也可能彼此直接连接。由于拓扑结构可能变得循环，处理路由环路变得必要。因此，BGP被设计用于支持更通用拓扑结构上的路由。

随着时间的推移，BGP随着互联网的发展而演变，以应对可扩展性问题、地址空间耗尽以及需要承载大量地址块等挑战。同时，随着域间业务关系和服务提供商希望为客户提供的服务不断演变，BGP也在适应这些变化。例如，服务提供商现在更需要能够选择一条可能更长但经济上更有利或性能更好的路径。

---

## BGP的优势与弱点

上一节我们了解了BGP的演变，本节中我们来看看它的核心特性。

BGP使互联网成为互联网，它必须协调不同服务提供商及其他网络参与方相互竞争和冲突的目标。从这个意义上说，BGP解决了一个非常困难的问题，并且至少是一个可行的解决方案。它表现出显著的适应能力，能够应对安全性、可扩展性、业务关系乃至安全方面的担忧。

然而，BGP难以扩展，配置复杂。协议本身在某些方面相当简单：我向邻居通告路径，他们在路径开头添加自己，选择他们最喜欢的路径，然后通告给他们的邻居。但所有复杂的操作都在于BGP的配置方式。这也是BGP难以教授的原因之一，因为协议规范或教科书主要只描述了基于路径的逐跳路由信息传播，对配置方式提及甚少。

因此，学习曲线相当陡峭。人们由于经验不足或路由器中低级的错误配置机制而在配置BGP时犯错。我们经常看到由操作员错误导致的中断。一个很好的例子是多年前巴基斯坦电信试图在巴基斯坦境内屏蔽YouTube访问，却意外地向全球宣告他们是到达YouTube的最佳路径，导致整个互联网都相信了这一点。

所以，BGP确实容易受到这类“蝴蝶效应”的影响，即互联网某处的一个小故障或小配置错误可能产生严重的全球性后果。从这个角度看，它最初并非被设计成一个像如今互联网这样关键基础设施所需的健壮且安全的协议。

---

## BGP的安全性与路径选择

我们常听说攻击者能够通过BGP对等会话秘密宣告路由，从而破坏路由。您认为这在实践中经常发生吗？

在实践中，互联网上的许多攻击者实际上希望互联网保持正常运行，因为他们真正试图做的是对特定受害者发起拒绝服务攻击或进行网络钓鱼攻击。因此，总的来说，大多数攻击者不希望BGP瘫痪。第二个原因可能是对手通常无法访问支持BGP的路由器来进行操纵，或者不具备这样做的技能。所以，这肯定不如我们在互联网上看到的其他形式的网络攻击那么普遍。

话虽如此，我们每年仍会看到几次非常引人注目的中断，有时由操作员错误引起，有时方式不明，不清楚是故意还是事故。所以这无疑是一个巨大的漏洞，当它失效时，可能比对单个受害者的攻击产生更广泛的全球影响。因此，它仍然是一个重大的安全问题，但可以说，它不如我们在终端主机上看到的更有针对性的攻击形式那么普遍。

---

## 路径通告的局限性

路径矢量传输或通告给邻居的方式常被提及的一个限制是，当对等方向我通告一条路径时，我不知道他们实际上是否会遵循该路径。第二点是，他们在可以通告给我的众多路径中选择他们想要通告给我的那一条，因此可能存在我更喜欢但他们甚至没有告诉我的替代路径。这在实践中是一个很大的限制吗？

我认为这在实践中确实是一个值得关注的问题。例如，ISP的客户可能希望选择一条避开可能进行窃听或审查的特定国家的路径。这是一个很好的例子，说明你可能希望选择避开特定中间域的路径，但却无法做到，因为可能你的所有提供商都没有向你提供这样的路径，即使在实际的拓扑图上可能存在这样的路径。

也可能存在这样的情况，因为路由决策不是基于性能做出的，所以可能存在一条性能非常好的路径，在实际的拓扑图上可用，但你却看不到。一个很好的例子是多年前地中海发生中东光缆切断事件时，许多人开始绕地球另一端路由流量。我从多家运营商那里听说，并不是没有可用的路由，而是因为他们恰好学到的路由受到更多限制，他们也被迫让流量绕地球另一端走，有时延迟要高得多。

所以，我认为这些事情确实重要。但也很公平地说，如果你有多个提供商，你可能会从每个提供商那里得到一条路径，仍然可以获得你可能希望从一个提供商那里获得的某些路径多样性。

---

## 路由收敛问题

BGP常被提及的另一个问题是在发生路由变更后其收敛速度。您能简要概述一下问题是如何发现的以及目前的状况吗？

BGP和收敛有两个问题：一是系统是否完全收敛，即是否可能所有这些域根据本地选择不断相互影响，改变主意，永远无法达成全局一致；二是即使它们达成全局一致，速度有多快。在这个过渡期间，数据包可能会丢失、形成环路或乱序送达。人们发现，当Skype通话或Google Hangouts中断时，最有可能的原因是BGP收敛行为，而不是网络拥塞。

关于第一个问题，确实可能存在我想通过你路由、你想通过其他人路由、而他又想通过我路由的情况，我们不断相互影响，改变主意。但在实践中，这种情况被认为并不经常发生。原因是BGP首先是一个“金钱路由”协议，而不是数据包路由协议。数据包路由只是一个不错的副作用。因此，当我作为一个自治系统选择路由时，是基于经济因素：我是否需要付费才能通过你发送流量（因为你是我的提供商）？我通过你发送流量是否能获得收入（因为你是我的客户）？或者这是否是财务中性的（因为你是我的对等体）？最终，这种永久性的协议振荡暗示了某种奇怪的财务动态，即每个人都能在一个循环中赚钱，这在逻辑上不太可能。

关于第二个收敛速度的问题，多年前BGP收敛需要几分钟甚至更长时间，相对于许多实时应用所需的50毫秒或更少的目标来说，这绝对很长。部分原因是BGP会一个接一个地探索替代路径。所以，如果我使用的路径被撤销，我会探索下一个最偏好的路径，而该路径实际上可能与我刚丢失的路径命运相同。它们可能共享一个共同的链路。BGP只通告整个路径，它不会告诉你任何关于可能影响许多路径的共享资源的信息。因此，我和我的邻居们一个接一个地探索它们，最终可能导致探索这些路由的指数级迭代过程。

这种情况已经有所改善，因为驱动我从一个决策转向下一个决策的计时器这些年来已经缩短。坦率地说，即使多年前我们研究这个问题时，大多数BGP路由都异常稳定，每次持续十天或两周。互联网上只有少数不稳定的目的地频繁上下线，这被认为不是由路由振荡引起的，而是由设备实际上上下线导致的。在实践中，这些目的地极不受欢迎。它们要么因为一开始就无法到达而不受欢迎，要么因为不受欢迎而没有人关心确保它们周围的网络稳定。总而言之，这意味着互联网上的绝大多数流量所经过的路径通常稳定数天甚至一两周。

因此，在某种意义上，大量的研究、路由器软件的改进以及操作实践的改进，意味着BGP收敛虽然仍然重要，但远不像15年前看起来那样混乱。

---

## BGP的未来与替代方案

今天看BGP，您认为它是一个存在了很久的“创可贴”式解决方案，还是您相信并希望它作为域间路由协议在未来长期存在？如果您有机会重新设计，您会用类似还是完全不同的东西替换它？

BGP是我又爱又恨的协议。在某种意义上，它已被证明具有相当强的可演化性，并且多年来发生了巨大变化。Jakob Rexford多年前在一个演讲中称BGP为“三张餐巾纸协议”，因为最初设计时它是在三张餐巾纸上描述的。而我会说它现在是“厨房水槽协议”，因为其决策过程的步骤数量、传递的属性数量、BGP中可以处理的不同种类事物的数量，所有这些都变得越来越复杂。这部分是一种“成功的灾难”——可以用BGP做许多远远超出其最初设计目的的事情。所以，这证明了它的可演化性。但这也意味着它变得如此复杂、难以配置，并且非常不安全，因为最初设计时没有用于签名和验证路由信息的机制，也没有关于哪些自治系统被允许为特定地址块发起信息的可靠注册表。所以现在我们正试图“把猫放回袋子里”，通过整合大量安全基础设施来实现，而这实际上事后做起来相当困难。

从这个意义上说，BGP已经演变成一个相当笨重的状态。然而，如果你替换BGP，你仍然需要协调一个事实：不同的域拥有不同的自治权，并且对他们希望如何处理流量有不同的优先级。因此，我真正感兴趣的一点是，域之间的经济关系在单个数据包或路由协议消息的时间尺度上展开，这对于经济关切来说是一个非常小的时间尺度。如果你看看服务器领域发生了什么，虚拟化使得基础设施的所有者与实际上在其上运行应用程序的方（可能属于在属于像Google、Microsoft或Amazon这样的公司的服务器上运行的租户的虚拟机）真正分离成为可能。

因此，我对我们现在也可以虚拟化网络的想法很感兴趣。如果我能拥有一个跨越多个方拥有和管理的设备的虚拟网络，然后在该虚拟拓扑上控制自己的命运，那将是很棒的。这样，业务关系就不重要了，它是我与我的虚拟组件所嵌入的基础设施方之间的关系，而不是我与并排的邻居或更糟的、与我相隔多跳、对我没有责任也没有可见性的域之间的关系。所以我认为，如果我们利用过去十年虚拟化方面的一些创新，我们可以构建一个更加灵活、同时仍然认识到存在真正的自治创收方的路由系统。

---

## 给未来研究者的建议

如果有人正在观看并考虑攻读研究生，对网络感兴趣，域间路由仍然是一个有趣的话题吗？它是否再次变得有趣？您有什么建议？

我认为它在两个方面仍然有趣，也许与15年前不同。一是重新思考在新的经济现实中域之间如何关联，利用虚拟化，利用大型内容提供商非常接近其客户（通常只有一两跳之遥）这一事实，使得网络在某些方面比BGP设计时更加扁平。因此，我认为重新审视域间如何互联，考虑到视频和内容分发，以及虚拟化和软件定义网络，是一个有趣的机会。

总的来说，我们发现互联网上任何跨域的东西都很糟糕。在域内部署服务质量、安全性、IPv6、组播等已经足够具有挑战性，但一旦你需要50，000方合作，几乎不可能实现有原则的变革。因此，我认为如今许多关于BGP更有趣的工作更多地关注增量部署、增量部署的激励措施，以及即使只有一小部分互联网采用技术变革也能获得一些安全性、可扩展性甚至经济收益的解决方案，然后希望它能激励其他人参与。所以我认为我们已经进入了一个领域，在这个领域，关于BGP的工作可能更侧重于如何以战略方式演进它，而不是一个全新的BGP设计会是什么样子。

---

## 总结

本节课中，我们一起学习了边界网关协议（BGP）。我们探讨了它的历史演变，了解了它作为互联网“粘合剂”的核心作用。我们分析了BGP的优势，如其解决复杂协调问题的能力，也审视了它的弱点，包括配置复杂性、安全漏洞和对操作错误的敏感性。我们还讨论了路径选择、收敛问题以及BGP的未来发展方向。理解BGP对于深入理解互联网的架构和运作原理至关重要。