# 课程 P79：DNS 基础（第1部分）🌐

在本节课中，我们将要学习域名系统（DNS）的基础知识。DNS是互联网的核心服务之一，负责将人类可读的域名（如 `www.example.com`）转换为计算机可识别的IP地址（如 `192.0.2.1`）。我们将从DNS的起源讲起，了解其设计目标、核心架构以及查询的基本工作原理。

---

## 从URL到IP地址的映射问题 🔗

让我们先观察一个典型的URL。一个基本的URL，就像你在浏览器地址栏中输入的那样，通常由三部分组成：
1.  应用协议：例如 `http://`，它指定了请求文件所使用的协议，并默认对应TCP的80端口。
2.  主机名：例如 `cs144.stanford.edu`，这是一个由点分隔、人类可读的名称，用于指定我们想要联系的实际网络节点。
3.  文件路径：例如 `/index.html`，它指定了在应用层（如HTTP）上我们想要请求的具体资源。

到目前为止，我们讨论互联网时一直使用IP地址。但当我们输入URL时，使用的是主机名。这就引出了一个核心问题：**我们如何将人类可读的主机名翻译成IP地址？**

当然，你可以直接在URL中输入IP地址来替代主机名。但人类可读的名称非常有用，因此从互联网诞生之初，人们就意识到了其重要性。

---

## 早期方案：主机文件（hosts.txt）📜

在互联网还很小的早期，有一个名为 `hosts.txt` 的中央文件。互联网上的每一台主机及其对应的IP地址都记录在这个文件中，由网络信息中心（NIC）维护。

**工作原理**：
*   每个联网节点会定期联系位于 `sri-nic.arpa` 的中央服务器。
*   使用文件传输协议（FTP）下载 `hosts.txt` 文件的最新版本。
*   新版本包含了所有新增的主机，节点从而能将主机名映射到IP地址。

**局限性**：
对于只有少数主机的情况，这种方法尚可。但随着互联网规模（节点数 `n`）的增长，其扩展性问题变得突出。每个节点都需要定期下载一个长度与 `n` 成正比的文件，所需的网络容量呈 `n²` 增长。这显然不是一个可扩展的长期解决方案。

---

## DNS的诞生与设计目标 🎯

域名系统（DNS）的诞生，正是为了解决上述扩展性问题。其基本任务是：**将人类可读的名称映射到地址（最初是IP地址，现在可以映射到更多类型的值）**。

DNS的设计考虑了以下几个关键因素：
1.  **处理海量记录**：理论上需要能处理数十亿级别的映射记录。
2.  **分布式控制**：不应由一个中心机构管理所有名称。例如，斯坦福大学可以管理 `stanford.edu` 下的名称，而亚马逊可以管理 `amazon.com` 下的名称。
3.  **鲁棒性（Robustness）**：系统不应因单个节点的故障而整体崩溃。

使这个分布式、层次化且鲁棒的系统成为可能，主要依赖于两个关键特性：
*   **以读为主的数据库**：名称到地址的映射被读取的频率远高于被更新的频率。主机名和IP地址的绑定关系相对稳定。
*   **宽松的一致性**：允许映射变更的传播存在一定延迟。即，并非所有用户都需要立即看到最新的变化。

这两个特性共同允许DNS进行**广泛的缓存**。一旦某个查询结果被获得，就可以在本地缓存一段时间，并用于回答后续相同的查询，从而极大地减轻了根服务器的压力并提高了响应速度。

---

## DNS的层次化命名架构 🏛️

为了实现分布式管理，DNS采用了层次化的命名结构。我们都对此很熟悉：

*   **根域（Root）**：位于最顶层，用一个点 `.` 表示，对应根域名服务器。
*   **顶级域（TLD）**：位于根域之下，例如 `.com`、`.org`、`.edu`、`.cn`（国家代码顶级域）。
*   **二级域（SLD）**：在顶级域之下，例如 `stanford.edu`、`baidu.com`。
*   **子域（Subdomain）**：域的所有者可以进一步创建子域，例如 `cs.stanford.edu`（斯坦福大学下的计算机科学系），`www.google.com`（谷歌公司下的万维网服务）。

**关键机制**：
*   **区域（Zone）与授权**：每个层次（根、TLD、域名、子域名）都可以作为一个独立的“区域”进行管理。上级区域可以将子区域的**管理权授权**给下级。例如，根服务器将 `.edu` 区域的管理权授权给 `.edu` 的服务器；`.edu` 服务器又将 `stanford.edu` 区域的管理权授权给斯坦福大学的DNS服务器。
*   **服务器复制**：每个区域都可以由多台复制的服务器提供服务，而非单点。这提供了高可用性和鲁棒性。即使一台服务器宕机，其他副本仍能应答查询。

---

## 根服务器与查询流程 🔍

**根服务器**：
*   根区域由标记为 A 到 M 的13组根服务器提供服务。
*   这些服务器通过 **任播（Anycast）** 技术被高度复制。这意味着全球有数百台物理服务器共享这13个IP地址。你的查询会自动被路由到离你**最近**的一台根服务器实例。
*   这种设计使得根服务器极其鲁棒，能够抵御大规模分布式拒绝服务（DDoS）攻击。

**DNS查询示例**：
假设一个客户端想知道 `www.stanford.edu` 的IP地址。

以下是查询步骤：
1.  **客户端 -> 本地解析器（递归查询）**：客户端向其配置的本地DNS解析器（通常由ISP或网络管理员提供）发送一个**递归查询**：“请告诉我 `www.stanford.edu` 的IP地址”。
2.  **解析器 -> 根服务器（非递归查询）**：假设解析器的缓存是空的。它首先向一个根服务器发送**非递归查询**：“请问，负责 `.edu` 域的服务器是谁？”
3.  **根服务器 -> 解析器**：根服务器回复：“负责 `.edu` 的服务器是这些（提供 `.edu` TLD服务器的IP地址列表）”。解析器缓存此结果。
4.  **解析器 -> .edu TLD服务器（非递归查询）**：解析器接着向 `.edu` 服务器发送非递归查询：“请问，负责 `stanford.edu` 域的服务器是谁？”
5.  **.edu TLD服务器 -> 解析器**：`.edu` 服务器回复：“负责 `stanford.edu` 的服务器是这些（提供斯坦福大学DNS服务器的IP地址列表）”。解析器缓存此结果。
6.  **解析器 -> stanford.edu 权威服务器（非递归查询）**：解析器最后向斯坦福大学的权威DNS服务器发送查询：“请问，`www.stanford.edu` 的IP地址是什么？”
7.  **stanford.edu 权威服务器 -> 解析器**：斯坦福大学的服务器回复：“`www.stanford.edu` 的IP地址是 `X.X.X.X`”。解析器缓存此最终结果。
8.  **解析器 -> 客户端**：解析器将最终的IP地址 `X.X.X.X` 返回给客户端。

**缓存的作用**：
如果几分钟后，另一个客户端也查询 `www.stanford.edu`，本地解析器就可以直接从缓存中返回答案，无需再次进行这一长串查询。这极大地提升了效率。

**安全提示**：
这种缓存机制也带来了安全风险，例如 **DNS缓存投毒（Cache Poisoning）**。攻击者可能试图向解析器注入伪造的记录，使其将 `www.stanford.edu` 解析到恶意IP地址。我们将在后续课程的安全部分讨论这种攻击及其防御。

---

## 总结 📝

本节课中我们一起学习了DNS的基础知识：
1.  **DNS的目的**：解决将人类可读的域名映射到机器IP地址的核心问题。
2.  **历史演进**：从中心化的 `hosts.txt` 文件发展到分布式、可扩展的DNS系统。
3.  **设计核心**：基于**层次化命名**和**区域授权**实现分布式管理；利用**以读为主**和**宽松一致性**的特性支持**广泛缓存**，以实现高性能和高鲁棒性。
4.  **架构组成**：包括根服务器、TLD服务器、权威域名服务器和本地解析器构成的层次结构。
5.  **查询流程**：理解了递归查询与非递归查询的区别，以及一个DNS查询从客户端到获取IP地址的完整迭代过程。

![](img/872268e00a80214c7f6cfb2d9cbe3246_1.png)

![](img/872268e00a80214c7f6cfb2d9cbe3246_2.png)

DNS是互联网的无声基石，它让我们能够通过简单的名字访问复杂的网络世界。在下一节课中，我们将深入探讨DNS的记录类型和报文格式。