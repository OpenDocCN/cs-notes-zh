![](img/959335340f4b42addb08c7ae44079387_1.png)

# 课程 P66：TCP/IP 协议详解 - 第4.11讲 拥塞控制 🚦

![](img/959335340f4b42addb08c7ae44079387_3.png)

在本节课中，我们将要学习计算机网络中的一个核心概念：**拥塞控制**。我们将了解它与流量控制的区别，理解网络拥塞的原理，并深入探讨TCP协议中实现拥塞控制的关键算法与机制。

![](img/959335340f4b42addb08c7ae44079387_5.png)

![](img/959335340f4b42addb08c7ae44079387_7.png)

---

![](img/959335340f4b42addb08c7ae44079387_9.png)

![](img/959335340f4b42addb08c7ae44079387_11.png)

## 概述 📋

![](img/959335340f4b42addb08c7ae44079387_13.png)

在这一单元中，你已经看到了交通和分组交换如何通过拥塞控制相互交互。

![](img/959335340f4b42addb08c7ae44079387_15.png)

![](img/959335340f4b42addb08c7ae44079387_17.png)

流量控制是关于终点主机的，它确保源主机不会使目的地主机过载。通过发送超过它可以接收的拥塞控制。

![](img/959335340f4b42addb08c7ae44079387_19.png)

另一方面，是关于防止源主机过载链接和路由器之间的。当源主机将太多的包放入网络时，或者当许多源主机将包放入网络时，它们可以填满路由器队列，直到它们溢出。

![](img/959335340f4b42addb08c7ae44079387_21.png)

![](img/959335340f4b42addb08c7ae44079387_23.png)

在TCP中，在发送主机上运行的拥塞控制算法告诉它网络中可以拥有多少包，以便不过度填满路由器队列。TCP总会导致一些包被丢弃，因为这是它使用的反馈信号，以知道路由器队列是否满了。但当它工作良好时，TCP保持包丢弃率低，链接保持良好且充满，并允许流量具有高吞吐量。

![](img/959335340f4b42addb08c7ae44079387_25.png)

![](img/959335340f4b42addb08c7ae44079387_27.png)

---

![](img/959335340f4b42addb08c7ae44079387_29.png)

## 网络拥塞的原理 🧠

![](img/959335340f4b42addb08c7ae44079387_31.png)

![](img/959335340f4b42addb08c7ae44079387_33.png)

上一节我们介绍了拥塞控制的基本目标，本节中我们来看看网络拥塞发生的根本原理。

![](img/959335340f4b42addb08c7ae44079387_35.png)

![](img/959335340f4b42addb08c7ae44079387_37.png)

尼克首先解释了网络拥塞的原则。你学习了当一个路由器结构接收的包比它可以发送的包快时发生的事情。如果拥塞是短暂的，那么路由器可以吸收这个额外的流量到一个队列中并排空队列。如果拥塞是长期的，长期到队列溢出，然后路由器必须丢弃一些包。

![](img/959335340f4b42addb08c7ae44079387_39.png)

尼克介绍了一种非常有价值的思考方式：与其想出丢弃包的方案，不如思考你想要网络总体行为的是什么。我们想要网络公平，并解释这意味着在引入最大最小公平性的概念时。最大公平性说网络是公平的，如果你不能增加一个流的速率，而不减少一个速率较低的流的速率。

![](img/959335340f4b42addb08c7ae44079387_41.png)

有许多方法可以实现这个目标，并且今天的网络有许多不同机制。但我们专注于一个。

![](img/959335340f4b42addb08c7ae44079387_43.png)

![](img/959335340f4b42addb08c7ae44079387_45.png)

---

![](img/959335340f4b42addb08c7ae44079387_47.png)

## TCP拥塞控制基础算法 🔢

![](img/959335340f4b42addb08c7ae44079387_49.png)

![](img/959335340f4b42addb08c7ae44079387_51.png)

理解了公平性的目标后，我们来看看TCP为实现这一目标所采用的基础算法。

![](img/959335340f4b42addb08c7ae44079387_53.png)

你学习TCP使用的基本算法，叫做**累加增加，乘法减少**（AIMD）。当运行顺畅时，TCP增加可以未完成的字节数，它可以在轮询时间内增加一个段大小。当TCP检测到一个包被丢弃时，它减半可以未完成的字节数。

![](img/959335340f4b42addb08c7ae44079387_55.png)

![](img/959335340f4b42addb08c7ae44079387_57.png)

你学习这个行为的样子，使用TCP锯齿图。每个单独的流在共享许多流的链接上都有一个锯齿图。所有这些平均下来，都显示出对链接的持续高使用率。

![](img/959335340f4b42addb08c7ae44079387_59.png)

使用锯齿波形，我们使用符号AIMD来计算TCP吞吐量。如果你假设网络以均匀率 `p` 丢失包，那么TCP流的吞吐量是：

![](img/959335340f4b42addb08c7ae44079387_61.png)

![](img/959335340f4b42addb08c7ae44079387_63.png)

**吞吐量 ≈ (1.22 * MSS) / (RTT * √p)**

![](img/959335340f4b42addb08c7ae44079387_65.png)

这个方程做出了许多简化假设，但它实际上通常相当准确。在许多情况下，在考虑网络可能行为的时候，它是一个非常有价值的工具。

![](img/959335340f4b42addb08c7ae44079387_67.png)

---

![](img/959335340f4b42addb08c7ae44079387_69.png)

## TCP拥塞控制的实践实现 ⚙️

![](img/959335340f4b42addb08c7ae44079387_71.png)

![](img/959335340f4b42addb08c7ae44079387_73.png)

理论算法需要具体的机制来实现。接下来，我们将学习TCP如何在实践中实现这些拥塞控制原则。

![](img/959335340f4b42addb08c7ae44079387_75.png)

你已经学习了TCP如何在实践中实现这些原则。菲尔告诉你在20世纪80年代末互联网崩溃的事情，由于拥堵和至今仍在使用的TCP修复措施。

![](img/959335340f4b42addb08c7ae44079387_77.png)

你学习了TCP的三个版本：TCP Tahoe、TCP Reno和TCP New Reno。

![](img/959335340f4b42addb08c7ae44079387_79.png)

![](img/959335340f4b42addb08c7ae44079387_81.png)

我们首先覆盖的重要想法是，TCP端点维护一个**拥塞窗口**（cwnd）。一个TCP流可能在网络中拥有不被确认的字节数 `N`，当 `N` 是其流量控制窗口和拥塞控制窗口的最小值时。你不将比接收端能够处理的包数更多的包放入网络，或比中间链接和路由器能够处理的包数更多。

![](img/959335340f4b42addb08c7ae44079387_83.png)

你学习了TCP如何使用两个状态来控制拥塞控制窗口的大小：**慢启动**和**拥塞避免**。

![](img/959335340f4b42addb08c7ae44079387_85.png)

![](img/959335340f4b42addb08c7ae44079387_87.png)

*   **慢启动**让TCP能够快速找到接近正确的拥塞窗口大小。
*   **拥塞避免**使用AIMD算法。

![](img/959335340f4b42addb08c7ae44079387_89.png)

TCP从慢启动开始，并在首次检测到丢失时过渡到拥塞避免。

![](img/959335340f4b42addb08c7ae44079387_91.png)

![](img/959335340f4b42addb08c7ae44079387_93.png)

你学习了TCP如何估计其连接的往返时间（RTT），它需要这个估计来确定一个确认超时的时间。通过跟踪平均值，以及接收一个片段所需的时间变异性，TCP也可以避免不必要的重传，并且不会等待太久。

![](img/959335340f4b42addb08c7ae44079387_95.png)

你学习了TCP如何控制它将包放入网络，使用一种叫做**自我计时**的技术。你在我看给你展示TCP行为的动画时首先看到了自我计时。菲尔，然后带我们通过了一些使用自我计时的例子。TCP只有在网络中有新包时才会放入，当它收到确认时，或者当超时时间到的时候。这在防止拥塞方面非常有用，因为它意味着，TCP只有在数据包已经离开网络时才将数据包放入网络。

![](img/959335340f4b42addb08c7ae44079387_97.png)

---

![](img/959335340f4b42addb08c7ae44079387_99.png)

## TCP的优化机制 🚀

![](img/959335340f4b42addb08c7ae44079387_101.png)

![](img/959335340f4b42addb08c7ae44079387_103.png)

基础的AIMD算法和状态机是核心，但TCP还包含了一些重要的优化来提升性能。

![](img/959335340f4b42addb08c7ae44079387_105.png)

最后，我们覆盖了TCP中添加的三个优化：快速重传、快速恢复和窗口膨胀。

![](img/959335340f4b42addb08c7ae44079387_107.png)

![](img/959335340f4b42addb08c7ae44079387_109.png)

以下是这些优化机制的简要介绍：

![](img/959335340f4b42addb08c7ae44079387_111.png)

*   **快速重传**：让TCP在只丢失一个数据包时继续前进，而不是等待超时。TCP重传一个段，当它检测到对前一个段的三个重复确认时。这是TCP继续接收段的迹象，但它没有使用快速恢复接收到这个特定的段。
*   **快速恢复**：TCP Reno不退回到慢启动，或三个重复动作，它只是将拥塞窗口减半并留在拥塞避免状态。
*   **窗口膨胀**（New Reno优化）：使得三个重复动作不导致TCP失去一个RTT值的传输，当它等待缺失的片段被添加时。

![](img/959335340f4b42addb08c7ae44079387_113.png)

---

![](img/959335340f4b42addb08c7ae44079387_115.png)

## 总结与展望 🌉

![](img/959335340f4b42addb08c7ae44079387_117.png)

![](img/959335340f4b42addb08c7ae44079387_119.png)

本节课中我们一起学习了计算机网络中至关重要的拥塞控制机制。

![](img/959335340f4b42addb08c7ae44079387_121.png)

现在，交通拥堵最令人着迷的地方是，它是一种被发现的现象。随着互联网的发展，没有人真正想过这样的事情可能会发生，或者如何控制它。它是一种涌现行为，一旦网络变得足够大且被广泛使用。现在，它是网络通信的基本概念，被视为构建强大且性能高的系统至关重要的部分。

![](img/959335340f4b42addb08c7ae44079387_123.png)

![](img/959335340f4b42addb08c7ae44079387_125.png)

TCP的现代版本，比课堂上讨论的稍微先进一些。但主要是它们已经进化到能够处理许多更快的网络。操作系统中发货的TCP版本具有TCP Reno，或在其算法中具有TCP New Reno，以处理非常快的网络，添加了新的功能和操作模式。人们会查看Linux源代码，在那里你会看到这些算法。

![](img/959335340f4b42addb08c7ae44079387_127.png)

但是，这也很酷的是，这些繁琐的算法有一个坚实的概念基础和理论。一方面，我们可以谈论RTT变异估计、快速恢复和自我时钟，另一方面，这些理论支撑着全球互联网的稳定运行。