# 课程 P137：交换机与路由器设计访谈 🖧

在本节课中，我们将跟随Tom Edsall的访谈，了解以太网交换机和IP路由器的设计历史、核心功能、架构演进以及未来趋势。Tom是网络设备设计领域的资深专家，曾主导设计了思科Catalyst系列交换机等众多产品。

## 访谈对象介绍

今天我们邀请到的是Tom Edsall，我认识他已有多年。

Tom从事交换机和路由器的设计工作已经很久了。

他曾在斯坦福大学攻读硕士学位，毕业后在多家公司工作过。

其中最著名的是思科公司，可以说，他负责设计和部署的以太网交换机与路由器比世界上任何其他人都多。因此，他完全有资格在今天与我们探讨交换机和路由器的设计。

你好，Tom。

## 交换机和路由器的起源 🏗️

Tom，我的第一个问题是，在CS144课程中，我们学习了以太网交换机和IP路由器及其基本功能。

你能谈谈路由器和以太网交换机的历史吗？它们最初是何时被制造和销售的？是基于CPU还是专用硬件？

好的。

我认为第一台非常成功的以太网交换机，是我们在思科设计的一款名为Catalyst 5000的产品。

Catalyst 5000最初是一个简单的二层交换机，或者说是一个多端口网桥。

它基于我们设计的一些定制硅芯片。

每个端口都使用一个ASIC（专用集成电路）。

一块线卡上有12个端口，因此就有12个这样的ASIC。

然后，一个机箱中可以插入多块这样的线卡。

所有这些设备都通过背板上的公共总线连接。

这款产品是在我们1995年加入思科后不久设计的。

我们当时立即开始研究如何为其增加三层功能，即如何实现路由。

与此同时，思科的主营业务路由器是基于微处理器的，采用MIPS处理器，完全由软件实现。

我们开始研究用硬件实现路由需要什么。

最初的回应是这不可能实现。人们都说：“这太复杂了”，并且解释起来太费时间。

我们当时不太理解问题所在。我们不断追问。

最终我们得出结论，这是可以做到的。只是人们没想过用硬件来实现。

## 硬件与软件的协同：缓存技术 ⚙️

我们开发了一款商业产品，它允许流量的第一个数据包在硬件中被桥接到系统内的路由板卡上。

那个路由器是在MIPS处理器上运行的软件路由器。

它会像往常一样路由数据包。第一个数据包被发送到软件路由器。

当数据包从软件路由器返回时，我们将返回流与发送到软件路由器的流进行比较。

我们可以看到数据包的不同之处。当然，不同之处在于它有了新的**二层报头**。

于是，我们会记住这个**二层报头**。

之后的所有数据包，我们只需执行从软件中学到的**二层报头重写**。

因此，硬件和软件几乎是完全独立运行的。硬件本质上是在缓存**三层转发信息**。

那么，这种缓存技术今天还在使用吗？

是的。这取决于具体产品。一般来说，我们考虑**快速路径**和**慢速路径**。你可以把快速路径看作一个缓存。

有时这个缓存可能在硬件中实现，有时可能在软件中实现。

通常，第一个数据包会走慢速路径，或者带有某些选项的数据包也会走慢速路径。

而普通数据包则可以通过快速路径。

缓存技术在这些年时兴时衰，这取决于我们要解决的问题以及解决这些问题的约束条件。

## 现代交换机的复杂功能 📋

在课堂上，我们学习了基本转发功能：学习二层地址，然后转发，如果不知道地址则广播。

对于三层，我们检查版本号、校验和，然后递减TTL，最后执行最长前缀匹配查找。

但在现代交换机中，它们的功能远不止于此。它们做的事情列表令人望而生畏。

你刚才提到的基本功能，本质上就是我们最初那个缓存信息的硬件包装器所做的事情。

我们做的其他工作还包括大量安全功能。

有时只是简单的检查，比如确保没有零偏移分片。

除了检查版本号，还有这些简单的安全检查。

当然，当你递减TTL时，必须确保如果TTL变为零，要将数据包重定向到本地CPU。

你需要为内部CPU提供各种保护，使其不易受到拒绝服务攻击。

因此，对于发送到本地CPU的控制平面数据包，需要进行各种过滤和限速。

组播的实现完全是一场噩梦，有上百个不同的功能需要正确配置。这是我们做过的最困难的事情。

这些交换机中还必须实现许多监控功能。

最基本也最有用的功能之一叫做**交换机端口分析器**，我们可以将一个特定端口的所有流量镜像到另一个端口，或者将来自一个端口的所有流量发送到某个分析器。

当然，你可能希望同时运行多个这样的分析器。

你可能还希望远程交换机上的分析器能够监控本地交换机的流量。

因此，你必须想办法通过网络隧道传输这些信息。

此外，还有服务质量、活动队列管理等。路由器和交换机的功能列表非常长。

## 不同场景下的设备差异 🌐

是的，它们确实是非常复杂的设备。我猜它们也被用于各种不同的地方，比如家庭、企业、广域网、数据中心、接入网、网络边缘。

针对这些不同的应用场景，这些设备、系统以及它们的构建方式是否有本质上的不同？

是的，确实不同。

看看你家里的路由器，它的功能集并不特别复杂，带宽也非常低。

当然，它们通常内置了无线功能。这类设备通常使用某些商用芯片，并运行一个操作系统，可能基于Linux。

更大的设备分为固定外形规格（端口数量固定，无法更换线卡）和大型模块化机箱（可以插入多块线卡和多种不同类型的接口）。

对于小型交换机，其内部架构通常是**单芯片交换机**。

对于更大的系统，单芯片显然不够用，因为端口数量超过了单个芯片的容量，或者整个系统分布在多块线卡，有时甚至是多个机箱或多个机架上。

这些系统倾向于基于**交叉开关**或某种集中式、相对简单的高性能交换单元，在线卡之间或端口设备之间交换流量。

端口设备本身或线卡，通常看起来很像单芯片交换机，一个设备可能支持48个10吉比特以太网端口或48个40吉比特以太网端口。

在数据中心，重点在于带宽和低成本。

在园区网，对带宽的要求没那么高，但肯定会基于成本，并围绕身份验证和端点管理有许多接入功能。

在广域网，重点将放在带宽、缓冲以及不同类型的接口上，服务质量也变得很重要。

所以，是的，它们有各种不同的类型。

## 技术演进与架构革新 🚀

这些交换机和路由器多年来不断演进和发展，主要的技术或架构进步是什么让它们能够持续扩展？

主要是来自底层技术（如摩尔定律）的推动，还是有助于网络交换机和路由器的特定技术或特定架构？是什么让它们能够跟上性能需求？

如果我们严格遵循摩尔定律，世界上最快的链路可能只有10吉比特。当然，今天我们交换的速度比这快几个数量级。

因此，网络和网络设备必须经历架构变革，以克服摩尔定律的限制。

我们当然会尽可能利用摩尔定律。

但回顾我参与设计的一些交换机（请记住，这些交换机占据了整个交换机市场的60%到70%，是非常重要的平台），最初的Catalyst 5000产品线基于总线架构，是一个共享总线。

整个交换机的总带宽是每秒1吉比特，它聚合了10兆比特链路和一些100兆比特链路。

但那个总线很快就达到了速度极限。总线的性能取决于单根导线上的信号速度以及能并行放置多少根导线。这就是整个机箱的极限。

该平台的下一代产品，Catalyst 6000（我认为它至今仍是思科价值数十亿美元的产品），大约在1998或1999年交付。它转向了交叉开关架构。

交叉开关架构允许我们在每根导线上实现更快的信号传输，并且端口之间的信号传输可以相互独立。因此，它不再是基于总线的架构。

然而，那并不是一个带仲裁的交换结构。我知道Nick你在仲裁及其重要性方面做了很多研究。但实际上，在2000年至2010年间，世界上大多数网络并没有仲裁功能。

基本上，数据包被发送到交叉开关，并希望它能顺利送达另一端，没有冲突。这样成本更低，也更简单。

大约在2008年至2010年间，我们开始感受到交叉开关的压力，于是为其添加了仲裁功能以提高性能。

同时，还允许数据包在多个交叉开关平面上进行喷洒传输以获得更好性能。因此，我们必须在出口侧进行数据包重排序以保证数据包顺序。

这些就是一些架构上的变化。我们从外部存储器转向了片上存储器。

有一段时间DRAM很流行。现在我们更多地转回嵌入式静态RAM。这只是跟随硅技术发展的趋势。

但总的来说，定制ASIC的封装技术进步速度远不如硅本身。

因此，制造一个更大的芯片比连接多个较小的设备更便宜。

## 软件定义网络的影响 🤖

好的，谢谢。在课堂上，我们有一位演讲者谈到了SDN（软件定义网络）。

基本思想是向交换转发平面开放更多的可编程控制，无论是来自客户、网络所有者/运营商，还是其控制下的软件。

随着这种变化发生，交换机需要如何改变？你认为它们会如何改变？

这是一个有很大争议的点。

我最终认为，底层硬件不会像许多人想象的那样发生改变。

我们听到的关于SDN的一部分内容围绕OpenFlow展开。OpenFlow可能暗示底层硅芯片需要进行一些架构改变。

但我并不认为这会发生。

我认为底层硅芯片及其使用的字段和结构方式对我们来说已经工作得很好。

无论这是否通过集中式控制器来控制，我认为与是否使用OpenFlow完全正交。

然而，正在发生的另一件事，我认为比SDN更重要的是**网络虚拟化**。

这种虚拟化是通过**叠加技术**实现的。

有很多不同的叠加技术。VXLAN是一种，NVGRE是另一种，还有STT、LISP、FabricPath、TRILL等。这些技术层出不穷。

我认为行业会收敛到少数几种技术上。我有我的预测，但我们不深入讨论。

但我认为这种叠加技术确实为网络提供了根本价值。

而四年前制造的交换机可能无法实现它，或者无法大规模、高性能地实现它。

因此，我认为新的硬件将支持这些叠加技术，并持续改进叠加技术的功能。

## 行业前景与职业机会 💼

好的，谢谢。我想称之为SDN。当然。最后一个问题。

如果学生想了解更多关于交换机和路由器设计的知识，我是说，这个领域还有很多工作机会吗？它还是一个不断增长和扩张的领域吗？

我们听到各种说法，认为交换机和路由器的硬件侧正在变成一个更小的领域。我们看到很多人都去谷歌和Facebook工作了。

在这个领域工作仍然令人兴奋且有发展前景吗？

这是个有趣的问题。我从1985年就开始做这个了，时间很长。

期间有过非常激动人心的时期。当我们首次提出交换技术，行业正在兴起，互联网开始蓬勃发展，网络变得重要时，那是一段非常激动人心的时期。

然后，我认为有一段时期没有太多新事物发生。是的，我们要造更快的交换机，这里那里调整一些旋钮。那大概是2000年到2010年这段时间。

我认为我们现在正在经历一场变革。我认为，其中的催化剂实际上包括你们所做的一些工作，比如OpenFlow和整个SDN网络的理念，以及让我们实现虚拟化。

这项技术并非必然来自单一源头，而是在许多实验室中酝酿，现在真正爆发出来。

对我来说，再次进行互联网交换机设计在智力上具有挑战性，也非常有趣。

这项技术将会成熟并放缓，之后可能会有其他新事物出现。

在这个不断发展的行业中，开发自己硬件的公司越来越少。当然，思科还在做。瞻博网络开发了一些自己的硬件。

对于初创公司来说，获得资金开发新硬件非常困难，因此它们倾向于使用商用芯片。

所以，如果你想设计交换机硬件，我认为那个领域的机会变少了。

然而，我确实认为在那个领域还有一些非常有趣的事情可以做。就我个人而言，我很幸运能在一家初创公司工作，目前就在一家开发交换机硬件的初创公司。

我有一长串想做的事情清单，但我无法全部完成。我相信其他人也有关于可以在交换机硬件中实现的酷炫想法清单。

所以，并不是所有伟大的想法都被想到了。情况没那么糟，但也不像90年代末那样。

如果你有实习机会，请把详细信息发给我，我会转发给班级。我非常乐意雇佣实习生，我会招很多实习生。

好的，太好了。我们聊聊这个。非常感谢你，Tom。真的非常感谢。这非常有趣，提供了我们在课堂或教科书中通常无法获得的见解，非常有用。

谢谢。

好的，谢谢。期待很快再见到你。

## 总结 📝

本节课中，我们一起学习了交换机与路由器的设计演进。从基于总线的早期架构，到交叉开关和带仲裁的交换结构，硬件设计不断克服物理限制以满足性能需求。同时，软件定义网络和叠加虚拟化技术正在塑造网络的未来。尽管硬件设计的机会可能更加集中，但创新空间依然存在，网络领域持续经历着激动人心的变革。