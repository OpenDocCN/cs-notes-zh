# 6.4   TOY 虚拟机

> 原文：[`introcs.cs.princeton.edu/java/64simulator`](https://introcs.cs.princeton.edu/java/64simulator)
> 
> 译者：[飞龙](https://github.com/wizardforcel)
> 
> 协议：[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/)

本节正在大力施工中。

## 模拟器

. 假设我们有兴趣设计一台新的机器或微处理器。我们可以通过建立一个原型机器并在其上运行各种程序来测试它。另一种方法是在现有机器上编写一个程序，模拟新机器的行为。这有两个主要优点。首先，很容易扩展模拟器以增加额外的灵活性，例如添加调试工具或尝试不同的 ISA。其次，这比为新机器建立原型要便宜得多。

设计模拟器还有其他好处。假设我们的 TOY 机器已经被更强大的 NOTATOY 机器所淘汰。但是，我们已经用 TOY 语言编写了成千上万的程序，并且不愿意为 NOTATOY 重新编写它们。相反，我们可以在 NOTATOY 上为 TOY 机器构建一个模拟器。现在，我们可以通过在 TOY 模拟器上运行它们来在 NOTATOY 上运行我们所有现有的程序。正如您可能怀疑的那样，这种额外的模拟层会使我们的代码运行速度有所减慢。许多古老的程序目前仍在今天的计算机上运行，经过几层模拟。例如，仍然可以在 Microsoft Windows XP 下运行 Apple IIe 游戏 Lode Runner。

**Java 中的 TOY 模拟器。** 程序 TOY.java 是用 Java 编写的 TOY 模拟器。它读取一个 TOY 程序并*模拟*TOY 机器的行为。Java 程序使用数组来存储寄存器和主存储器。它还存储程序计数器。Java 程序读取 TOY 程序并修改寄存器、存储器和程序计数器的适当内容，就像 TOY 机器会修改其寄存器、存储器和程序计数器的方式一样。为 TOY 机器编写的任何程序最终都可以在 TOY 模拟器上使用，为 TOY 模拟器编写的任何程序也可以在 TOY 机器上使用，如果它被构建的话。

模拟器需要两个输入流 - 一个用于 TOY 程序，一个用于 TOY 标准输入。我们将操作系统的标准输入与 TOY 的标准输入关联起来，并直接从文件中读取 TOY 程序。为此，我们的程序接受一个命令行参数来指定文件的名称。然后，我们使用库 In.java 从文件中逐行读取数据。我们使用*正则表达式*来解析输入文件。我们将在第七章详细讨论正则表达式。该程序还使用两个辅助函数`toHex`和`fromHex`，用于将十六进制字符串转换为整数，反之亦然。

**Java 虚拟机。** Java 编译器`javac`将您的 Java 程序编译成一种机器语言程序，用于一台名为[Java 虚拟机规范](http://docs.oracle.com/javase/specs/jvms/se5.0/html/VMSpecTOC.doc.html)（JVM）的虚拟机。这台抽象机器有 229 个操作码，包括加法、除法、移位、异或、加载和存储等。当您运行`java`时，您正在模拟计算机上 JVM 的行为。

**翻译器。** 可以将任何特定的 TOY 程序翻译成 Java 程序。也就是说，给定一个 TOY 程序（例如，插入排序），编写一个执行相同操作的 Java 程序。这类似于将一本书从法语翻译成西班牙语。请注意，模拟不同于翻译。模拟器精确地逐行模仿原始机器的行为，而翻译器需要生成产生相同输出的代码，给定相同的输入。原则上，也可以将 Java 程序翻译成 TOY，但有点繁琐。

**引导**。我们现在考虑一个令人费解但具有重要实际意义的想法。由于将 Java 程序转换为 TOY 总是可能的，让我们将我们的 TOY 模拟器（用 Java 编写）转换为用 TOY 语言编写的程序！也就是说，我们创建一个模拟 TOY 机器本身的 TOY 程序。现在，我们可以修改 TOY 模拟器，例如，添加调试工具，或模拟 TOY 机器的变体。结果的 TOY 模拟器程序比原始的 TOY 机器“更强大”。这个想法被称为*引导*，一旦我们建立了一台机器，我们就可以用它来模拟“更强大”的机器。这个基本想法现在被用于所有新计算机的设计。根据苹果的网站“西摩·克雷，Cray Research 的创始人和几代超级计算机的鼻祖，听说苹果购买了一台 Cray 来模拟计算机设计。克雷感到好笑，评论说，有趣，我正在使用一台苹果来模拟 Cray-3。”

## 对偶。

代码和数据之间的对偶。

Code = 打印这个。 Data = 你好，世界。 Result = 打印"你好，世界"。

Code = 打印这个。 Data = 打印这个。 Result = 打印"打印这个"。

Code = 打印这个两次。 Data = 打印这个两次。 Result = 打印这个两次。 打印这个两次。

自我复制程序！在生物学中编码的对偶和自我复制：基因 = 指示符，蛋白质 = 被指示物。

#### 练习

#### 创意练习
