# è¯¾ç¨‹ P6ï¼šå®éªŒ 1 é—®ç­”ä¸ Go ç¼–ç¨‹æŠ€å·§ ğŸ—£ï¸ğŸ’»

![](img/2f0086836e72c092d2bf8ae8cc8e8252_1.png)

![](img/2f0086836e72c092d2bf8ae8cc8e8252_3.png)

åœ¨æœ¬èŠ‚è¯¾ä¸­ï¼Œæˆ‘ä»¬å°†å›é¡¾ MapReduce å®éªŒ 1 çš„è§£å†³æ–¹æ¡ˆï¼Œè®¨è®ºå¸¸è§çš„è®¾è®¡æ¨¡å¼ä¸é”™è¯¯ï¼Œå¹¶å­¦ä¹ ä¸€äº›é€šç”¨çš„ Go ç¼–ç¨‹æŠ€å·§ï¼Œä¸ºåç»­å®éªŒåšå¥½å‡†å¤‡ã€‚

## æ¦‚è¿°

![](img/2f0086836e72c092d2bf8ae8cc8e8252_5.png)

![](img/2f0086836e72c092d2bf8ae8cc8e8252_7.png)

æœ¬èŠ‚è¯¾å†…å®¹ä¸»è¦åŒ…æ‹¬ï¼š
1.  æ¼”ç¤ºä¸€ä¸ªå¯è¡Œçš„ MapReduce å®éªŒ 1 è§£å†³æ–¹æ¡ˆã€‚
2.  è®¨è®ºæ›¿ä»£çš„è§£å†³æ–¹æ¡ˆè®¾è®¡ã€‚
3.  åˆ†æå®éªŒä¸­å¸¸è§çš„é”™è¯¯å’Œ Bugã€‚
4.  æä¾›ä¸€äº›é€šç”¨çš„ç¼–ç¨‹æç¤ºã€‚
5.  è¿›è¡Œé—®ç­”ç¯èŠ‚ã€‚

---

![](img/2f0086836e72c092d2bf8ae8cc8e8252_9.png)

![](img/2f0086836e72c092d2bf8ae8cc8e8252_11.png)

## 1. å®éªŒè§£å†³æ–¹æ¡ˆæ¼”ç¤º ğŸ§ª

![](img/2f0086836e72c092d2bf8ae8cc8e8252_13.png)

![](img/2f0086836e72c092d2bf8ae8cc8e8252_15.png)

![](img/2f0086836e72c092d2bf8ae8cc8e8252_17.png)

![](img/2f0086836e72c092d2bf8ae8cc8e8252_19.png)

é¦–å…ˆï¼Œæˆ‘ä»¬é€æ­¥æ¼”ç¤ºä¸€ä¸ª MapReduce å®éªŒ 1 çš„è§£å†³æ–¹æ¡ˆã€‚è¿™ä¸ªæ–¹æ¡ˆä½¿ç”¨ RPC è¿›è¡Œ Worker å’Œ Coordinator ä¹‹é—´çš„é€šä¿¡ï¼Œå¹¶åˆ©ç”¨æ¡ä»¶å˜é‡è¿›è¡Œä»»åŠ¡è°ƒåº¦ã€‚

![](img/2f0086836e72c092d2bf8ae8cc8e8252_21.png)

![](img/2f0086836e72c092d2bf8ae8cc8e8252_23.png)

### ç¬¬ä¸€æ­¥ï¼šå®šä¹‰ RPC API

![](img/2f0086836e72c092d2bf8ae8cc8e8252_25.png)

é¦–å…ˆï¼Œåœ¨ `rpc.go` ä¸­å®šä¹‰ä»»åŠ¡ç±»å‹å’Œ RPC æ¥å£ã€‚

![](img/2f0086836e72c092d2bf8ae8cc8e8252_27.png)

```go
// ä»»åŠ¡ç±»å‹
type TaskType int
const (
    MapTask TaskType = iota
    ReduceTask
    DoneTask // è¡¨ç¤ºåè°ƒè€…å·²å®Œæˆ
)

![](img/2f0086836e72c092d2bf8ae8cc8e8252_29.png)

![](img/2f0086836e72c092d2bf8ae8cc8e8252_31.png)

// Worker è¯·æ±‚ä»»åŠ¡çš„ RPC å‚æ•°ä¸å›å¤
type GetTaskArgs struct {}
type GetTaskReply struct {
    TaskType    TaskType
    // ... å…¶ä»–ä»»åŠ¡æ‰€éœ€çš„å…ƒæ•°æ®ï¼Œå¦‚æ–‡ä»¶ã€Map/Reduce ä»»åŠ¡æ•°é‡ç­‰
}

// Worker é€šçŸ¥ä»»åŠ¡å®Œæˆçš„ RPC å‚æ•°
type FinishedTaskArgs struct {
    TaskType TaskType
    TaskId   int
}
type FinishedTaskReply struct {}
```

**æ ¸å¿ƒæ¦‚å¿µ**ï¼šå®šä¹‰æ¸…æ™°çš„ RPC æ¥å£æ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿé€šä¿¡çš„åŸºç¡€ã€‚

### ç¬¬äºŒæ­¥ï¼šå®ç° RPC å¤„ç†ç¨‹åº

åœ¨ Coordinator ä¸­å®ç° RPC çš„å¤„ç†ç¨‹åºã€‚Coordinator éœ€è¦ç»´æŠ¤çŠ¶æ€ï¼Œå¹¶ä½¿ç”¨äº’æ–¥é”ä¿æŠ¤å¹¶å‘è®¿é—®ã€‚

```go
type Coordinator struct {
    mu sync.Mutex
    // çŠ¶æ€ä¿¡æ¯ï¼šä»»åŠ¡æ–‡ä»¶ã€ä»»åŠ¡çŠ¶æ€ã€å®Œæˆæ ‡å¿—ç­‰
    mapFiles   []string
    mapTasks   []TaskStatus
    reduceTasks []TaskStatus
    nReduce    int
    done       bool
}

func (c *Coordinator) GetTask(args *GetTaskArgs, reply *GetTaskReply) error {
    c.mu.Lock()
    defer c.mu.Unlock()
    // æ£€æŸ¥å¹¶åˆ†é… Map æˆ– Reduce ä»»åŠ¡ï¼Œè‹¥å…¨éƒ¨å®Œæˆåˆ™è¿”å› DoneTask
    // ...
    return nil
}

func (c *Coordinator) FinishedTask(args *FinishedTaskArgs, reply *FinishedTaskReply) error {
    c.mu.Lock()
    defer c.mu.Unlock()
    // æ ¹æ® args.TaskType å’Œ args.TaskId æ›´æ–°å¯¹åº”ä»»åŠ¡çŠ¶æ€ä¸ºå®Œæˆ
    // ...
    return nil
}
```

**æ ¸å¿ƒæ¦‚å¿µ**ï¼šä½¿ç”¨ `sync.Mutex` å’Œ `defer` è¯­å¥å¯ä»¥å®‰å…¨ã€ç®€æ´åœ°ç®¡ç†å¯¹å…±äº«çŠ¶æ€çš„è®¿é—®ã€‚

### ç¬¬ä¸‰æ­¥ï¼šWorker å‘é€ RPC

Worker åœ¨ä¸€ä¸ªå¾ªç¯ä¸­å‘ Coordinator è¯·æ±‚ä»»åŠ¡ï¼Œå¹¶æ ¹æ®ä»»åŠ¡ç±»å‹æ‰§è¡Œç›¸åº”æ“ä½œã€‚

```go
func Worker() {
    for {
        args := GetTaskArgs{}
        reply := GetTaskReply{}
        callCoordinator("Coordinator.GetTask", &args, &reply)

        switch reply.TaskType {
        case MapTask:
            performMap(reply.MapFile, reply.NReduce)
            callCoordinator("Coordinator.FinishedTask", &FinishedTaskArgs{TaskType: MapTask, TaskId: reply.TaskId}, &FinishedTaskReply{})
        case ReduceTask:
            performReduce(reply.ReduceId, reply.NMap)
            callCoordinator("Coordinator.FinishedTask", &FinishedTaskArgs{TaskType: ReduceTask, TaskId: reply.TaskId}, &FinishedTaskReply{})
        case DoneTask:
            return // é€€å‡º Worker
        }
    }
}
```

**æ ¸å¿ƒæ¦‚å¿µ**ï¼šWorker çš„æ ¸å¿ƒé€»è¾‘æ˜¯ä¸€ä¸ªç®€å•çš„â€œè¯·æ±‚-æ‰§è¡Œ-æŠ¥å‘Šâ€å¾ªç¯ã€‚

### ç¬¬å››æ­¥ï¼šå®ç°æ–‡ä»¶ç®¡ç†

å®ç°è¾…åŠ©å‡½æ•°æ¥åŸå­æ€§åœ°é‡å‘½åä¸­é—´æ–‡ä»¶ï¼Œé˜²æ­¢å†²çªã€‚

```go
func finalizeFile(tmpFile string, finalFile string) error {
    return os.Rename(tmpFile, finalFile)
}
```

### ç¬¬äº”æ­¥ï¼šå®ç° Map å’Œ Reduce å‡½æ•°

`performMap` å‡½æ•°è¯»å–è¾“å…¥æ–‡ä»¶ï¼Œåº”ç”¨ç”¨æˆ·å®šä¹‰çš„ map å‡½æ•°ï¼Œå¹¶å°†è¾“å‡ºå†™å…¥ä¸­é—´æ–‡ä»¶ã€‚`performReduce` å‡½æ•°è¯»å–å±äºå…¶åˆ†åŒºï¼ˆreduce IDï¼‰çš„æ‰€æœ‰ä¸­é—´æ–‡ä»¶ï¼Œå¯¹é”®è¿›è¡Œæ’åºï¼Œç„¶ååº”ç”¨ reduce å‡½æ•°ã€‚

```go
func performMap(filename string, nReduce int) {
    // 1. è¯»å–æ–‡ä»¶å†…å®¹
    // 2. è°ƒç”¨ç”¨æˆ· map å‡½æ•°ï¼Œç”Ÿæˆé”®å€¼å¯¹åˆ—è¡¨
    // 3. æ ¹æ®é”®çš„å“ˆå¸Œå°†é”®å€¼å¯¹åˆ†åŒºåˆ° nReduce ä¸ªä¸´æ—¶æ–‡ä»¶ä¸­
    // 4. åŸå­é‡å‘½åä¸´æ—¶æ–‡ä»¶ä¸ºæœ€ç»ˆä¸­é—´æ–‡ä»¶
}

func performReduce(reduceId int, nMap int) {
    // 1. è¯»å–æ‰€æœ‰ Map ä»»åŠ¡ç”Ÿæˆçš„ã€å±äºæ­¤ reduceId çš„ä¸­é—´æ–‡ä»¶
    // 2. å¯¹æ‰€æœ‰é”®å€¼å¯¹æŒ‰é”®æ’åº
    // 3. å¯¹æ¯ä¸ªé”®ï¼Œæ”¶é›†å…¶æ‰€æœ‰å€¼ï¼Œè°ƒç”¨ç”¨æˆ· reduce å‡½æ•°
    // 4. å°†ç»“æœå†™å…¥ä¸´æ—¶è¾“å‡ºæ–‡ä»¶ï¼Œç„¶ååŸå­é‡å‘½åä¸ºæœ€ç»ˆè¾“å‡ºæ–‡ä»¶
}
```

**æ ¸å¿ƒæ¦‚å¿µ**ï¼šMap é˜¶æ®µè¿›è¡Œâ€œåˆ†è€Œæ²»ä¹‹â€ï¼ŒReduce é˜¶æ®µè¿›è¡Œâ€œæ±‡æ€»å½’çº¦â€ã€‚

### ç¬¬å…­æ­¥ï¼šå®ç° Coordinator çš„ä»»åŠ¡è°ƒåº¦

è¿™æ˜¯ Coordinator æœ€å¤æ‚çš„éƒ¨åˆ†ï¼Œè´Ÿè´£ç»™ Worker åˆ†é…ä»»åŠ¡ï¼Œå¹¶å¤„ç†è¶…æ—¶ä¸é‡è¯•ã€‚ä¸€ç§å®ç°æ–¹å¼æ˜¯ä½¿ç”¨æ¡ä»¶å˜é‡æ¥ç­‰å¾…å¯åˆ†é…çš„ä»»åŠ¡å‡ºç°ã€‚

```go
func (c *Coordinator) scheduleTasks() {
    c.mu.Lock()
    // é¦–å…ˆåˆ†é…æ‰€æœ‰ Map ä»»åŠ¡
    for !c.allMapTasksDone() {
        if taskId := c.findAvailableMapTask(); taskId != -1 {
            // æ‰¾åˆ°ä»»åŠ¡ï¼Œåˆ†é…ç»™ Worker (é€šè¿‡ RPC å›å¤)
            c.assignMapTask(taskId)
            // å¯åŠ¨ä¸€ä¸ª goroutine æ¥ç›‘æ§æ­¤ä»»åŠ¡è¶…æ—¶
            go c.monitorTask(MapTask, taskId)
        } else {
            // æ²¡æœ‰ç«‹å³å¯ç”¨çš„ Map ä»»åŠ¡ï¼Œç­‰å¾…ï¼ˆæ¡ä»¶å˜é‡ï¼‰
            c.cond.Wait()
        }
    }
    // æ‰€æœ‰ Map ä»»åŠ¡å®Œæˆåï¼Œå¼€å§‹åˆ†é… Reduce ä»»åŠ¡
    for !c.allReduceTasksDone() {
        if taskId := c.findAvailableReduceTask(); taskId != -1 {
            c.assignReduceTask(taskId)
            go c.monitorTask(ReduceTask, taskId)
        } else {
            c.cond.Wait()
        }
    }
    c.done = true
    c.mu.Unlock()
}

![](img/2f0086836e72c092d2bf8ae8cc8e8252_33.png)

// ç›‘æ§ä»»åŠ¡è¶…æ—¶çš„ goroutine
func (c *Coordinator) monitorTask(taskType TaskType, taskId int) {
    time.Sleep(TaskTimeout)
    c.mu.Lock()
    defer c.mu.Unlock()
    if !c.isTaskDone(taskType, taskId) {
        // ä»»åŠ¡è¶…æ—¶æœªå®Œæˆï¼Œé‡ç½®çŠ¶æ€ä»¥ä¾¿é‡æ–°åˆ†é…
        c.resetTask(taskType, taskId)
        c.cond.Broadcast() // å”¤é†’è°ƒåº¦å¾ªç¯
    }
}

![](img/2f0086836e72c092d2bf8ae8cc8e8252_35.png)

// åœ¨ FinishedTask RPC å¤„ç†ç¨‹åºä¸­ï¼Œå®Œæˆä»»åŠ¡åä¹Ÿå‘å‡ºå¹¿æ’­
func (c *Coordinator) FinishedTask(args *FinishedTaskArgs, reply *FinishedTaskReply) error {
    c.mu.Lock()
    defer c.mu.Unlock()
    c.markTaskDone(args.TaskType, args.TaskId)
    c.cond.Broadcast() // å”¤é†’è°ƒåº¦å¾ªç¯ï¼Œå¯èƒ½ç°åœ¨æœ‰ä»»åŠ¡å¯åˆ†é…äº†
    return nil
}
```

**æ ¸å¿ƒæ¦‚å¿µ**ï¼šæ¡ä»¶å˜é‡ `sync.Cond` é€‚ç”¨äºç­‰å¾…æŸä¸ªç‰¹å®šæ¡ä»¶ï¼ˆå¦‚â€œæœ‰ä»»åŠ¡å¯åˆ†é…â€ï¼‰å˜ä¸ºçœŸï¼Œæ¯”å¾ªç¯ç¡çœ æ›´é«˜æ•ˆã€‚

---

ä¸Šä¸€èŠ‚æˆ‘ä»¬ä»‹ç»äº†ä¸€ä¸ªåŸºäºæ¡ä»¶å˜é‡çš„ Coordinator è°ƒåº¦å®ç°ï¼Œæœ¬èŠ‚ä¸­æˆ‘ä»¬æ¥çœ‹çœ‹å…¶ä»–å¯èƒ½çš„è®¾è®¡æ–¹æ¡ˆã€‚

## 2. æ›¿ä»£è§£å†³æ–¹æ¡ˆè®¾è®¡ ğŸ”„

é™¤äº†ä½¿ç”¨æ¡ä»¶å˜é‡ï¼Œè¿˜å¯ä»¥è€ƒè™‘å…¶ä»–åŒæ­¥å’Œé€šä¿¡æ¨¡å¼ã€‚

### è®¾è®¡ä¸€ï¼šWorker ä¾§ä¸»åŠ¨è½®è¯¢

åœ¨è¿™ç§è®¾è®¡ä¸­ï¼Œå¦‚æœ Coordinator æ²¡æœ‰ä»»åŠ¡å¯åˆ†é…ï¼Œå®ƒä¼šç«‹å³è¿”å›ä¸€ä¸ªâ€œæ— ä»»åŠ¡â€çš„å›å¤ã€‚Worker åœ¨æ”¶åˆ°æ­¤å›å¤åï¼Œç­‰å¾…ä¸€æ®µæ—¶é—´å†é‡æ–°è¯·æ±‚ã€‚

*   **ä¼˜ç‚¹**ï¼šCoordinator é€»è¾‘ç®€å•ï¼Œä¸ä¼šé˜»å¡åœ¨ RPC å¤„ç†ç¨‹åºä¸­ã€‚
*   **ç¼ºç‚¹**ï¼šäº§ç”Ÿæ›´å¤šç½‘ç»œ RPC æµé‡ï¼›Worker çš„ç­‰å¾…æ—¶é—´å¯èƒ½ä¸å¤Ÿé«˜æ•ˆã€‚

### è®¾è®¡äºŒï¼šä½¿ç”¨ Channel è¿›è¡Œä»»åŠ¡é˜Ÿåˆ—

å¯ä»¥åˆ©ç”¨ Go çš„ Channel ä½œä¸ºä»»åŠ¡é˜Ÿåˆ—å’Œç”Ÿäº§-æ¶ˆè´¹è€…æ¨¡å‹ã€‚ä»¥ä¸‹æ˜¯ä¸€ä¸ªæ¦‚å¿µæ€§ç¤ºä¾‹ï¼Œå±•ç¤ºäº† Channel çš„æ½œåœ¨ç”¨æ³•ï¼š

```go
func CoordinatorWithChannels(taskChan chan Task, workerChan chan int) {
    // å°†åˆå§‹ä»»åŠ¡æ¨å…¥ taskChan
    for i := 0; i < numTasks; i++ {
        taskChan <- Task{Id: i}
    }

    // ç›‘å¬ worker åŠ å…¥
    go func() {
        for workerId := range workerChan {
            go func(wId int) {
                for task := range taskChan { // ä»é€šé“å–ä»»åŠ¡
                    if callWorker(wId, task) {
                        // ä»»åŠ¡æˆåŠŸï¼Œé€šçŸ¥å®Œæˆ
                        doneChan <- task.Id
                    } else {
                        // ä»»åŠ¡å¤±è´¥ï¼Œé‡æ–°æ”¾å›é˜Ÿåˆ—
                        taskChan <- task
                    }
                }
            }(workerId)
        }
    }()

    // ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆ
    for completed := 0; completed < numTasks; completed++ {
        <-doneChan
    }
    close(taskChan) // å…³é—­é€šé“ï¼Œä½¿ worker goroutine é€€å‡º
}
```

**æ ¸å¿ƒæ¦‚å¿µ**ï¼šChannel éå¸¸é€‚åˆç”¨äº goroutine ä¹‹é—´çš„æ¶ˆæ¯ä¼ é€’å’Œé˜Ÿåˆ—ç®¡ç†ï¼Œèƒ½ç®€åŒ–æŸäº›åœºæ™¯ä¸‹çš„åŒæ­¥é€»è¾‘ã€‚ä½†åœ¨ä¿æŠ¤å¤æ‚å…±äº«çŠ¶æ€æ—¶ï¼Œäº’æ–¥é”å¯èƒ½æ›´ç›´è§‚ã€‚

---

## 3. å¸¸è§è®¾è®¡é”™è¯¯ä¸ Bug ğŸ›

åœ¨å®ç°è¿‡ç¨‹ä¸­ï¼Œéœ€è¦æ³¨æ„ä»¥ä¸‹å‡ ç‚¹ï¼š

ä»¥ä¸‹æ˜¯å®éªŒä¸­ä¸€äº›å¸¸è§çš„é™·é˜±ï¼š

1.  **Coordinator è¿‡è½½**ï¼šå°†æœ¬åº”ç”± Worker æ‰§è¡Œçš„å·¥ä½œï¼ˆå¦‚æ’åºã€è¯»å–å¤§é‡æ–‡ä»¶å†…å®¹ï¼‰æ”¾åœ¨ Coordinatorï¼Œä½¿å…¶æˆä¸ºç“¶é¢ˆã€‚MapReduce çš„ä¼˜åŠ¿åœ¨äºå°†è®¡ç®—åˆ†æ•£åˆ° Workerã€‚
2.  **RPC è®¾è®¡å†—ä½™**ï¼šè®¾è®¡è¿‡å¤šæˆ–è¿‡äºç»†ç²’åº¦çš„ RPC è°ƒç”¨ï¼ˆä¾‹å¦‚ï¼Œå…ˆè¯¢é—®æ˜¯å¦æœ‰ä»»åŠ¡ï¼Œå†è¯·æ±‚ä»»åŠ¡ï¼‰ã€‚åº”ç²¾ç®€ APIã€‚
3.  **åŒæ­¥é”™è¯¯**ï¼š
    *   åœ¨å¯èƒ½é˜»å¡çš„æ“ä½œï¼ˆå¦‚ç½‘ç»œ RPCã€Channel æ“ä½œï¼‰æœŸé—´æŒæœ‰é”ï¼Œå¯¼è‡´æ•´ä¸ªç¨‹åºåœæ»ã€‚
    *   è¯¯ä»¥ä¸ºä¸åŒæœºå™¨ä¸Šçš„é”ï¼ˆæˆ– Channelï¼‰å¯ä»¥è·¨è¿›ç¨‹åŒæ­¥ã€‚åŒæ­¥åŸè¯­ä»…ç”¨äºåè°ƒ**åŒä¸€è¿›ç¨‹å†…**çš„å¤šä¸ªçº¿ç¨‹ã€‚
4.  **â€œè‰¯æ€§â€æ•°æ®ç«äº‰**ï¼šå³ä½¿ä½ è®¤ä¸ºæŸä¸ªå˜é‡ï¼ˆå¦‚ `isDone`ï¼‰çš„è¯»å†™ç«äº‰æ˜¯å®‰å…¨çš„ï¼Œä¹Ÿ**å¿…é¡»**ä½¿ç”¨åŒæ­¥æœºåˆ¶ï¼ˆå¦‚é”æˆ– `atomic` æ“ä½œï¼‰ã€‚æœªå®šä¹‰è¡Œä¸ºå¯èƒ½å¯¼è‡´éš¾ä»¥è°ƒè¯•çš„é—®é¢˜ã€‚
5.  **è¶…æ—¶å¤„ç†ä¸å®Œå–„**ï¼šæœªæ­£ç¡®å¤„ç†ä»»åŠ¡è¶…æ—¶å’Œé‡è¯•ï¼Œæˆ–é‡è¯•é€»è¾‘å¯¼è‡´ä»»åŠ¡è¢«é‡å¤æ‰§è¡Œã€‚

---

## 4. é€šç”¨ç¼–ç¨‹æç¤ºä¸æŠ€å·§ ğŸ’¡

ä»¥ä¸‹æŠ€å·§æœ‰åŠ©äºæé«˜æœªæ¥å®éªŒçš„ç¼–ç å’Œè°ƒè¯•æ•ˆç‡ï¼š

1.  **æ¡ä»¶è°ƒè¯•è¾“å‡º**ï¼šä½¿ç”¨ç±»ä¼¼ `DPrintf` çš„å‡½æ•°ï¼Œæ–¹ä¾¿åœ¨è°ƒè¯•æ—¶è¾“å‡ºä¿¡æ¯ï¼Œæäº¤æ—¶æ— éœ€æ³¨é‡Šå¤§é‡ `printf`ã€‚
    ```go
    func DPrintf(format string, a ...interface{}) (n int, err error) {
        if Debug {
            log.Printf(format, a...)
        }
        return
    }
    ```
2.  **æ£€æŸ¥ Goroutine**ï¼šåœ¨ç¨‹åºè¿è¡Œæ—¶ï¼Œå¯ä»¥æŒ‰ `Ctrl-\`ï¼ˆUnixï¼‰æ¥æŸ¥çœ‹æ‰€æœ‰è¿è¡Œä¸­çš„ goroutine åŠå…¶å †æ ˆï¼Œå¸®åŠ©è¯Šæ–­æ­»é”æˆ–é˜»å¡ã€‚
3.  **å–„ç”¨ `defer`**ï¼š`defer` è¯­å¥èƒ½ç¡®ä¿å‡½æ•°è¿”å›å‰æ‰§è¡Œæ¸…ç†ï¼ˆå¦‚è§£é”ï¼‰ã€‚æ³¨æ„å¤šä¸ª `defer` çš„æ‰§è¡Œé¡ºåºæ˜¯åè¿›å…ˆå‡ºï¼ˆLIFOï¼‰ã€‚
4.  **ä»£ç ç»„ç»‡**ï¼šå°†ä»£ç æŒ‰åŠŸèƒ½åˆ†åˆ°ä¸åŒæ–‡ä»¶ï¼ˆå¦‚ `rpc.go`, `coordinator.go`, `worker.go`ï¼‰ã€‚å°†é‡å¤é€»è¾‘æå–ä¸ºå‡½æ•°ï¼ˆå¦‚ Raft ä¸­æ£€æŸ¥ä»»æœŸå¹¶é‡ç½®çŠ¶æ€çš„é€»è¾‘ï¼‰ã€‚
5.  **ç¼–è¾‘å™¨ä¸ç¯å¢ƒ**ï¼šé…ç½®ä¸€ä¸ªå¸¦æœ‰è‡ªåŠ¨è¡¥å…¨ã€ä»£ç å¯¼èˆªåŠŸèƒ½çš„å¼€å‘ç¯å¢ƒï¼Œå¯ä»¥å¤§å¹…æå‡æ•ˆç‡ã€‚

---

## 5. é—®ç­”ç¯èŠ‚ç²¾é€‰ â“

ä»¥ä¸‹æ˜¯å¯¹è¯¾ç¨‹ä¸­éƒ¨åˆ†é—®é¢˜çš„è§£ç­”ï¼š

*   **Qï¼šMapReduce é€‚ç”¨äºæ›´å¤æ‚çš„è®¡ç®—å—ï¼Ÿ**
    *   Aï¼šæ˜¯çš„ã€‚MapReduce æ¨¡å‹å¯ç”¨äºçŸ©é˜µä¹˜æ³•ã€æœºå™¨å­¦ä¹ ç­‰å¤æ‚è®¡ç®—ã€‚åç»§ç³»ç»Ÿå¦‚ Sparkã€Google Dataflow æä¾›äº†æ›´çµæ´»çš„æ•°æ®æµå›¾è®¡ç®—æ¨¡å‹ã€‚
*   **Qï¼šCoordinator å¦‚ä½•å®¹é”™ï¼Ÿ**
    *   Aï¼šåŸå§‹è®ºæ–‡ä½¿ç”¨ç®€å•çš„æ£€æŸ¥ç‚¹æœºåˆ¶ã€‚å¯¹äºéœ€è¦å¼ºä¸€è‡´æ€§çš„åœºæ™¯ï¼Œå¯ä»¥ä½¿ç”¨ Raft å¤åˆ¶çŠ¶æ€æœºæ¥å®ç°ä¸€ç»„é«˜å¯ç”¨çš„ Coordinatorã€‚
*   **Qï¼šä¸ºä»€ä¹ˆ Mapper åœ¨æœ¬åœ°å†™æ–‡ä»¶ï¼Ÿ**
    *   Aï¼šåœ¨ MapReduce è®ºæ–‡å‘è¡¨çš„å¹´ä»£ï¼Œç½‘ç»œå¸¦å®½æ˜¯ç“¶é¢ˆã€‚æœ¬åœ°å†™å‡å°‘ç½‘ç»œä¼ è¾“ã€‚è¾“å‡ºé˜¶æ®µæ‰å†™å…¥åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿï¼ˆå¦‚ GFSï¼‰ã€‚
*   **Qï¼šå¦‚ä½•é€‰æ‹©è¶…æ—¶æ—¶é—´ï¼Ÿ**
    *   Aï¼šåœ¨ MapReduce å®éªŒ 1 ä¸­ï¼Œ10ç§’çš„ä»»åŠ¡è¶…æ—¶æ˜¯åˆç†çš„ã€‚åœ¨ Raft å®éªŒä¸­ï¼Œé€‰ä¸¾è¶…æ—¶éœ€è¦ä»”ç»†é€‰æ‹©ï¼ˆä¾‹å¦‚ 150-300ms èŒƒå›´ï¼‰ï¼Œéœ€è€ƒè™‘å¿ƒè·³é—´éš”ï¼Œå¹¶åŠ å…¥éšæœºæ€§ä»¥é˜²æ­¢åŒæ—¶é€‰ä¸¾ã€‚
*   **Qï¼šå¯ä»¥æ··åˆä½¿ç”¨é”å’Œ Channel å—ï¼Ÿ**
    *   Aï¼šå½“ç„¶å¯ä»¥ã€‚é”é€‚åˆä¿æŠ¤å¤æ‚çš„å…±äº«çŠ¶æ€ï¼ŒChannel é€‚åˆ goroutine é—´çš„é€šä¿¡å’Œç‰¹å®šç±»å‹çš„åŒæ­¥ï¼ˆå¦‚ç­‰å¾…äº‹ä»¶ï¼‰ã€‚Raft å®ç°ä¸­é€šå¸¸ä¼šåŒæ—¶ä½¿ç”¨ä¸¤è€…ã€‚
*   **Qï¼šå¦‚ä½•å¹²å‡€åœ°å…³é—­è¿›ç¨‹ï¼Ÿ**
    *   Aï¼šä¸€ç§ç®€å•æ–¹æ³•æ˜¯ Coordinator åœ¨å®Œæˆåï¼Œä¸å†å“åº” Worker çš„ RPCã€‚Worker å‘ç°è¿æ¥é”™è¯¯åè‡ªè¡Œé€€å‡ºã€‚ä¹Ÿå¯ä»¥å®šä¹‰æ˜ç¡®çš„é€€å‡º RPCã€‚

---

## æ€»ç»“

![](img/2f0086836e72c092d2bf8ae8cc8e8252_37.png)

![](img/2f0086836e72c092d2bf8ae8cc8e8252_39.png)

![](img/2f0086836e72c092d2bf8ae8cc8e8252_41.png)

æœ¬èŠ‚è¯¾ä¸­æˆ‘ä»¬ä¸€èµ·å­¦ä¹ äº† MapReduce å®éªŒ 1 çš„ä¸€ä¸ªå®Œæ•´è§£å†³æ–¹æ¡ˆï¼Œå…¶æ ¸å¿ƒåœ¨äºé€šè¿‡ RPC å®ç° Worker ä¸ Coordinator çš„é€šä¿¡ï¼Œå¹¶åˆ©ç”¨æ¡ä»¶å˜é‡è¿›è¡Œæœ‰æ•ˆçš„ä»»åŠ¡è°ƒåº¦ä¸å®¹é”™å¤„ç†ã€‚æˆ‘ä»¬è¿˜æ¢è®¨äº†ä¸åŒçš„è®¾è®¡é€‰æ‹©ï¼Œåˆ†æäº†å¸¸è§é”™è¯¯ï¼Œå¹¶æŒæ¡äº†ä¸€äº›å®ç”¨çš„ Go ç¼–ç¨‹å’Œè°ƒè¯•æŠ€å·§ã€‚ç†è§£è¿™äº›æ¦‚å¿µå°†ä¸ºåç»­æ›´å¤æ‚çš„åˆ†å¸ƒå¼ç³»ç»Ÿå®éªŒï¼ˆå¦‚ Raftï¼‰æ‰“ä¸‹åšå®çš„åŸºç¡€ã€‚