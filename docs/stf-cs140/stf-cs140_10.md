# 目录和链接

CS 140 课程讲义

2014 年春季

约翰·奥斯特豪特

+   此主题的阅读材料来自《操作系统：原理与实践》：第 13.1-13.2 节。

+   命名：用户如何引用他们的文件？操作系统如何根据名称找到文件？

+   第一步：文件描述符必须存储在磁盘上，以便它在系统重新启动后仍然存在。

+   早期的 UNIX 版本：所有描述符都存储在固定大小的数组中。

+   最初，整个描述符数组位于磁盘的外缘。结果：描述符和文件数据之间的长时间查找。

+   后来的改进：

    +   将描述符数组放在磁盘中间。

    +   许多小的描述符数组分布在磁盘上，因此描述符可以靠近文件数据。

+   磁盘初始化时，描述符的空间是固定的，无法更改。

+   UNIX/Linux/Pintos 术语：

    +   文件描述符称为*i-节点*

    +   描述符数组中的 i-节点索引：*i-编号*。操作系统内部使用 i-编号作为文件的标识符。

+   当文件打开时，其描述符保存在主存储器中。当文件关闭时，描述符会存储回磁盘。

+   文件命名：用户希望使用文本名称引用文件。使用称为*目录*的特殊磁盘结构将名称映射到描述符索引。

+   目录管理的早期方法：

    +   整个磁盘只有一个目录：

        +   如果一个用户使用特定名称，则其他人都不能使用。

        +   许多早期个人计算机是这样工作的。

    +   每个用户只有一个目录（例如 TOPS-10）：

        +   避免用户之间的问题，但仍然使信息组织变得困难。

+   现代系统支持分层目录结构。UNIX/Linux 方法：

    +   目录与常规文件一样存储在磁盘上（即，文件描述符具有 14 个指针等），只是文件描述符设置了特殊标志位以指示它是一个目录。

    +   每个目录以无特定顺序包含<*名称*，*i-编号*>对。

    +   i-编号指向的文件可能是另一个目录。因此，得到层次树结构。名称使用斜杠分隔树的级别。

    +   有一个特殊的目录，称为*根目录*。这个目录没有名字；它的 i-编号为 2（i-编号 0 和 1 有其他特殊用途）。

    +   在某些系统上，用户程序可以像常规文件一样读取目录。

    +   只有操作系统可以写入目录。

## 工作目录

+   不断为所有文件指定完整路径名是很繁琐的。

+   让操作系统记住每个进程一个特殊的目录，称为*工作目录*。

+   如果文件名不以"/"开头，则从工作目录开始查找。

+   以"/"开头的名称从根目录开始查找。

## 链接

+   *UNIX 硬链接*：

    +   可能有多个目录条目指向单个文件。

    +   UNIX 使用文件描述符中的引用计数来跟踪引用文件的硬链接。

    +   当最后一个目录条目消失时，文件被删除。

    +   必须防止循环。

+   *符号链接*：

    +   一个内容是另一个文件名的文件。

    +   存储在磁盘上，像普通文件一样，但在描述符中设置了特殊标志。

    +   如果在文件查找过程中遇到符号链接，则切换到符号链接中指定的目标，然后从那里继续查找。
