![](img/33217b811ad54c2601acdb4f3b66753a_0.png)

# GAMES203：三维重建和理解 - P4：Lecture 4 运动恢复结构 (Structure From Motion) 📸

![](img/33217b811ad54c2601acdb4f3b66753a_0.png)

在本节课中，我们将要学习如何仅从一组二维图像中恢复三维场景的结构和相机的运动姿态。这个过程被称为运动恢复结构。

上一节我们介绍了基于深度信息（RGB-D）的重建方法。本节和下节课，我们将探讨如何直接从普通图像（RGB）开始，例如从网上下载的图片，来重建一个稀疏的三维点云模型。

## 图像形成的几何模型 📐

首先，我们需要理解图像是如何生成的，或者说图像中的像素与三维空间中的物体点之间存在什么关系。这部分内容属于计算机视觉中的几何基础。

### 投影模型

一个三维点如何投影到二维图像平面上？这通常通过针孔相机模型来描述。它是一种简单的透视投影变换。

假设我们有一个三维点 **X** = (X, Y, Z)^T。它通过一个相机投影到图像平面上的点 **x** = (x, y)^T。这个过程可以表示为：

**x** = f * (X / Z)
**y** = f * (Y / Z)

其中，**f** 是相机的焦距。这个公式表明，深度信息 **Z** 在投影过程中被丢失了。一个图像点实际上对应着三维空间中穿过相机光心的一条射线上的所有点。

### 齐次坐标表示

为了更方便地进行数学计算（特别是处理无穷远点和平行线相交等问题），我们引入齐次坐标。

在齐次坐标下，一个二维图像点 **x** = (x, y)^T 被表示为 **x̃** = (x, y, 1)^T。一个三维点 **X** = (X, Y, Z)^T 被表示为 **X̃** = (X, Y, Z, 1)^T。

使用齐次坐标，投影过程可以写成一个线性矩阵乘法：

**λ * x̃** = **P * X̃**

其中，**λ** 是一个非零尺度因子，**P** 是一个 3x4 的投影矩阵。**P** 可以进一步分解为：

**P** = **K * [R | t]**

这里：
*   **K** 是 3x3 的内参矩阵，包含焦距 **f**、主点坐标 **(cx, cy)** 等参数。
*   **[R | t]** 是 3x4 的外参矩阵，其中 **R** 是 3x3 的旋转矩阵，**t** 是 3x1 的平移向量，共同描述了相机在世界坐标系中的姿态（位置和方向）。

这个方程 **λ * x̃ = K * [R | t] * X̃** 是 SFM 中最核心的几何关系。

## 两视图几何与本质矩阵 🔄

上一节我们介绍了相机投影的通用模型。本节中我们来看看，当给定两个不同视角拍摄的图像时，我们能推导出什么。

### 问题定义

假设我们有两个图像（视图），并且知道一些在两个图像中匹配的二维特征点对（对应点）。我们的目标是估计这两个相机之间的相对运动（旋转 **R** 和平移 **t**），以及这些匹配点在三维空间中的位置。

首先，我们假设相机的内参矩阵 **K** 是已知的（后续会讲如何估计）。这样，我们可以将图像坐标归一化：**x̂ = K⁻¹ * x̃**。归一化坐标 **x̂** 对应于焦距归一化后的图像平面上的点。

### 推导本质矩阵

在两个视图下，对于一对匹配的归一化图像点 **x̂₁** 和 **x̂₂**，以及它们对应的（未知的）三维点 **X**，存在以下关系：

**λ₂ * x̂₂ = R * (λ₁ * x̂₁) + t**

其中 **λ₁** 和 **λ₂** 分别是该点在两个相机坐标系下的深度。

通过一系列消去 **λ₁** 和 **λ₂** 的代数运算（利用向量叉积的性质），我们可以得到一个非常简洁的约束方程：

**x̂₂ᵀ * E * x̂₁ = 0**

其中，**E** 被称为本质矩阵。它与相机的外参有直接关系：

**E = [t]ₓ * R**

这里 **[t]ₓ** 是平移向量 **t** 的反对称矩阵（skew-symmetric matrix）。

这个方程 **x̂₂ᵀ * E * x̂₁ = 0** 是两视图几何的基石。它表明，已知匹配点对和相机内参，我们可以求解本质矩阵 **E**。

### 八点法求解本质矩阵

给定足够多的匹配点对，我们如何求解 **E**？以下是经典的八点法步骤：

1.  **构建线性方程组**：将方程 **x̂₂ᵀ * E * x̂₁ = 0** 展开，可以写成关于 **E** 的9个元素的线性方程：**A * e = 0**，其中 **e** 是将 **E** 按行展开成的9维向量。
2.  **求解线性系统**：由于尺度不确定性，我们通常约束 **||e|| = 1**。这转化为求解 **AᵀA** 的最小特征值对应的特征向量问题。至少需要8对匹配点（故称八点法）来得到唯一解。
3.  **强制本质矩阵约束**：通过线性八点法求得的矩阵可能不满足本质矩阵的内在约束（其奇异值应为 [σ, σ, 0] 的形式）。因此，我们需要对求得的矩阵进行投影：对其进行奇异值分解（SVD）**E = U * diag(σ₁, σ₂, σ₃) * Vᵀ**，然后将其替换为 **E‘ = U * diag((σ₁+σ₂)/2, (σ₁+σ₂)/2, 0) * Vᵀ**。
4.  **从本质矩阵恢复运动**：从投影后的 **E‘** 可以通过SVD分解恢复出相机的旋转 **R** 和平移 **t**。注意，这会得到四种可能的解，需要通过检查点的深度为正（位于相机前方）来选出唯一正确的解。

## 相机标定 🎯

前面我们假设相机内参 **K** 已知。那么如何获取 **K** 呢？这个过程称为相机标定。

### 使用标定板

一种常见的方法是使用已知图案的标定板（例如棋盘格）。以下是标定步骤：

1.  **采集数据**：从不同角度拍摄多张标定板的图像。
2.  **检测角点**：在每张图像中自动检测标定板上角点的像素坐标 **(x, y)**。
3.  **建立方程**：由于我们知道标定板上每个角点的世界坐标 **(X, Y, Z)**（通常设标定板平面为 Z=0），对于每个角点，我们可以建立投影方程：**s * [x, y, 1]ᵀ = K * [R | t] * [X, Y, 0, 1]ᵀ**。
4.  **求解投影矩阵**：上述方程可以转化为关于投影矩阵 **P**（即 **K[R|t]**）元素的线性方程组。每对点提供两个方程，**P** 有11个自由度，因此至少需要6个角点（提供12个方程）来求解。
5.  **分解内参和外参**：得到 **P** 后，可以通过矩阵分解（例如RQ分解，类似于QR分解）将其分解为内参矩阵 **K** 和外参 **[R | t]**。

## 从基础矩阵到运动恢复结构 🌉

如果不已知内参，我们可以直接从一个更一般的矩阵——基础矩阵 **F** 开始。

### 基础矩阵

基础矩阵 **F** 描述了两个未标定图像之间的几何关系。它与本质矩阵 **E** 的关系为：

**F = K₂⁻ᵀ * E * K₁⁻¹**

对应的极线约束方程为：

**x₂ᵀ * F * x₁ = 0**

其中 **x₁**, **x₂** 是原始像素坐标（非归一化坐标）。同样可以使用八点法来估计 **F**。

### 多视图重建流程

在实际应用中，我们通常有大量图像。一个经典的SFM流程（如Photo Tourism系统所示）如下：

以下是核心步骤：

1.  **特征提取与匹配**：对所有图像提取局部特征（如SIFT），并匹配图像对之间的特征点。
2.  **估计几何**：对每一对匹配较多的图像，使用八点法估计基础矩阵 **F** 或本质矩阵 **E**，并通过RANSAC算法剔除错误匹配（外点）。
3.  **增量式重建**：
    *   选择一对好的初始图像，恢复其相对姿态和三角化出初始三维点云。
    *   不断添加新图像：将已有三维点投影到新图像上，与检测到的特征点进行匹配，从而估计新图像的相机姿态（PnP问题）。
    *   对新观测到的特征点进行三角化，将其加入三维点云。
4.  **全局优化（光束法平差）**：增量重建会累积误差。最后，需要执行一个全局优化，同时优化所有相机参数 **{R_i, t_i, K_i}** 和所有三维点坐标 **{X_j}**，最小化重投影误差的总和：
    *   **min Σ Σ || x_ij - Proj(K_i, R_i, t_i, X_j) ||²**
    *   这个优化问题称为光束法平差，是一个大规模非线性最小二乘问题，通常使用Levenberg-Marquardt等算法求解。

## 总结 📝

本节课中我们一起学习了运动恢复结构的核心原理。

*   我们从**图像形成的几何模型**出发，理解了齐次坐标和相机投影方程。
*   然后深入探讨了**两视图几何**，推导了本质矩阵 **E** 和极线约束，并学习了用**八点法**求解 **E** 以及恢复相机运动。
*   接着介绍了**相机标定**的方法，以获取相机的内参。
*   最后，概述了从**基础矩阵**出发，到进行**多视图增量式重建**和**全局光束法平差**的完整SFM流程。

这些内容是理解现代三维重建系统的基石。下一节课，我们将探讨立体视觉，这是另一种重要的三维重建方法。

![](img/33217b811ad54c2601acdb4f3b66753a_2.png)

![](img/33217b811ad54c2601acdb4f3b66753a_2.png)