![](img/2dd42143ab7e939d07b9ebb80e9c8596_0.png)

# GAMES101-现代计算机图形学入门-第18课：高级渲染专题 🚀

在本节课中，我们将学习计算机图形学中一些高级的光线传播方法和材质建模技术。这些内容虽然被称为“高级”，但其核心思想并不比路径追踪更复杂，只是作为入门课程，我们不会深入技术细节。本节课旨在拓宽视野，了解图形学领域的前沿方向。

## 课程安排与作业通知 📅

在进入正题之前，先说明一下课程相关的安排。

作业七目前正在由助教团队紧张准备中。这是一个关于路径追踪的新增作业，由于涉及整个框架的实现和调试，发布时间可能稍有延迟，请大家理解。

关于课程大作业，安排如下：
*   下周二（14号）将发布大作业的参考选题。
*   之后有几天时间供大家思考和确定自己的选题。
*   欢迎大家就自己的创意想法咨询老师或助教。
*   到19号需提交一份简要的提案。
*   之后有约两周半的时间完成大作业，并在5月5号提交。

**注意事项：**
*   选题需属于图形学范畴，而非人机交互或计算机视觉等领域。
*   大作业以个人为单位完成，不组队。

## 高级光线传播方法 💡

上一节我们介绍了课程安排，本节中我们来看看几种高级的光线传播方法。我们将从“无偏”和“有偏”这两个核心概念开始。

### 无偏与有偏估计

在基于蒙特卡洛方法的渲染中，我们通过采样来估计积分值。这里有两个重要概念：
*   **无偏估计**：无论使用多少样本，其估计值的**期望**始终等于真实的积分值。例如，标准的路径追踪就是无偏的。
*   **有偏估计**：估计值的期望与真实值不相等。
    *   在有偏估计中，存在一种特殊情况：当使用的样本数量趋近于无穷多时，估计值会收敛到真实值。这种情况我们称之为**一致**的。

在渲染中，一个直观的理解是：如果渲染结果存在**模糊**（与真实物理结果相比），那么它就是有偏的；如果这种模糊能随着样本数增加而消失，最终收敛到清晰结果，那么它就是一致的。

### 双向路径追踪 (Bidirectional Path Tracing, BDPT)

顾名思义，双向路径追踪从两个方向生成路径。
*   从相机出发生成一系列子路径。
*   从光源出发生成另一系列子路径。
*   然后连接这些子路径的端点，形成完整的光路。

**核心思想**：`完整路径 = 相机子路径 + 光源子路径`

BDPT在处理某些特定场景时效果显著，例如当场景主要由间接光照亮时（如光源照亮天花板，再反射到整个房间）。在这种情况下，从相机出发的路径很难直接找到能量集中的光源区域，而从光源出发的路径则能更有效地找到这些路径。

**优缺点**：
*   **优点**：在适合的场景下，能用更少的样本获得比单向路径追踪更好的效果。
*   **缺点**：实现非常复杂，计算速度通常也更慢。

### Metropolis 光线传播 (Metropolis Light Transport, MLT)

MLT 基于马尔可夫链蒙特卡洛方法。其核心思想是：给定一个样本（一条光路），可以在其附近生成新的、相似的样本。

**核心思想**：`新路径 = 对现有路径进行局部扰动`

这种方法特别擅长渲染困难的光路，例如：
*   **光路难以找到的场景**：如光线只能通过门缝进入的房间。
*   **焦散 (Caustics)**：如游泳池底的光斑，其光路模式（如镜面-漫反射-镜面，S-D-S）非常难以通过随机采样捕获。

MLT 的优势在于，只要找到一条“种子”路径，就能在其周围探索出大量相似的有效路径。

**优缺点**：
*   **优点**：特别擅长处理复杂、困难的光路传播。
*   **缺点**：
    1.  收敛速度难以预测，不知道需要渲染多久才能得到无噪声图像。
    2.  由于是局部采样，图像不同区域收敛速度不一致，容易产生“脏”的、斑驳的结果。
    3.  不适合渲染动画，因为帧与帧之间的噪声会剧烈抖动。

### 光子映射 (Photon Mapping)

光子映射是一种**有偏但一致**的方法，它特别擅长渲染焦散效果。其过程分为两步：

![](img/2dd42143ab7e939d07b9ebb80e9c8596_2.png)

**第一步：光子追踪**
从光源向场景发射“光子”。光子与场景交互（反射、折射），直到击中一个**漫反射**表面才停止，并被记录在该位置。

![](img/2dd42143ab7e939d07b9ebb80e9c8596_4.png)

**第二步：光线追踪**
从相机出发进行光线追踪，生成子路径，同样在击中漫反射表面时停止。

**第三步：密度估计**
对于相机子路径击中的每个着色点，寻找其最近的 N 个光子。通过计算这 N 个光子所覆盖的表面积 A，来估计该点的光子密度。

![](img/2dd42143ab7e939d07b9ebb80e9c8596_6.png)

**核心公式**：`密度 ≈ N / A`

**为什么是有偏但一致的？**
我们用有限面积 A 内的平均密度，来近似一个无限小面积 da 上的真实密度，这本身就引入了偏差（模糊）。但是，当发射的光子总数趋向无穷多时，对于固定的 N，其覆盖的面积 A 会趋向于无限小，从而使估计收敛到正确结果。因此它是一致的。

如果改为固定搜索面积 A 并计数其中的光子数，那么即使光子数无限多，估计也不会收敛到正确值，这就不是一致的了。

### 顶点连接与合并 (Vertex Connection and Merging, VCM)

![](img/2dd42143ab7e939d07b9ebb80e9c8596_8.png)

VCM 是双向路径追踪和光子映射的结合体。

![](img/2dd42143ab7e939d07b9ebb80e9c8596_10.png)

**核心思想**：当双向路径追踪生成的两条子路径的端点非常接近，但无法直接连接时（例如端点几乎在同一位置），不将其丢弃。而是将其中一条子路径视为“光子”，使用类似光子映射的密度估计方法来计算其对最终颜色的贡献。这样结合了两种方法的优点。

![](img/2dd42143ab7e939d07b9ebb80e9c8596_12.png)

### 实时辐射度算法 (Instant Radiosity, IR)

![](img/2dd42143ab7e939d07b9ebb80e9c8596_14.png)

实时辐射度算法，也称为“多光源”方法，其思想非常直接。

![](img/2dd42143ab7e939d07b9ebb80e9c8596_16.png)

**核心思想**：
1.  **创建虚拟点光源**：从真实光源发射光线子路径，在路径击中的漫反射表面上创建一系列虚拟点光源。
2.  **直接光照计算**：在着色时，将这些虚拟点光源当作直接光源来照亮着色点。

![](img/2dd42143ab7e939d07b9ebb80e9c8596_18.png)

![](img/2dd42143ab7e939d07b9ebb80e9c8596_20.png)

**核心思想**：`间接光照 ≈ 大量虚拟点光源的直接光照之和`

这种方法速度很快，因为它将间接光照问题转化为了多直接光源照明问题。

**存在问题**：
*   **光源 singularity 问题**：当虚拟点光源与着色点距离极近时，光照强度公式中的 `1/r²` 项会导致数值爆炸，产生不合理的亮斑。
*   **无法处理光泽表面**：VPL 方法通常假设表面是漫反射的。

---

## 高级外观建模 🎨

上一节我们探讨了高级的光线传播方法，本节中我们来看看如何对更复杂的材质外观进行建模。这不仅仅是表面模型，还涉及体积、毛发等。

### 非表面模型

![](img/2dd42143ab7e939d07b9ebb80e9c8596_22.png)

#### 散射介质 (Participating Media)

![](img/2dd42143ab7e939d07b9ebb80e9c8596_24.png)

![](img/2dd42143ab7e939d07b9ebb80e9c8596_26.png)

散射介质是指光能在其中传播并被吸收或散射的物质，如雾、云、烟等。

**核心特性**：
*   **吸收**：光线在介质中传播时能量会衰减。
*   **散射**：光线在介质中的微小粒子（如冰晶、尘埃）上改变方向。
    *   **相位函数**：定义了在某个点上，光线从某个方向散射到另一个方向的概率分布。这类似于表面的 BRDF，但是发生在体积内部。

![](img/2dd42143ab7e939d07b9ebb80e9c8596_28.png)

渲染散射介质时，光线在介质内部传播时，会在随机点发生散射或终止，其渲染思想与表面路径追踪类似，但积分域是整个体积空间。

![](img/2dd42143ab7e939d07b9ebb80e9c8596_30.png)

![](img/2dd42143ab7e939d07b9ebb80e9c8596_32.png)

#### 毛发与毛发模型

渲染毛发不能简单地用表面模型，因为毛发是细长的曲线。

![](img/2dd42143ab7e939d07b9ebb80e9c8596_34.png)

**Marschner 模型**：
将单根毛发视为一个玻璃圆柱体。光线与毛发作用时，主要考虑三种路径：
*   **R**：表面直接反射。
*   **TT**：折射进入毛发，穿透后折射出去。
*   **TRT**：折射进入，在内部反射一次，再折射出去。

这个模型能很好地模拟人类头发的高光。

![](img/2dd42143ab7e939d07b9ebb80e9c8596_36.png)

**双层圆柱模型 (Double Cylinder Model)**：
为了更真实地模拟动物毛发，需要考虑毛发的髓质层。该模型将毛发视为内外两层圆柱（表皮层和髓质层）。光线在髓质层中会发生额外的散射，因此除了 R, TT, TRT 外，还增加了考虑髓质散射的路径（如 TT^s, TRT^s）。这个模型能更好地表现动物毛发蓬松、透光的质感。

![](img/2dd42143ab7e939d07b9ebb80e9c8596_38.png)

![](img/2dd42143ab7e939d07b9ebb80e9c8596_40.png)

**多次散射**：
光线会在多根毛发之间弹射，计算量巨大，但这是毛发渲染真实感的关键。

![](img/2dd42143ab7e939d07b9ebb80e9c8596_42.png)

![](img/2dd42143ab7e939d07b9ebb80e9c8596_44.png)

![](img/2dd42143ab7e939d07b9ebb80e9c8596_46.png)

#### 颗粒材质 (Granular Material)

![](img/2dd42143ab7e939d07b9ebb80e9c8596_48.png)

如沙子、盐、糖等由大量颗粒堆积而成的材质。渲染这种材质需要模拟无数微小颗粒的光线相互作用，计算量非常庞大。一种简化方法是统计性地描述不同成分颗粒的混合比例。

### 表面模型

![](img/2dd42143ab7e939d07b9ebb80e9c8596_50.png)

#### 次表面散射 (Subsurface Scattering)

![](img/2dd42143ab7e939d07b9ebb80e9c8596_52.png)

![](img/2dd42143ab7e939d07b9ebb80e9c8596_54.png)

次表面散射是指光线进入材质内部，经过多次散射后从另一点射出的现象，如皮肤、玉石、蜡烛。它不能用标准的 BRDF 描述。

**核心概念：BSSRDF**
BSSRDF 是 BRDF 的扩展，它描述了光线从**一个点**以某个方向进入，从**另一个点**以某个方向出射的分布。

**渲染方程扩展**：`Lo(xo, ωo) = ∫_A ∫_{2π} S(xi, ωi; xo, ωo) Li(xi, ωi) cosθi dωi dA`
这意味着计算时不仅要对入射方向积分，还要对表面其他点的面积积分，计算非常复杂。

![](img/2dd42143ab7e939d07b9ebb80e9c8596_56.png)

**近似方法：偶极子模型**
一种高效的近似是将次表面散射的效果，等效为在入射点下方放置两个虚拟光源（一个正方向，一个负方向），用它们来照亮周围的表面点。这种方法能很好地模拟皮肤、玉石等材质的柔和透光感。

![](img/2dd42143ab7e939d07b9ebb80e9c8596_58.png)

#### 布料 (Cloth)

![](img/2dd42143ab7e939d07b9ebb80e9c8596_60.png)

布料由纤维缠绕编织而成，其建模有多种层次：
1.  **表面模型**：将布料视为一个平面，使用各向异性的 BRDF 模拟编织纹理带来的高光。这是最简单快速的方法。
2.  **体积模型**：将布料视为一个充满纤维的体积，用渲染散射介质的方法来渲染。更真实，但计算量大。
3.  **纤维级模型**：将每一根纤维都像渲染头发一样单独渲染。效果最真实，计算量也最大。

![](img/2dd42143ab7e939d07b9ebb80e9c8596_62.png)

#### 复杂微表面细节与波动光学

![](img/2dd42143ab7e939d07b9ebb80e9c8596_64.png)

![](img/2dd42143ab7e939d07b9ebb80e9c8596_66.png)

现实世界的表面充满划痕、磨损等微观细节。简单地使用法线贴图结合微表面模型渲染这些细节极其耗时，因为镜面反射的光路很难被捕获。

![](img/2dd42143ab7e939d07b9ebb80e9c8596_68.png)

**解决方案：微表面理论拓展**
考虑一个像素所覆盖的区域内所有微表面的法线分布，用这个统计分布来替代简单的解析分布函数。这样就能高效地渲染出由微观细节聚合而成的宏观高光效果。

![](img/2dd42143ab7e939d07b9ebb80e9c8596_70.png)

**波动光学效应**
当表面细节的尺寸与光的波长相当时，必须考虑光的波动性（干涉、衍射），而不能再用几何光学。这会导致高光区域出现彩色的、不连续的光谱条纹，这在某些高度抛光的金属或带有细微划痕的表面上可以观察到。

![](img/2dd42143ab7e939d07b9ebb80e9c8596_72.png)

### 程序化生成外观 (Procedural Appearance)

![](img/2dd42143ab7e939d07b9ebb80e9c8596_74.png)

程序化生成是指不预先存储庞大的纹理数据，而是通过一个数学函数在需要时实时计算材质属性。

![](img/2dd42143ab7e939d07b9ebb80e9c8596_76.png)

![](img/2dd42143ab7e939d07b9ebb80e9c8596_78.png)

**核心工具：噪声函数**
例如柏林噪声 (Perlin Noise)，它是一个定义在空间中的函数 `Noise(x, y, z)`，输入空间坐标，返回一个值。通过对噪声函数进行各种变换和组合，可以生成木头纹理、大理石纹理、云层、地形高度等复杂而自然的效果。

![](img/2dd42143ab7e939d07b9ebb80e9c8596_80.png)

![](img/2dd42143ab7e939d07b9ebb80e9c8596_82.png)

**优势**：
*   **无限分辨率**：因为是函数，可以查询任意精细级别的细节。
*   **内存占用小**：无需存储大量纹理数据。
*   **三维一致性**：可以生成三维纹理，物体被切开后内部纹理也是连续的。

---

![](img/2dd42143ab7e939d07b9ebb80e9c8596_84.png)

## 总结 📝

![](img/2dd42143ab7e939d07b9ebb80e9c8596_86.png)

本节课我们一起学习了计算机图形学中一些高级的渲染话题。

![](img/2dd42143ab7e939d07b9ebb80e9c8596_88.png)

在**光线传播**部分，我们了解了：
*   **无偏方法**：如双向路径追踪和 Metropolis 光线传播，它们能提供理论上准确的结果，但各有其适用的场景和代价。
*   **有偏但一致的方法**：如光子映射，它通过引入可控的偏差（模糊）来换取效率，特别擅长渲染焦散。
*   **混合方法**：如 VCM，结合了不同方法的优点。
*   **近似方法**：如实时辐射度算法，将间接光照转化为直接光照问题以实现快速计算。

在**外观建模**部分，我们探索了：
*   **非表面模型**：如散射介质、毛发和颗粒材质，它们需要超越表面渲染的特殊处理。
*   **表面模型进阶**：如次表面散射对 BRDF 的扩展，以及布料渲染的不同层次。
*   **微观细节**：如何高效渲染微观几何细节及其带来的波动光学效应。
*   **程序化生成**：如何通过数学函数动态生成复杂、逼真且内存高效的材质。

![](img/2dd42143ab7e939d07b9ebb80e9c8596_90.png)

![](img/2dd42143ab7e939d07b9ebb80e9c8596_92.png)

![](img/2dd42143ab7e939d07b9ebb80e9c8596_94.png)

目前并不存在一个“完美”的渲染方法能解决所有问题。在工业界，**路径追踪**因其可靠性和相对简单的实现，仍然是许多电影级渲染的首选。理解不同方法的原理和权衡，有助于我们在面对不同渲染需求时做出合适的选择。