![](img/c6d91a5052cb15af085edc0958df24f9_0.png)

![](img/c6d91a5052cb15af085edc0958df24f9_2.png)

![](img/c6d91a5052cb15af085edc0958df24f9_4.png)

# GAMES201：高级物理引擎实战指南2020 - P4：Lecture 4 欧拉视角 🔄

在本节课中，我们将学习欧拉视角下的流体模拟。我们将从拉格朗日视角的回顾开始，逐步引入欧拉视角的核心概念，并详细讲解不可压缩纳维-斯托克斯方程的求解过程，包括平流、外力和投影三个关键步骤。课程将涵盖数据结构、数值格式以及求解大型线性系统的迭代方法，旨在为初学者提供一个清晰、实用的入门指南。

![](img/c6d91a5052cb15af085edc0958df24f9_6.png)

![](img/c6d91a5052cb15af085edc0958df24f9_8.png)

![](img/c6d91a5052cb15af085edc0958df24f9_10.png)

![](img/c6d91a5052cb15af085edc0958df24f9_11.png)

![](img/c6d91a5052cb15af085edc0958df24f9_13.png)

## 课程概述与回顾

上一讲我们主要介绍了拉格朗日视角。在拉格朗日视角中，粒子随材料在空间中移动，并记录自身的位置、速度等属性。其关键在于传感器或流体粒子会随着流体或固体一起运动。

本节中我们来看看欧拉视角。欧拉视角的特点是采样点在空间中固定不动。每个采样点记录的是材料以何种速度穿过该点。可以将其理解为在水中插入许多固定的桩，每个桩都知道周围水流的流速。

## 核心概念：材料导数

为了联系欧拉视角和拉格朗日视角，我们引入一个核心概念：**材料导数**。其符号通常用大写的 **D** 表示。

材料导数描述了一个物理量随材料一起移动时的变化率。它由两部分组成：
1.  物理量关于时间的偏导数 **∂/∂t**。
2.  材料速度 **u** 点乘该物理量的空间梯度 **∇**。

**公式**：
`Dφ/Dt = ∂φ/∂t + u · ∇φ`

直观理解是，一个随材料移动的采样点，其物理量的变化一方面来自该点本身随时间的变化，另一方面来自材料移动到不同位置所导致的变化。

常见的例子是温度变化。如果把温度计绑在粒子上，温度变化既包含该点温度自身随时间的变化，也包含粒子移动到不同温度区域所带来的变化。

## 不可压缩纳维-斯托克斯方程

欧拉法流体模拟的核心是求解不可压缩纳维-斯托克斯方程。我们介绍一个简化版本。

**公式**：
`Du/Dt = - (1/ρ) ∇p + ν ∇²u + g`

这个方程描述了流体微元速度随时间的变化。其中：
*   `- (1/ρ) ∇p` 是压强梯度导致的力。
*   `ν ∇²u` 是粘性项，在图形学中常被忽略以突出涡流等视觉效果。
*   `g` 是重力加速度。

此外，对于不可压缩流体，速度场的散度必须为零：
**公式**：
`∇ · u = 0`

这意味着流体局部不会被压缩或拉伸，密度保持不变。

![](img/c6d91a5052cb15af085edc0958df24f9_15.png)

![](img/c6d91a5052cb15af085edc0958df24f9_17.png)

![](img/c6d91a5052cb15af085edc0958df24f9_19.png)

## 算子分裂法

![](img/c6d91a5052cb15af085edc0958df24f9_21.png)

![](img/c6d91a5052cb15af085edc0958df24f9_23.png)

直接求解完整的NS方程很复杂。我们采用**算子分裂法**将其分解为几个更简单的步骤。直观上，算子分裂法就是将复杂的时间导数拆分成若干个易于处理的部分。

以下是分裂后的三个主要步骤：
1.  **平流**：只考虑速度场自身的输运。
    `∂u/∂t = - (u · ∇) u`
2.  **外力**：添加重力等外力。
    `∂u/∂t = g`
3.  **投影**：施加压强梯度力，并使速度场满足无散条件。
    `∂u/∂t = - (1/ρ) ∇p`，且满足 `∇ · u = 0`

![](img/c6d91a5052cb15af085edc0958df24f9_25.png)

![](img/c6d91a5052cb15af085edc0958df24f9_27.png)

![](img/c6d91a5052cb15af085edc0958df24f9_29.png)

对时间进行离散化后，每个时间步就对应三步操作：
1.  通过当前速度场，计算出下一时间步速度场的初始估计 `u*`（仅考虑平流）。
2.  在 `u*` 上加上外力（如重力），得到 `u**`。
3.  对 `u**` 进行投影，施加一个合适的压强场 `p`，使得最终速度场 `u^{n+1}` 的散度为零。

![](img/c6d91a5052cb15af085edc0958df24f9_31.png)

![](img/c6d91a5052cb15af085edc0958df24f9_33.png)

![](img/c6d91a5052cb15af085edc0958df24f9_35.png)

![](img/c6d91a5052cb15af085edc0958df24f9_37.png)

## 数据结构：网格

在欧拉法中，我们需要一个数据结构来表示空间中的速度场和压强场。最常用的是**均匀网格**。

![](img/c6d91a5052cb15af085edc0958df24f9_39.png)

以下是两种常见的网格存储方式：

![](img/c6d91a5052cb15af085edc0958df24f9_41.png)

![](img/c6d91a5052cb15af085edc0958df24f9_43.png)

![](img/c6d91a5052cb15af085edc0958df24f9_45.png)

![](img/c6d91a5052cb15af085edc0958df24f9_47.png)

![](img/c6d91a5052cb15af085edc0958df24f9_49.png)

*   **中心网格**：将所有物理量（速度u、v分量，压强p）存储在网格单元的中心。实现简单，但可能导致数值误差。
*   **交错网格**：将速度的不同分量和压强存储在网格的不同位置。例如，水平速度 `u` 存储在单元垂直边的中心，垂直速度 `v` 存储在单元水平边的中心，压强 `p` 存储在单元中心。这种方法能有效避免“棋盘格”伪影，是更常用的选择。

![](img/c6d91a5052cb15af085edc0958df24f9_51.png)

![](img/c6d91a5052cb15af085edc0958df24f9_53.png)

由于我们只在离散的网格点上有数值，为了得到空间中任意点的值，需要使用插值技术。最常用的是**双线性插值**。它利用一个网格单元四个角点的值，通过面积加权平均的方式，计算出单元内任意点的近似值。

![](img/c6d91a5052cb15af085edc0958df24f9_55.png)

![](img/c6d91a5052cb15af085edc0958df24f9_57.png)

## 平流

平流步骤负责移动流体的物理量（如速度、温度）。其目标是计算下一个时间步网格点上的物理量值。

有多种平流格式，它们在数值粘性、稳定性和性能之间进行权衡。我们介绍两种：

### 1. 半拉格朗日法

这是最简单、最稳定的方法，但数值粘性较高。
**思路**：要计算下一时间步 `x` 点的值，就沿着当前速度场反向追踪 `Δt` 时间，找到 `x` 点在上一个时间步的位置 `x_prev`。然后，在上一个时间步的速度场中，对 `x_prev` 进行双线性插值，得到的结果就作为 `x` 点在新时间步的值。

**代码逻辑**：
```python
for 每个网格点 x:
    x_prev = backtrace(x, u, -dt)  # 反向追踪
    u_new[x] = bilinear_interpolate(u_old, x_prev) # 插值得到新值
```
反向追踪的精度会影响结果。简单的欧拉法（`x_prev = x - u(x)*dt`）误差较大。使用更高阶的龙格-库塔法（如RK2中点法）进行反向追踪，可以显著提高精度，减少“越转越小”的误差。

### 2. MacCormack / BFECC 法

这是一种更精确的格式，能更好地保持物理量的锐利度，减少数值耗散。
**思路**：
1.  先用半拉格朗日法平流一步，得到中间结果 `u*`。
2.  再将 `u*` 反向平流一步（即用 `-dt` 做平流），得到 `u**`。
3.  理论上，如果平流完美，`u**` 应等于原始的 `u`。两者的差异 `error = u - u**` 就近似为平流误差。
4.  最终结果修正为：`u_final = u* + 0.5 * error`。

这种方法能有效减少物理量（如烟雾边界）在平流中变得模糊的问题。但需要注意，修正步骤可能产生过冲，通常需要配合值域限制来避免伪影。

## 投影与泊松方程

投影步骤的目标是求解一个压强场 `p`，使得施加其梯度力后，速度场变得无散。

![](img/c6d91a5052cb15af085edc0958df24f9_59.png)

![](img/c6d91a5052cb15af085edc0958df24f9_61.png)

推导后，我们得到一个关于压强 `p` 的**泊松方程**：
**公式**：
`∇²p = (ρ/Δt) ∇ · u`

我们需要在离散网格上求解这个方程。对于网格点 `(i, j)`，其拉普拉斯算子可以用**五点差分格式**近似：
`(∇²p)_{i,j} ≈ (p_{i+1,j} + p_{i-1,j} + p_{i,j+1} + p_{i,j-1} - 4p_{i,j}) / Δx²`

速度的散度 `∇ · u` 也可以利用交错网格上的速度值进行离散近似。

这样，我们就为每个网格点建立了一个线性方程。将所有方程组合起来，便得到一个大型线性方程组：
**公式**：
`A p = b`

其中矩阵 `A` 非常大（`N*M` × `N*M`），但非常稀疏（每行只有少数几个非零元素）。

## 求解线性系统

求解 `A p = b` 是投影步骤的核心。对于大规模稀疏系统，直接解法成本过高，通常采用迭代法。

### 共轭梯度法

**共轭梯度法** 是求解对称正定线性系统最有效的迭代法之一。其实现相对简洁，通过迭代在Krylov子空间中寻找最优解。

算法框架如下：
```
给定初始解 p, 计算残差 r = b - A p, 令搜索方向 s = r
while 残差 r 的范数未收敛:
    α = (r·r) / (s·A s)
    p = p + α * s
    r_new = r - α * A s
    β = (r_new·r_new) / (r·r)
    s = r_new + β * s
    r = r_new
```
迭代法的收敛速度与矩阵 `A` 的**条件数**密切相关。条件数越大，收敛越慢。

### 预条件子

![](img/c6d91a5052cb15af085edc0958df24f9_63.png)

为了加速收敛，我们使用**预条件子**。其思想是求解一个等价的系统 `M^{-1} A p = M^{-1} b`，其中矩阵 `M^{-1}A` 的条件数比原矩阵 `A` 更好，且 `M` 的逆很容易计算。
*   **雅可比预条件子**：`M` 取 `A` 的对角线部分，求逆非常简单。
*   **多重网格预条件子**：这是图形学中求解泊松方程的标准高效方法。

![](img/c6d91a5052cb15af085edc0958df24f9_65.png)

![](img/c6d91a5052cb15af085edc0958df24f9_67.png)

### 多重网格法

多重网格法之所以高效，是因为它能同时在多个尺度上消除误差。细网格上的低频误差，在粗网格上会表现为高频误差，从而能被快速平滑掉。

![](img/c6d91a5052cb15af085edc0958df24f9_69.png)

![](img/c6d91a5052cb15af085edc0958df24f9_71.png)

![](img/c6d91a5052cb15af085edc0958df24f9_73.png)

基本流程（V循环）：
1.  **预平滑**：在细网格上用几次简单的迭代（如雅可比迭代）平滑误差。
2.  **限制**：将细网格上的残差转移到更粗的网格上。
3.  **递归求解**：在粗网格上求解残差方程（递归进行，直到网格足够粗）。
4.  **延拓**：将粗网格上的解修正值插值回细网格。
5.  **后平滑**：在细网格上再进行几次平滑迭代。

![](img/c6d91a5052cb15af085edc0958df24f9_75.png)

在图形学中，通常将多重网格作为预条件子与共轭梯度法结合使用，称为 **MG-PCG**。这已成为求解不可压缩流体压力泊松方程的标准配置，能保证迭代次数与网格大小基本无关。

## 进阶话题与总结

本节课我们一起学习了欧拉法流体模拟的核心流程：**平流**和**投影**。

*   **平流**：关键在于选择数值耗散小的格式，如 MacCormack/BFECC，以保持流体的细节和能量。
*   **投影**：关键在于高效、准确地求解泊松方程，通常使用 MG-PCG 方法，以保证速度场无散，从而保持流体体积。

在实际组合这些步骤时，顺序和方式也会影响效果。例如，标准的“平流-投影”步骤会损失部分涡量能量。高级方法如 **涡量约束** 或 **投影分裂** 可以在一定程度上恢复这些能量，产生更逼真、更少数值粘性的流动效果。

对于希望深入学习的同学，可以探索以下方向：
1.  实现三维模拟。
2.  处理更复杂的边界条件（如嵌入式边界）。
3.  流固耦合。
4.  两相流模拟（同时模拟水与空气）。
5.  水平集方法捕捉动态流体界面。
6.  涡量法（基于涡量的公式，能更好地守恒涡量）。

![](img/c6d91a5052cb15af085edc0958df24f9_77.png)

![](img/c6d91a5052cb15af085edc0958df24f9_78.png)

欧拉法流体模拟是生成烟雾、火焰、水流等视觉特效的强大工具。虽然本课内容密集，但通过动手实践、阅读推荐资料和参考示例代码，你将能够逐步掌握这项技术，并创造出令人惊艳的效果。