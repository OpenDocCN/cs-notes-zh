![](img/64b1bb3e614ededb837725c35b26ce80_0.png)

![](img/64b1bb3e614ededb837725c35b26ce80_2.png)

# æ–¯å¦ç¦å¤§å­¦ã€ŠCS106Lï¼šC++ç¼–ç¨‹ã€‹è¯¾ç¨‹ç¬”è®° - P18ï¼šå¤šçº¿ç¨‹ç¼–ç¨‹ ğŸ§µ

åœ¨æœ¬èŠ‚è¯¾ä¸­ï¼Œæˆ‘ä»¬å°†è¦å­¦ä¹ C++ä¸­çš„å¤šçº¿ç¨‹ç¼–ç¨‹ã€‚å¤šçº¿ç¨‹å…è®¸ç¨‹åºåŒæ—¶æ‰§è¡Œå¤šä¸ªä»»åŠ¡ï¼Œè¿™å¯¹äºæé«˜ç¨‹åºæ•ˆç‡ã€å¤„ç†I/Oç­‰å¾…ç­‰åœºæ™¯è‡³å…³é‡è¦ã€‚æˆ‘ä»¬å°†ä»åŸºæœ¬æ¦‚å¿µå…¥æ‰‹ï¼Œé€šè¿‡ä»£ç ç¤ºä¾‹ç†è§£çº¿ç¨‹çš„åˆ›å»ºã€åŒæ­¥ä»¥åŠå¦‚ä½•é¿å…å¸¸è§é—®é¢˜ã€‚

---

## æ¦‚è¿°ï¼šä¸ºä»€ä¹ˆéœ€è¦å¤šçº¿ç¨‹ï¼Ÿ ğŸ¤”

åœ¨å¼€å§‹ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ€è€ƒä¸€ä¸ªé—®é¢˜ï¼šå¦‚æœè®¡ç®—æœºåªæœ‰ä¸€ä¸ªCPUï¼Œä¸ºä»€ä¹ˆè¿˜éœ€è¦å¤šçº¿ç¨‹ï¼Ÿç­”æ¡ˆåœ¨äº**ç­‰å¾…**ã€‚ç¨‹åºç»å¸¸éœ€è¦ç­‰å¾…æŸäº›æ“ä½œå®Œæˆï¼Œä¾‹å¦‚ä»ç£ç›˜è¯»å–æ–‡ä»¶ã€ç­‰å¾…ç½‘ç»œå“åº”æˆ–ç­‰å¾…ç”¨æˆ·è¾“å…¥ã€‚åœ¨è¿™äº›ç­‰å¾…æœŸé—´ï¼ŒCPUå¯ä»¥è½¬è€Œæ‰§è¡Œå…¶ä»–ä»»åŠ¡ï¼Œè€Œä¸æ˜¯ç©ºé—²ã€‚å¤šçº¿ç¨‹ä½¿å¾—ä¸€ä¸ªçº¿ç¨‹åœ¨ç­‰å¾…æ—¶ï¼Œå…¶ä»–çº¿ç¨‹å¯ä»¥ç»§ç»­å·¥ä½œï¼Œä»è€Œæ›´æœ‰æ•ˆåœ°åˆ©ç”¨è®¡ç®—èµ„æºã€‚

ä¸Šä¸€èŠ‚æˆ‘ä»¬ä»‹ç»äº†å¤šçº¿ç¨‹çš„åŸºæœ¬åŠ¨æœºï¼Œæœ¬èŠ‚ä¸­æˆ‘ä»¬æ¥çœ‹çœ‹C++æ ‡å‡†åº“ä¸­æä¾›çš„å¤šçº¿ç¨‹å·¥å…·ã€‚

---

## C++æ ‡å‡†åº“ä¸­çš„å¤šçº¿ç¨‹æ”¯æŒ ğŸ“š

C++æ ‡å‡†åº“åœ¨ `<thread>` å¤´æ–‡ä»¶ä¸­æä¾›äº†å¯¹å¤šçº¿ç¨‹çš„æ ¸å¿ƒæ”¯æŒã€‚æ­¤å¤–ï¼Œè¿˜æœ‰å…¶ä»–ç›¸å…³å¤´æ–‡ä»¶ç”¨äºå¤„ç†åŒæ­¥å’ŒåŸå­æ“ä½œã€‚

![](img/64b1bb3e614ededb837725c35b26ce80_4.png)

![](img/64b1bb3e614ededb837725c35b26ce80_6.png)

ä»¥ä¸‹æ˜¯æ ‡å‡†åº“ä¸­ä¸å¤šçº¿ç¨‹ç›¸å…³çš„ä¸»è¦éƒ¨åˆ†ï¼š

![](img/64b1bb3e614ededb837725c35b26ce80_8.png)

![](img/64b1bb3e614ededb837725c35b26ce80_10.png)

*   **`<atomic>`**ï¼šæä¾›äº†**åŸå­ç±»å‹**ï¼ˆå¦‚ `std::atomic<int>`ï¼‰å’ŒåŸå­æ“ä½œã€‚å®ƒä»¬ä¿è¯äº†é’ˆå¯¹å•ä¸ªå˜é‡çš„æ“ä½œæ˜¯**ä¸å¯åˆ†å‰²**çš„ï¼Œä»è€Œé¿å…æ•°æ®ç«äº‰ã€‚
*   **`<thread>`**ï¼šåŒ…å« `std::thread` ç±»ï¼Œç”¨äºåˆ›å»ºå’Œç®¡ç†çº¿ç¨‹ã€‚
*   **`<mutex>`**ï¼šæä¾›äº†äº’æ–¥é”ï¼ˆå¦‚ `std::mutex`ï¼‰ä»¥åŠé”åŒ…è£…å™¨ï¼ˆå¦‚ `std::lock_guard` å’Œ `std::unique_lock`ï¼‰ï¼Œç”¨äºä¿æŠ¤å…±äº«æ•°æ®ã€‚
*   **`<condition_variable>`**ï¼šæä¾›äº†çº¿ç¨‹é—´é€šä¿¡çš„æœºåˆ¶ï¼Œå…è®¸çº¿ç¨‹ç­‰å¾…ç‰¹å®šæ¡ä»¶æˆç«‹æˆ–å‘å…¶ä»–çº¿ç¨‹å‘å‡ºä¿¡å·ã€‚
*   **`<future>`**ï¼šæ”¯æŒå¼‚æ­¥æ“ä½œï¼Œç±»ä¼¼äºå…¶ä»–è¯­è¨€ä¸­çš„ `async/await` æ¨¡å¼ã€‚

![](img/64b1bb3e614ededb837725c35b26ce80_12.png)

![](img/64b1bb3e614ededb837725c35b26ce80_14.png)

![](img/64b1bb3e614ededb837725c35b26ce80_15.png)

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†é‡ç‚¹å­¦ä¹ å¦‚ä½•ä½¿ç”¨ `std::thread` å’Œé”æ¥ç¼–å†™å¤šçº¿ç¨‹ç¨‹åºã€‚

![](img/64b1bb3e614ededb837725c35b26ce80_17.png)

---

## åˆ›å»ºä¸è¿è¡Œçº¿ç¨‹ ğŸš€

åˆ›å»ºä¸€ä¸ªçº¿ç¨‹éå¸¸ç®€å•ï¼šä½ éœ€è¦æä¾›ä¸€ä¸ªå‡½æ•°ï¼ˆæˆ–å¯è°ƒç”¨å¯¹è±¡ï¼‰ä½œä¸ºçº¿ç¨‹çš„â€œå·¥ä½œâ€ï¼Œç„¶åå¯åŠ¨å®ƒã€‚

```cpp
#include <iostream>
#include <thread>

![](img/64b1bb3e614ededb837725c35b26ce80_19.png)

![](img/64b1bb3e614ededb837725c35b26ce80_21.png)

![](img/64b1bb3e614ededb837725c35b26ce80_23.png)

void greet(int id) {
    std::cout << "Hello, my name is " << id << std::endl;
}

int main() {
    // åˆ›å»ºä¸¤ä¸ªçº¿ç¨‹ï¼Œåˆ†åˆ«æ‰§è¡Œgreetå‡½æ•°ï¼Œå¹¶ä¼ å…¥å‚æ•°1å’Œ2
    std::thread thread1(greet, 1);
    std::thread thread2(greet, 2);

    // ç­‰å¾…ä¸¤ä¸ªçº¿ç¨‹æ‰§è¡Œå®Œæ¯•
    thread1.join();
    thread2.join();

    std::cout << "All greetings done!" << std::endl;
    return 0;
}
```

**ä»£ç è§£é‡Š**ï¼š
1.  `std::thread thread1(greet, 1);` è¿™è¡Œä»£ç åˆ›å»ºäº†ä¸€ä¸ªåä¸º `thread1` çš„çº¿ç¨‹ã€‚å®ƒçš„å·¥ä½œæ˜¯æ‰§è¡Œ `greet` å‡½æ•°ï¼Œå¹¶ä¼ å…¥å‚æ•° `1`ã€‚**çº¿ç¨‹åœ¨åˆ›å»ºåä¼šç«‹å³å¼€å§‹å°è¯•æ‰§è¡Œå…¶ä»»åŠ¡**ã€‚
2.  `thread1.join();` è¿™è¡Œä»£ç å‘Šè¯‰ä¸»çº¿ç¨‹ï¼ˆ`main` å‡½æ•°ï¼‰ç­‰å¾… `thread1` å®Œæˆå…¶å·¥ä½œã€‚å¦‚æœæ²¡æœ‰ `join`ï¼Œä¸»çº¿ç¨‹å¯èƒ½ä¼šåœ¨å­çº¿ç¨‹ç»“æŸå‰å°±é€€å‡ºï¼Œå¯¼è‡´ç¨‹åºå¼‚å¸¸ç»ˆæ­¢ã€‚

---

![](img/64b1bb3e614ededb837725c35b26ce80_25.png)

![](img/64b1bb3e614ededb837725c35b26ce80_27.png)

![](img/64b1bb3e614ededb837725c35b26ce80_29.png)

## æ•°æ®ç«äº‰ä¸é”çš„ä¿æŠ¤ ğŸ›¡ï¸

å¤šçº¿ç¨‹ç¼–ç¨‹çš„æ ¸å¿ƒæŒ‘æˆ˜ä¹‹ä¸€æ˜¯**æ•°æ®ç«äº‰**ã€‚å½“å¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®å’Œä¿®æ”¹åŒä¸€ä»½å…±äº«æ•°æ®ï¼Œä¸”è®¿é—®é¡ºåºä¸ç¡®å®šæ—¶ï¼Œå°±ä¼šå‘ç”Ÿæ•°æ®ç«äº‰ï¼Œå¯¼è‡´ç¨‹åºç»“æœä¸å¯é¢„æµ‹ã€‚

è€ƒè™‘ä»¥ä¸‹çœ‹ä¼¼ç®€å•çš„è¾“å‡ºè¯­å¥ï¼š
```cpp
std::cout << "Hello, my name is " << id << std::endl;
```
å®é™…ä¸Šï¼Œè¿™è¡Œä»£ç åŒ…å«äº†å¤šä¸ªæ“ä½œï¼ˆæ’å…¥ `"Hello, my name is "`ï¼Œæ’å…¥ `id`ï¼Œæ’å…¥ `std::endl`ï¼‰ï¼Œå®ƒä»¬å¯èƒ½è¢«å…¶ä»–çº¿ç¨‹çš„æ“ä½œæ‰“æ–­ï¼Œå¯¼è‡´è¾“å‡ºå†…å®¹äº¤é”™æ··ä¹±ã€‚

ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨**äº’æ–¥é”ï¼ˆMutexï¼‰**æ¥ç¡®ä¿æŸä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½æ‰§è¡Œå—ä¿æŠ¤çš„ä»£ç å—ã€‚ä¸ºäº†ä½¿é”çš„ç®¡ç†ç¬¦åˆRAIIï¼ˆèµ„æºè·å–å³åˆå§‹åŒ–ï¼‰åŸåˆ™ï¼Œé¿å…å¿˜è®°è§£é”ï¼Œæˆ‘ä»¬ä½¿ç”¨ `std::lock_guard`ã€‚

![](img/64b1bb3e614ededb837725c35b26ce80_31.png)

![](img/64b1bb3e614ededb837725c35b26ce80_33.png)

![](img/64b1bb3e614ededb837725c35b26ce80_35.png)

![](img/64b1bb3e614ededb837725c35b26ce80_36.png)

![](img/64b1bb3e614ededb837725c35b26ce80_38.png)

```cpp
#include <iostream>
#include <thread>
#include <mutex>

![](img/64b1bb3e614ededb837725c35b26ce80_40.png)

std::mutex cout_mutex; // åˆ›å»ºä¸€ä¸ªå…¨å±€äº’æ–¥é”

![](img/64b1bb3e614ededb837725c35b26ce80_42.png)

void safe_greet(int id) {
    std::lock_guard<std::mutex> lock(cout_mutex); // æ„é€ æ—¶åŠ é”
    std::cout << "Hello, my name is " << id << std::endl;
    // lock_guardææ„æ—¶è‡ªåŠ¨è§£é”
}

![](img/64b1bb3e614ededb837725c35b26ce80_44.png)

![](img/64b1bb3e614ededb837725c35b26ce80_46.png)

![](img/64b1bb3e614ededb837725c35b26ce80_48.png)

int main() {
    std::thread t1(safe_greet, 1);
    std::thread t2(safe_greet, 2);

    t1.join();
    t2.join();
    return 0;
}
```
ç°åœ¨ï¼Œ`safe_greet` å‡½æ•°ä¸­çš„è¾“å‡ºè¯­å¥æˆä¸ºäº†ä¸€ä¸ª**ä¸´ç•ŒåŒº**ï¼Œä¿è¯äº†è¾“å‡ºçš„å®Œæ•´æ€§ã€‚

![](img/64b1bb3e614ededb837725c35b26ce80_50.png)

![](img/64b1bb3e614ededb837725c35b26ce80_52.png)

---

![](img/64b1bb3e614ededb837725c35b26ce80_54.png)

## ç®¡ç†å¤šä¸ªçº¿ç¨‹ ğŸ“

æˆ‘ä»¬é€šå¸¸éœ€è¦åˆ›å»ºå’Œç®¡ç†å¤šä¸ªçº¿ç¨‹ã€‚ä½¿ç”¨å®¹å™¨ï¼ˆå¦‚ `std::vector`ï¼‰å¯ä»¥æ–¹ä¾¿åœ°åšåˆ°è¿™ä¸€ç‚¹ã€‚

ä»¥ä¸‹æ˜¯åˆ›å»ºå¹¶ç­‰å¾…å¤šä¸ªçº¿ç¨‹å®Œæˆçš„ç¤ºä¾‹ï¼š

![](img/64b1bb3e614ededb837725c35b26ce80_56.png)

![](img/64b1bb3e614ededb837725c35b26ce80_58.png)

```cpp
#include <iostream>
#include <thread>
#include <vector>
#include <mutex>

![](img/64b1bb3e614ededb837725c35b26ce80_60.png)

std::mutex mtx;
const int kNumThreads = 10;

![](img/64b1bb3e614ededb837725c35b26ce80_62.png)

void worker(int id) {
    std::lock_guard<std::mutex> lock(mtx);
    std::cout << "Thread " << id << " is working." << std::endl;
}

int main() {
    std::vector<std::thread> threads;

    // å¯åŠ¨æ‰€æœ‰çº¿ç¨‹
    for (int i = 0; i < kNumThreads; ++i) {
        // å°†çº¿ç¨‹å¯¹è±¡æ”¾å…¥å‘é‡ã€‚æ³¨æ„ï¼šstd::threadä¸å¯å¤åˆ¶ï¼Œå¿…é¡»ä½¿ç”¨std::move
        threads.emplace_back(worker, i);
    }

    // ç­‰å¾…æ‰€æœ‰çº¿ç¨‹å®Œæˆ
    for (std::thread& t : threads) {
        t.join(); // å¿…é¡»é€šè¿‡å¼•ç”¨è®¿é—®vectorä¸­çš„çº¿ç¨‹å¯¹è±¡
    }

    std::cout << "All threads finished." << std::endl;
    return 0;
}
```

**å…³é”®ç‚¹**ï¼š
*   `threads.emplace_back(worker, i);` ç›´æ¥åœ¨å‘é‡æœ«å°¾æ„é€ ä¸€ä¸ª `std::thread` å¯¹è±¡ï¼Œé¿å…äº†æ‹·è´æ“ä½œï¼ˆå› ä¸º `std::thread` ä¸å¯æ‹·è´ï¼‰ã€‚
*   å¿…é¡»ä½¿ç”¨å¼•ç”¨ `for (std::thread& t : threads)` æ¥éå†çº¿ç¨‹å‘é‡ï¼Œä»¥ä¾¿è°ƒç”¨ `join()` æ–¹æ³•ã€‚
*   å…ˆå¯åŠ¨æ‰€æœ‰çº¿ç¨‹ï¼Œå†ç»Ÿä¸€ç­‰å¾…å®ƒä»¬ç»“æŸï¼Œè¿™æ ·æ‰èƒ½å®ç°çœŸæ­£çš„å¹¶è¡Œã€‚å¦‚æœå¯åŠ¨ä¸€ä¸ªçº¿ç¨‹åç«‹å³ `join`ï¼Œå°±ä¼šå˜æˆä¸²è¡Œæ‰§è¡Œã€‚

---

## åŸå­æ“ä½œ âš›ï¸

å¯¹äºç®€å•çš„å…±äº«å˜é‡æ“ä½œï¼Œé™¤äº†ä½¿ç”¨é”ï¼Œè¿˜å¯ä»¥ä½¿ç”¨**åŸå­ç±»å‹**ã€‚åŸå­æ“ä½œä¿è¯è¯¥æ“ä½œä»ä»»ä½•çº¿ç¨‹çš„è§’åº¦çœ‹éƒ½æ˜¯ç¬é—´å®Œæˆçš„ï¼Œä¸ä¼šè¢«ä¸­æ–­ã€‚

![](img/64b1bb3e614ededb837725c35b26ce80_64.png)

![](img/64b1bb3e614ededb837725c35b26ce80_66.png)

```cpp
#include <iostream>
#include <thread>
#include <atomic>

std::atomic<int> counter(0); // åŸå­æ•´æ•°

![](img/64b1bb3e614ededb837725c35b26ce80_68.png)

![](img/64b1bb3e614ededb837725c35b26ce80_70.png)

void increment() {
    for (int i = 0; i < 1000; ++i) {
        counter.fetch_add(1); // åŸå­åŠ æ³•
        // ç­‰ä»·äº counter++
    }
}

int main() {
    std::thread t1(increment);
    std::thread t2(increment);

    t1.join();
    t2.join();

    std::cout << "Counter = " << counter << std::endl; // æ€»æ˜¯2000
    return 0;
}
```
ä½¿ç”¨ `std::atomic` é€šå¸¸æ¯”ä½¿ç”¨é”çš„æ€§èƒ½å¼€é”€æ›´å°ï¼Œä½†å®ƒåªé€‚ç”¨äºå¯¹å•ä¸ªå˜é‡çš„æ“ä½œã€‚å¯¹äºå¤æ‚çš„ã€æ¶‰åŠå¤šä¸ªå˜é‡çš„é€»è¾‘ï¼Œä»ç„¶éœ€è¦é”æ¥ä¿æŠ¤ã€‚

---

![](img/64b1bb3e614ededb837725c35b26ce80_72.png)

## æ€»ç»“ä¸åç»­å­¦ä¹ è·¯å¾„ ğŸ“

![](img/64b1bb3e614ededb837725c35b26ce80_74.png)

æœ¬èŠ‚è¯¾ä¸­æˆ‘ä»¬ä¸€èµ·å­¦ä¹ äº†C++å¤šçº¿ç¨‹ç¼–ç¨‹çš„åŸºç¡€ï¼š
1.  **åŠ¨æœº**ï¼šå¤šçº¿ç¨‹èƒ½æœ‰æ•ˆåˆ©ç”¨CPUèµ„æºï¼Œå°¤å…¶åœ¨å­˜åœ¨I/Oç­‰å¾…çš„åœºæ™¯ä¸‹ã€‚
2.  **çº¿ç¨‹åˆ›å»º**ï¼šä½¿ç”¨ `std::thread` ç±»ï¼Œå¹¶ä¼ é€’è¦æ‰§è¡Œçš„å‡½æ•°åŠå‚æ•°ã€‚
3.  **çº¿ç¨‹åŒæ­¥**ï¼šå¿…é¡»ä½¿ç”¨ `join()` ç­‰å¾…å­çº¿ç¨‹ç»“æŸï¼Œé˜²æ­¢ä¸»çº¿ç¨‹æå‰é€€å‡ºã€‚
4.  **æ•°æ®ç«äº‰**ï¼šå¤šä¸ªçº¿ç¨‹æ— åºè®¿é—®å…±äº«æ•°æ®ä¼šå¯¼è‡´æœªå®šä¹‰è¡Œä¸ºã€‚
5.  **é”**ï¼šä½¿ç”¨ `std::mutex` å’Œ `std::lock_guard`ï¼ˆRAIIåŒ…è£…å™¨ï¼‰ä¿æŠ¤ä¸´ç•ŒåŒºï¼Œç¡®ä¿çº¿ç¨‹å®‰å…¨ã€‚
6.  **åŸå­æ“ä½œ**ï¼šä½¿ç”¨ `std::atomic` ç±»å‹å¯¹ç®€å•å˜é‡è¿›è¡Œçº¿ç¨‹å®‰å…¨çš„æ“ä½œã€‚
7.  **ç®¡ç†çº¿ç¨‹**ï¼šä½¿ç”¨å®¹å™¨ï¼ˆå¦‚ `std::vector`ï¼‰æ¥ç®¡ç†å¤šä¸ªçº¿ç¨‹å¯¹è±¡ã€‚

å¤šçº¿ç¨‹ç¼–ç¨‹æ˜¯ä¸€ä¸ªå¤æ‚ä½†å¼ºå¤§çš„ä¸»é¢˜ã€‚è¦æ·±å…¥æŒæ¡ï¼Œå»ºè®®ï¼š
*   **å¤šå®è·µ**ï¼šåœ¨ä¸ªäººé¡¹ç›®æˆ–å·¥ä½œä¸­å°è¯•ä½¿ç”¨å¤šçº¿ç¨‹ã€‚
*   **é˜…è¯»ç»å…¸ä¹¦ç±**ï¼šå¦‚ã€ŠEffective Modern C++ã€‹ã€‚
*   **å…³æ³¨ä¸“å®¶åšå®¢**ï¼šå¦‚C++æ ‡å‡†å§”å‘˜ä¼šæˆå‘˜Herb Sutterçš„åšå®¢ã€‚
*   **å­¦ä¹ ç³»ç»Ÿè¯¾ç¨‹**ï¼šå¦‚CS110ï¼Œæ·±å…¥äº†è§£æ“ä½œç³»ç»Ÿå±‚é¢çš„çº¿ç¨‹è°ƒåº¦ã€åŒæ­¥åŸè¯­ç­‰ã€‚

![](img/64b1bb3e614ededb837725c35b26ce80_76.png)

æ­å–œä½ å®Œæˆäº†CS106Lè¯¾ç¨‹çš„æ ¸å¿ƒå†…å®¹å­¦ä¹ ï¼å¸Œæœ›è¿™äº›çŸ¥è¯†èƒ½ä¸ºä½ çš„ç¼–ç¨‹ä¹‹æ—…æ‰“ä¸‹åšå®çš„åŸºç¡€ã€‚