![](img/ec4a5cd07c1d687808d1979566f0bbf9_0.png)

![](img/ec4a5cd07c1d687808d1979566f0bbf9_2.png)

![](img/ec4a5cd07c1d687808d1979566f0bbf9_4.png)

![](img/ec4a5cd07c1d687808d1979566f0bbf9_6.png)

# 课程 P28：第21讲 - RISC-V 五级流水线 I 🚀

![](img/ec4a5cd07c1d687808d1979566f0bbf9_8.png)

![](img/ec4a5cd07c1d687808d1979566f0bbf9_10.png)

在本节课中，我们将要学习计算机性能的核心概念，并首次探讨如何通过流水线技术来提升处理器的性能。我们将从理解性能的衡量标准开始，逐步深入到流水线的基本思想，为后续构建更高效的RISC-V CPU打下基础。

![](img/ec4a5cd07c1d687808d1979566f0bbf9_12.png)

![](img/ec4a5cd07c1d687808d1979566f0bbf9_14.png)

![](img/ec4a5cd07c1d687808d1979566f0bbf9_16.png)

![](img/ec4a5cd07c1d687808d1979566f0bbf9_18.png)

![](img/ec4a5cd07c1d687808d1979566f0bbf9_20.png)

![](img/ec4a5cd07c1d687808d1979566f0bbf9_22.png)

![](img/ec4a5cd07c1d687808d1979566f0bbf9_24.png)

![](img/ec4a5cd07c1d687808d1979566f0bbf9_26.png)

## 概述：性能、效率与流水线

![](img/ec4a5cd07c1d687808d1979566f0bbf9_28.png)

![](img/ec4a5cd07c1d687808d1979566f0bbf9_30.png)

![](img/ec4a5cd07c1d687808d1979566f0bbf9_32.png)

上一节我们完成了单周期RISC-V CPU的设计，确保它能正确工作。本节中，我们来看看如何让它运行得更快。我们将学习如何衡量和改进计算机的性能，并引入“流水线”这一关键概念，它就像一条高效的装配线，能显著提升处理器的吞吐量。

![](img/ec4a5cd07c1d687808d1979566f0bbf9_34.png)

![](img/ec4a5cd07c1d687808d1979566f0bbf9_36.png)

## 性能的衡量标准 🏎️

![](img/ec4a5cd07c1d687808d1979566f0bbf9_38.png)

我们首先需要定义什么是“性能”。对于计算机而言，性能可以从三个不同角度衡量：

![](img/ec4a5cd07c1d687808d1979566f0bbf9_40.png)

![](img/ec4a5cd07c1d687808d1979566f0bbf9_42.png)

![](img/ec4a5cd07c1d687808d1979566f0bbf9_44.png)

![](img/ec4a5cd07c1d687808d1979566f0bbf9_46.png)

![](img/ec4a5cd07c1d687808d1979566f0bbf9_48.png)

![](img/ec4a5cd07c1d687808d1979566f0bbf9_50.png)

1.  **响应时间**：完成单个任务所需的时间。例如，执行一条指令的时间。
2.  **吞吐量**：单位时间内完成的工作总量。例如，处理器每秒能执行多少条指令。
3.  **能效**：完成每单位任务所消耗的能量。这对于移动设备和数据中心至关重要。

![](img/ec4a5cd07c1d687808d1979566f0bbf9_52.png)

![](img/ec4a5cd07c1d687808d1979566f0bbf9_54.png)

![](img/ec4a5cd07c1d687808d1979566f0bbf9_56.png)

![](img/ec4a5cd07c1d687808d1979566f0bbf9_58.png)

![](img/ec4a5cd07c1d687808d1979566f0bbf9_60.png)

这三者之间的关系可以用一个经典公式描述，即 **性能“铁律”**：

![](img/ec4a5cd07c1d687808d1979566f0bbf9_62.png)

![](img/ec4a5cd07c1d687808d1979566f0bbf9_64.png)

![](img/ec4a5cd07c1d687808d1979566f0bbf9_66.png)

![](img/ec4a5cd07c1d687808d1979566f0bbf9_68.png)

![](img/ec4a5cd07c1d687808d1979566f0bbf9_70.png)

![](img/ec4a5cd07c1d687808d1979566f0bbf9_72.png)

**程序执行时间 = 指令数 × 每条指令平均时钟周期数 × 时钟周期时间**

![](img/ec4a5cd07c1d687808d1979566f0bbf9_74.png)

![](img/ec4a5cd07c1d687808d1979566f0bbf9_76.png)

![](img/ec4a5cd07c1d687808d1979566f0bbf9_78.png)

*   **指令数**：由程序算法、编程语言和编译器优化决定。
*   **CPI**：平均每条指令所需的时钟周期数，由处理器架构（ISA）和具体实现（微架构）决定。
*   **时钟周期时间**：由硬件工艺、关键路径延迟和功耗预算决定。

![](img/ec4a5cd07c1d687808d1979566f0bbf9_80.png)

![](img/ec4a5cd07c1d687808d1979566f0bbf9_82.png)

![](img/ec4a5cd07c1d687808d1979566f0bbf9_84.png)

![](img/ec4a5cd07c1d687808d1979566f0bbf9_86.png)

![](img/ec4a5cd07c1d687808d1979566f0bbf9_88.png)

![](img/ec4a5cd07c1d687808d1979566f0bbf9_90.png)

![](img/ec4a5cd07c1d687808d1979566f0bbf9_92.png)

我们的单周期RISC-V CPU的CPI为1，但时钟周期很长（800皮秒），因为它必须在一个周期内完成所有工作。我们的目标是提高吞吐量。

![](img/ec4a5cd07c1d687808d1979566f0bbf9_94.png)

![](img/ec4a5cd07c1d687808d1979566f0bbf9_96.png)

![](img/ec4a5cd07c1d687808d1979566f0bbf9_98.png)

![](img/ec4a5cd07c1d687808d1979566f0bbf9_100.png)

![](img/ec4a5cd07c1d687808d1979566f0bbf9_102.png)

![](img/ec4a5cd07c1d687808d1979566f0bbf9_104.png)

## 能效的考量 🔋

![](img/ec4a5cd07c1d687808d1979566f0bbf9_106.png)

![](img/ec4a5cd07c1d687808d1979566f0bbf9_108.png)

![](img/ec4a5cd07c1d687808d1979566f0bbf9_110.png)

![](img/ec4a5cd07c1d687808d1979566f0bbf9_112.png)

![](img/ec4a5cd07c1d687808d1979566f0bbf9_114.png)

随着设备小型化和对续航、散热的重视，能效变得和性能同等重要。在CMOS电路中，动态功耗主要来自对电容的充放电：

![](img/ec4a5cd07c1d687808d1979566f0bbf9_116.png)

![](img/ec4a5cd07c1d687808d1979566f0bbf9_118.png)

![](img/ec4a5cd07c1d687808d1979566f0bbf9_120.png)

![](img/ec4a5cd07c1d687808d1979566f0bbf9_122.png)

![](img/ec4a5cd07c1d687808d1979566f0bbf9_124.png)

**功耗 ∝ 电容 × 电压² × 频率**

![](img/ec4a5cd07c1d687808d1979566f0bbf9_126.png)

![](img/ec4a5cd07c1d687808d1979566f0bbf9_128.png)

![](img/ec4a5cd07c1d687808d1979566f0bbf9_130.png)

因此，降低电压对减少功耗有极其显著的效果（平方关系）。然而，电压降低会减慢晶体管速度，并且存在泄漏功耗等问题。历史上，约2005年出现的“功耗墙”迫使处理器设计从单纯提升主频，转向了增加核心数量（并行化）和提升能效。

![](img/ec4a5cd07c1d687808d1979566f0bbf9_132.png)

![](img/ec4a5cd07c1d687808d1979566f0bbf9_134.png)

![](img/ec4a5cd07c1d687808d1979566f0bbf9_136.png)

![](img/ec4a5cd07c1d687808d1979566f0bbf9_138.png)

![](img/ec4a5cd07c1d687808d1979566f0bbf9_140.png)

## 流水线的基本思想 🧺

![](img/ec4a5cd07c1d687808d1979566f0bbf9_142.png)

![](img/ec4a5cd07c1d687808d1979566f0bbf9_144.png)

![](img/ec4a5cd07c1d687808d1979566f0bbf9_146.png)

![](img/ec4a5cd07c1d687808d1979566f0bbf9_148.png)

![](img/ec4a5cd07c1d687808d1979566f0bbf9_150.png)

![](img/ec4a5cd07c1d687808d1979566f0bbf9_152.png)

流水线的灵感来源于日常生活中的装配线，例如洗衣房的工作流程。

![](img/ec4a5cd07c1d687808d1979566f0bbf9_154.png)

![](img/ec4a5cd07c1d687808d1979566f0bbf9_156.png)

![](img/ec4a5cd07c1d687808d1979566f0bbf9_158.png)

![](img/ec4a5cd07c1d687808d1979566f0bbf9_160.png)

![](img/ec4a5cd07c1d687808d1979566f0bbf9_162.png)

![](img/ec4a5cd07c1d687808d1979566f0bbf9_164.png)

假设洗衣服有四个阶段（洗涤、烘干、折叠、收纳），每个阶段需要30分钟。
*   **非流水线（单周期）方式**：一个人完成所有四个阶段后，下一个人才能开始。4批衣服需要 **8小时**。
*   **流水线方式**：当第一个人完成洗涤进入烘干阶段时，第二个人可以立即开始洗涤，以此类推。4批衣服仅需 **3.5小时**。

![](img/ec4a5cd07c1d687808d1979566f0bbf9_166.png)

![](img/ec4a5cd07c1d687808d1979566f0bbf9_168.png)

![](img/ec4a5cd07c1d687808d1979566f0bbf9_170.png)

![](img/ec4a5cd07c1d687808d1979566f0bbf9_172.png)

![](img/ec4a5cd07c1d687808d1979566f0bbf9_174.png)

以下是流水线的关键特点：
*   **提高吞吐量**：多个任务在不同阶段同时进行，单位时间内完成的工作量大大增加。
*   **不减少延迟**：单个任务完成所需的总时间（延迟）可能不变甚至略有增加。
*   **受限于最慢阶段**：整个流水线的速度取决于其中最慢的那个阶段。阶段时长不平衡会降低效率。
*   **存在填充和排空开销**：流水线启动时需要时间填满所有阶段，结束时也需要时间排空，这期间效率并非100%。

![](img/ec4a5cd07c1d687808d1979566f0bbf9_176.png)

![](img/ec4a5cd07c1d687808d1979566f0bbf9_178.png)

![](img/ec4a5cd07c1d687808d1979566f0bbf9_180.png)

## 从洗衣房到处理器 💻

这个类比完美对应到处理器设计。我们的单周期CPU就像非流水线洗衣房，在一条指令执行过程中的每个阶段（取指、译码、执行、访存、写回），大部分硬件在大部分时间里都是闲置的。

![](img/ec4a5cd07c1d687808d1979566f0bbf9_182.png)

![](img/ec4a5cd07c1d687808d1979566f0bbf9_184.png)

![](img/ec4a5cd07c1d687808d1979566f0bbf9_186.png)

通过引入流水线，我们将指令执行过程划分为五个固定的阶段，并在每个阶段之间插入寄存器来隔离它们。这样，就像洗衣房一样，当第一条指令进入“执行”阶段时，第二条指令就可以进入“译码”阶段，第三条指令可以开始“取指”，从而实现多条指令的重叠执行，极大提高了吞吐量。

![](img/ec4a5cd07c1d687808d1979566f0bbf9_188.png)

理论上，一个五级流水线可以获得接近5倍的吞吐量提升（假设阶段平衡且无冲突）。

![](img/ec4a5cd07c1d687808d1979566f0bbf9_190.png)

![](img/ec4a5cd07c1d687808d1979566f0bbf9_192.png)

![](img/ec4a5cd07c1d687808d1979566f0bbf9_194.png)

![](img/ec4a5cd07c1d687808d1979566f0bbf9_196.png)

![](img/ec4a5cd07c1d687808d1979566f0bbf9_198.png)

## 总结与展望

![](img/ec4a5cd07c1d687808d1979566f0bbf9_200.png)

![](img/ec4a5cd07c1d687808d1979566f0bbf9_202.png)

![](img/ec4a5cd07c1d687808d1979566f0bbf9_204.png)

![](img/ec4a5cd07c1d687808d1979566f0bbf9_206.png)

本节课中我们一起学习了：
1.  衡量计算机性能的三大指标：响应时间、吞吐量和能效。
2.  决定程序执行时间的“铁律”公式。
3.  功耗与电压、电容的密切关系，以及“功耗墙”如何改变了处理器的发展方向。
4.  **流水线**的核心思想——通过任务重叠执行来提高吞吐量，并理解了其优势和限制（如延迟不变、阶段平衡、填充/排空开销）。

![](img/ec4a5cd07c1d687808d1979566f0bbf9_208.png)

![](img/ec4a5cd07c1d687808d1979566f0bbf9_210.png)

![](img/ec4a5cd07c1d687808d1979566f0bbf9_212.png)

![](img/ec4a5cd07c1d687808d1979566f0bbf9_214.png)

![](img/ec4a5cd07c1d687808d1979566f0bbf9_216.png)

![](img/ec4a5cd07c1d687808d1979566f0bbf9_218.png)

下一节课，我们将把洗衣房的流水线思想具体应用到RISC-V CPU的设计中，开始构建我们的五级流水线处理器，并深入探讨其中需要解决的技术挑战。