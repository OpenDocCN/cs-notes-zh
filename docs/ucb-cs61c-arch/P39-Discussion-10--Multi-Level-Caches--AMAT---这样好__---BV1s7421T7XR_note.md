![](img/23f22431f9f1c85f30d50e9809dac8fd_0.png)

# 课程 P39：多级缓存与平均内存访问时间 (AMAT) 🧠💾

在本节课中，我们将深入探讨缓存系统的核心概念，特别是多级缓存的组织方式以及如何评估其性能。我们将学习如何计算平均内存访问时间，并理解不同类型的缓存未命中及其影响。

## 概述 📋

缓存是计算机系统中用于提升数据访问速度的关键组件。它利用了程序访问数据的**空间局部性**和**时间局部性**。空间局部性指程序倾向于访问彼此邻近的内存地址；时间局部性指程序可能重复访问相同的数据。通过将近期使用的数据存储在更靠近处理器的快速存储器中，可以显著减少访问主内存的漫长等待时间。

上一节我们介绍了缓存的基本思想，本节中我们来看看缓存的具体组织方式、访问流程以及性能评估方法。

## 缓存基础回顾 🔄

我们需要缓存的主要原因是为了利用空间局部性和时间局部性。如果你知道将要访问内存中彼此靠近的位置，缓存可以让这个过程更快。同样，如果你知道稍后需要再次访问某个数据项，缓存也非常适合时间局部性，因为它可以存储最近使用的项目。

从缓存访问周期时间来看，从L1或L2缓存获取项目的时间比访问物理内存要短得多。

以下是一些核心术语：
*   **缓存行**：也称为块，是存储在缓存中的一组连续内存单元。
*   **组**：由多个缓存行组成，可以通过索引来定位。
*   **关联度**：组成一个集合所需的缓存行数量。
*   **驱逐**：当缓存已满时，用于移除旧缓存行以便为新数据腾出空间的策略。

## 缓存地址分解 🧩

为了在缓存中定位数据，内存地址被分解为几个部分：**标记**、**索引**和**偏移量**。

*   **标记**：是缓存行的唯一标识符，由内存地址的最高有效位组成。
*   **索引**：用于指定缓存中集合的编号。对于直接映射缓存，它指向特定的块；对于组相联缓存，它指向特定的组。
*   **偏移量**：用于在缓存行（块）内部索引，以获取所需的具体字节。

以下是计算各部分位数的公式：
*   偏移量位数 = **log₂(块大小)**
*   索引位数 = **log₂(集合数量)** = **log₂(缓存大小 / (关联度 × 块大小))**
*   标记位数 = **地址总位数 - 索引位数 - 偏移量位数**

例如，给定一个32字节的缓存，块大小为8字节，直接映射（关联度为1）：
*   块数量 = 32 / 8 = 4
*   索引位数 = log₂(4) = 2
*   偏移量位数 = log₂(8) = 3
*   标记位数 = 假设地址空间为8位，则 8 - 2 - 3 = 3

## 缓存组织方案 🗂️

主要有三种缓存组织方案：

1.  **直接映射缓存**：每个内存块只能映射到缓存中的一个特定位置。结构简单，但容易发生冲突。
2.  **全相联缓存**：任何内存块可以放入缓存中的任何位置。冲突最少，但查找速度慢（需要比较所有标记）。
3.  **N路组相联缓存**：缓存被分为多个组，每个组有N个块。一个内存块可以映射到特定组内的任何位置。这是直接映射和全相联之间的折中方案。

## 缓存替换策略 🔄

当缓存已满且需要放入新数据时，必须决定驱逐哪个旧块。以下是常见的替换策略：

*   **先进先出**：驱逐在集合中停留时间最长的块。
*   **最近最少使用**：驱逐在集合中最近被访问时间最早的块。

哪种策略最好？这取决于具体的工作负载和设计目标（如实现简单性、效率）。不存在绝对“最佳”的策略。

## 缓存访问流程与未命中类型 ❌

访问缓存的基本流程是：首先根据索引找到对应的组，然后比较该组内所有块的标记。如果找到匹配的标记且数据有效，则为**命中**，根据偏移量读取数据。否则，发生**未命中**，需要从下级存储器（如L2缓存或主存）加载数据块。

缓存未命中主要有三种类型：

1.  **强制性未命中**：由于数据从未被加载到缓存中而导致的未命中。这是不可避免的。
2.  **冲突未命中**：在组相联或直接映射缓存中，因为多个内存块映射到同一个缓存组/行，导致一个块被驱逐，而后又被访问所造成的未命中。
3.  **容量未命中**：缓存容量不足，无法容纳工作集的所有数据块，导致一些块被驱逐后又需要被访问所造成的未命中。

增加缓存容量可以减少容量未命中；增加关联度可以减少冲突未命中。

## 写策略 ✍️

当处理器需要写入数据时，缓存系统有两种主要策略：

1.  **写直达**：数据同时写入缓存和主存。实现简单，保持了一致性，但每次写操作都访问慢速主存，效率低。
2.  **写回**：数据只写入缓存，并标记该缓存行为“脏”。仅当该脏块被驱逐时，才将其写回主存。效率高，减少了主存访问，但实现更复杂，需要额外的“脏位”元数据。

此外，对于写操作未命中的情况，也有两种策略：
*   **写分配**：将所需数据块从主存加载到缓存，然后在缓存中完成写操作（通常配合写回策略）。
*   **写不分配**：直接将数据写入主存，而不将其加载到缓存。

## 平均内存访问时间 ⏱️

**平均内存访问时间** 是衡量缓存系统性能的关键指标，它表示平均访问一次内存所需的时间。

其计算公式为：
**AMAT = 命中时间 + 未命中率 × 未命中惩罚**

*   **命中时间**：在缓存中找到数据所需的访问时间。
*   **未命中率**：访问缓存时发生未命中的概率。
*   **未命中惩罚**：处理一次未命中所需的时间，包括从下级存储器加载数据的时间。

对于多级缓存（如L1和L2），AMAT的计算可以递归进行：
**AMAT = L1命中时间 + L1未命中率 × (L2命中时间 + L2未命中率 × L2未命中惩罚)**

我们的目标是尽可能降低AMAT。

## 总结 🎯

本节课中我们一起学习了缓存系统的核心知识。我们回顾了缓存存在的原因——利用局部性原理。我们详细探讨了如何将内存地址分解为标记、索引和偏移量，并介绍了三种主要的缓存组织方案：直接映射、全相联和组相联。我们还了解了当缓存满时如何选择被替换的块，以及写操作的不同处理策略。

![](img/23f22431f9f1c85f30d50e9809dac8fd_2.png)

最后，我们学习了评估缓存性能的重要指标——平均内存访问时间，并掌握了其计算方法。理解这些概念对于分析和设计高效的存储层次结构至关重要。