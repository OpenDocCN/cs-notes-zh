# 第 27 讲 - 演示，预订

### 公共服务公告

1.  期末考试日期：8 月 7 日上午 9 点至 8 月 9 日上午 11 点 30 分

1.  里程碑 2 的黄金标准是

    +   轨道上有两列火车

    +   每次到达当前目的地时，每个火车都会接收一个新的随机目的地。

    +   运行大约五分钟

* * *

## 典型的预订系统

预订系统不是防止火车相撞的唯一方法。

下面描述的预订系统不是唯一有效的预订系统。我创建它是为了说明你必须解决的问题类型，以避免火车相撞。

在过去的学期中，学生已经成功使用

+   与下面描述的类似的系统

+   没有将轨道分成区块但提供任意大小预订的系统

+   给出预订的系统是覆盖轨道而不是轨道长度的区域。

通过在 CPU 上进行更多计算来减少与火车控制器的通信需求始终表现优异。

##### 严格条件

避免碰撞所需

1.  **每一列火车必须为其所占用的轨道预订。

1.  **每一列火车必须以足够低的速度行驶，以便在其预订的轨道结束前停下来。

1.  **每一列火车应该预订足够处理单个传感器或（独占）单个开关错误的区块。

1.  **任何一段轨道都不应该被多于一列火车预订。

##### 软条件

保持火车运行所需

1.  每一列火车必须释放它不再占用并且不会在不久的将来占用的区块。

1.  每一列火车持有的预订必须是连续的

1.  如果火车减速或停止，火车应该释放其前方不需要的区块。

    +   停止的火车将占据一个或两个区块。

    +   如果你不执行这个条件，你的系统将在只有两列火车时表现得很好，但在发生冻结时它经常会自发解冻。

##### 谁来执行这些条件？

+   没有人明确这样做。

+   从上述条件中派生出的约束条件，例如

    1.  预订服务器总是提供连续的预订。

    1.  预订服务器从不提供已经预订的轨道段。

    1.  预订服务器从不取消预订。

    1.  火车始终以足够缓慢的速度行驶，以便在拒绝延长请求时可以在当前预订内停下来。

    1.  依此类推。

+   执行由每个任务遵守的协议提供。

是否存在无法执行条件的情况？

+   是什么？

#### 这是理论上的工作原理

1.  火车从路径查找器那里得到一条路线，并沿着路线向前看。

    +   火车有一个期望的速度。

1.  火车向预订系统请求沿途的几个区块轨道

    +   区块通常在开关和/或传感器处结束

    +   如果你在开关处结束区块，你必须足够了解火车的位置，以确保它完全清除开关。

1.  预订系统如果可用则授予区块

    +   授予意味着火车必须以能够在不离开任何预约区块的情况下完全停下来的方式行驶。

    +   授予必须按正确顺序提供

#### 这是它在实践中运作的一种方式

1.  火车收到一个预约，允许它以所需速度行驶一个或多个区块。

    +   预约包括这些区段末尾足够的轨道，以便火车在到达其预约结束前停下来。

1.  每次火车离开一个区块时，它会释放该区块的预约。

1.  在达到可以以速度行驶的区段的末尾之前，请求延长其预约。

1.  如果请求被授予并且可以在预约内停下来，它将以速度继续行驶。

    +   否则停下来

        或者减速到足以在预约结束前停下来。

#### 预约实施

你可能会决定，每次火车接收到传感器报告时都会进行预约协商。

+   只是在需要时请求预约存在问题。

+   火车司机很可能会轮询

+   轮询极度依赖优先级。

+   依赖优先级的错误很难找到，更难修复。

每次火车接收到传感器报告时都会执行其预约程序

1.  释放刚刚空出的预约

1.  在下一个请求时间（传感器报告）内测试在预约内停止。

1.  如果没问题，完成

1.  如果不行，我需要超出当前预约多少？

1.  请求所需的内容，可能更多

    +   指示您希望预约的顺序（连续性）。

    +   这取决于您的行进方向，预约服务器无需知道这一点。

    +   预约服务器可能已经推断出，但为什么要麻烦呢。

1.  预约服务器尽可能提供

1.  火车使用完整预约重新检查停止条件。

1.  如果没问题，完成

1.  如果不行，要么

    +   停止，

    或者

    +   减速以满足停止条件

**评论。** 我们喜欢减速，我们认为这是对跟随慢车的更智能和美学的回应，而不是启停驾驶。

* * *

## 我多次看到的问题

### 常见的多列车跟踪问题

1.  两列火车等待同一传感器报告

    +   症状：列车分裂和/或合并

    +   一个人注定会得到不一致的状态

    +   应该由预约系统解决

1.  误报火车实际期望的传感器报告。

    +   大多数情况下用于次要预测，

        +   因为次要预测的时间窗口可以在主要预测的时间窗口之前。

    +   缩小时间窗口有助于解决这个问题

        +   但不能消除它

    +   可以进一步向前看，以便次要预测始终落后于主要预测

    +   通过回溯从此类错误中恢复

1.  永久故障的道岔

    +   无法切换或总是脱轨

    +   更改轨道图

        +   能够从提示符中更改轨道图很重要

        +   部分用于测试，但不要在演示版本中禁用它，因为它可以拯救演示。

1.  永久故障的传感器

    +   通常因为卡住而失败

    +   通过手动解除卡住

    +   修改轨道图和屏蔽报告

        +   请参见上面的轨道图

        +   尽可能低级别地屏蔽

##### 有用的调试辅助工具

1.  从提示符中修改轨道图。

1.  从提示符中模拟传感器触发。

1.  从低级别记录改变轨道状态的事件。

    +   它们是否与 UI 中显示的轨道状态一致？

### 常见的预约系统问题

1.  系统冻结

    +   预约向前延伸并覆盖大部分轨道

    +   火车在减速时会释放不需要的预约

1.  预约未释放。

    +   通常只有在项目进展顺利时才会显示出来

    +   系统中似乎有幻影火车

    +   通常会释放大部分预约，但不是全部。

1.  预约跳跃

    +   两列火车相向而行；每个都在另一个后面获得预约。

        +   当一列火车跟随另一列火车时也会出现。

    +   按正确顺序请求和/或分配预约

##### 有用的调试辅助工具

1.  从提示符中手动插入/移除预约

1.  从提示符中查询预约（以及持有预约的人）

1.  显示实时预约的轨道图。

    +   一个伙伴观察地图，另一个观察火车

1.  火车只能获得其持有预约的传感器报告。

    +   这通常是火车迷路的最早症状。（编辑评论。我觉得不是“火车迷路”，而是“火车**迷路**”。）

1.  强制在预约服务器中所有预约必须是连续的。

    +   非连续的预约请求是预约系统故障的早期症状。

### 常见的路由查找/跟踪错误

1.  火车在改变方向后在道岔处脱轨

    +   改进加速/减速校准

    +   为两个方向的行驶切换道岔

1.  火车在道岔处脱轨，因为道岔切换

    +   改进加速/减速校准

    +   改进火车跟踪

1.  过晚切换道岔

    +   系统性地处理命令延迟

1.  火车与静止火车相撞

    +   确保静止火车有预约

    +   从提示符中手动插入/移除预约

##### 有用的调试辅助工具

以上所有内容，以及

1.  从提示符中手动添加/删除开关、轨道段

1.  通过修改路由查找器，您可以将所有路线限制在轨道的子集中。

    +   这使您能够解决常见问题，而不受罕见问题的影响。

## 问题的早期迹象

频繁的火车查找。（您不应该每次火车停下来时都重新查找火车。）

* * *

返回：

+   比尔·考恩在 s12 学期的 CS452 讲座笔记

+   比尔·考恩 2012 年春季 CS452 页面

+   比尔·考恩的 CS452 页面

+   比尔·考恩的教学页面

+   比尔·考恩的主页
