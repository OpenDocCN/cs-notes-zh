# 第 30 讲 - 上电

### 公共服务公告

1.  期末考试日期：8 月 7 日上午 9 点至 8 月 9 日上午 11 点 30 分

* * *

## 上电

当您打开电源或按下复位按钮时，在看到`RedBoot>`提示之前会发生什么？

+   上电会断言 CPU 的复位输入

这不是由指令集架构（ISA）确定的。

+   ISA 仅保证 CPU 将（在将来某个时间）将 pc 设置为 0x00000000 并开始执行指令。

在此之前发生的事情，以及 0x00000000 处出现的内容由芯片上 CPU 周围系统的设计确定。

+   Cirrus 提供此功能，而非 ARM。

+   Cirrus 提供的内容非常通用：在其他 SoC 上步骤相同，但细节不同。

可能发生两种相当严格的复位。

1.  打开电源

1.  按下复位按钮

    +   上电，但内存刷新持续运行。

（跳转到 0x00000000 是一种更温和的复位。）

施加 SoC 的复位输入，会使 SoC 的复位输出断言。

+   输出复位到处都去，用上电复位重置所有内容。

取消复位输入会启动引导序列，SoC 处于复位状态。十个硬件输入确定 SoC 的引导方式

+   内部/外部

+   预启动源

+   看门狗状态

+   预启动和预预启动的总线宽度

这些输入允许承载 SoC 的板设计者确定引导状态的足够特性，以便用于许多应用

TS-7200 设置为内部预启动，源自 32 位 AHB 上的闪存

AHB 总线具有所有重要的高速组件

+   内存（程序和图形）

+   以太网控制器

+   USB 控制器

+   `0x80090000`处有 16K 字节的掩模编程 ROM

### 初始状态

#### ARM

以下通过系统控制协处理器控制的事物，由 CPU 架构确定。它们必须独立于 Cirrus 添加的内容

1.  MMU 平坦，但软复位可能不同

1.  缓存禁用

1.  总线时钟慢

1.  禁用中断

1.  小端内存系统

1.  无法访问 MMU 寄存器

1.  正常异常寄存器

#### Cirrus

以下在 EP9302 文档中描述的事物是 Cirrus 添加的硬件属性。它们独立于 Technologic 在设计 TS7200 时配置芯片的方式。

1.  DRAM 控制器未初始化

1.  闪存控制器未初始化

1.  所有 I/O 设备处于复位状态。（它们从 CPU 接收硬件复位输入。）

1.  引导模式下的内存映射

#### Technologic

以下在 Technologic 文档、手册和电路图中描述的事物是 TS7200 的属性

1.  引导控制位，设置为正常引导，32 位总线宽度，同步引导设备，内部，看门狗定时器禁用。

1.  物理内存映射

    +   0x80000000 至 0x800fffff，由 Cirrus 用于芯片上的组件

    +   SDRAM 芯片将内存分为 4M 块。4M 块的地址为

        +   `0x00000000`至`0x003fffff`

        +   `0x00400000`至`0x007fffff`

        +   `0x00800000`至`0x00bfffff`

        +   `0x00c00000`至`0x00ffffff`

        +   `0x01000000`至`0x013fffff`

        +   ...

    +   TS7200 使用 4 位芯片选择将内存分成 256 M 字节块

        +   0x00000000 至 0x0fffffff（前 256M）SDRAM，CS0，32 总线周期

        +   0x10000000 至 0x1fffffff：CS1，8 位总线周期

        +   0x20000000 至 0x2fffffff：CS2，16 位总线周期

        +   0x60000000 至 0x7fffffff：CS6/7，闪存

        +   0x80000000 至 0x8fffffff：包括 I/O 寄存器

            +   0x80000000 至 0x807fffff：AHB 映射寄存器，包括

                +   DMA

                +   以太网

                +   USB

                +   内存控制器

                +   预预引导 ROM

                +   ICU 寄存器

            +   0x80800000 至 0x8fffffff：I/O 寄存器

        SDRAM 芯片将内存分成 4M 块。 4M 块的地址为

    +   `0x00000000`至`0x003fffff`

    +   `0x00400000`至`0x007fffff`

    +   `0x00800000`至`0x00bfffff`

    +   `0x00c00000`至`0x00ffffff`

    +   `0x01000000`至`0x013fffff`

    +   ...

1.  在 AHB 寄存器中有一个 16K 的 ROM 块，从`0x80090000`到`0x80093fff`

    +   最初，它被映射到整个内存空间，间隔为 16K。

    +   芯片选择，以及寻址发生的方式。

        +   此块的芯片选择为`0x8009[00XXb]XXX`

        +   芯片选择有两部分

            +   I/O 芯片选择：`0x8XXXXXXX`

            +   AHB 芯片选择：`0xY00XXXXX`

            +   ROM 芯片选择：`0xYYY9[00XXb]XXX`

    +   执行的第一条指令是在`0x80090000`找到的

### 预预引导序列

1.  跳转到`0x80090018.`

1.  打开 LED

1.  使 CPU 完全普通。 例如，

    +   没有缓存，物理内存映射，

1.  关闭看门狗定时器

1.  获取引导状态

1.  配置外部时钟（串行引导所需）

1.  获取引导状态配置输入

    +   这些是 EP9302 上的输入引脚，其状态由 TS7200 确定。

    +   通过跳线器可由用户控制的一对

    +   它们是 EP9302 了解外部世界的唯一事物

1.  使用引导状态配置

    +   闪存存储控制器

    +   SDRAM 内存控制器

    这些配置具有非常保守的参数

1.  清除引导模式`内存映射'

1.  切换 LED

1.  开关

    +   串行引导在 UART1 上

        1.  输出“>”

        1.  从 CRUS 或 SURC 开始读取 2048 字节到以太网缓冲区

        1.  跳转到以太网缓冲区的起始位置

    +   从 SoC 外部的 ROM 引导

        1.  断言 ROM 芯片选择，寻找 CRUS

        1.  当找到时，从 ROM 读取 2048 字节到以太网缓冲区

        1.  跳转到以太网缓冲区的起始位置

    +   从闪存引导

        1.  在可能的闪存起始位置寻找 CRUS

        1.  找到后跳转到起始位置加`0x4（考虑 CRUS）`

        1.  如果找不到

            +   将代码加载到以太网缓冲区

            +   永远闪烁 LED

1.  在前两种情况下，2048 字节包含内存测试，然后是加载程序。

### 预引导序列

此代码完全了解 EP9302，以及 TS7200。

1.  在以太网缓冲区中设置堆栈

1.  将 CPSR 设置为普通状态：无中断，svc 模式

1.  从闪存复制 260 个字的代码到以太网缓冲区

1.  初始化内存控制器以适应其具有的内存

1.  配置 GPIO。

1.  关闭看门狗定时器

1.  为监视器设置适当的串行端口

* * *

返回到：

+   比尔·考恩在 s12 的 CS452 讲座笔记

+   比尔·考恩 2012 年春季的 CS452 页面

+   比尔·考恩的 CS452 页面

+   比尔·考恩的教学页面

+   比尔·考恩的个人主页
