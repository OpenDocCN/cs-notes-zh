![](img/496f15b8d05eec6abd21a1b61e7d39d1_0.png)

# 课程 P18：第19讲 - 虚拟机 🖥️

在本节课中，我们将要学习虚拟机的核心概念、实现原理以及现代硬件如何支持虚拟化。我们将从基础的“陷阱与仿真”方法开始，逐步深入到利用现代处理器硬件支持的虚拟化方案，并探讨一篇名为“沙丘”的研究论文如何利用这些硬件特性来实现新的功能。

---

## 什么是虚拟机？

虚拟机本质上是对一台计算机的精确模拟，其精确程度足以在其上运行一个完整的操作系统。例如，QEMU 就是一个虚拟机软件。

我们可以将虚拟机监视器视为一个取代了标准操作系统内核的软件层。它的工作是为一个或多个“客户”操作系统模拟出多台计算机的硬件环境。

*   **客户空间**：运行客户操作系统及其应用程序的区域。
*   **主机空间**：运行虚拟机监视器自身的区域。

客户操作系统内核（如 Linux 或 Windows）认为自己运行在真实的硬件上，并管理着其上的用户进程。虚拟机监视器的经典目标是提供如此逼真的硬件仿真，以至于未经修改的普通操作系统也能在其中正常运行，且无法察觉自己运行在虚拟环境中。

---

## 为何使用虚拟机？

以下是使用虚拟机的一些主要原因：

![](img/496f15b8d05eec6abd21a1b61e7d39d1_2.png)

*   **服务器整合**：在一台物理服务器上运行多个低资源消耗的服务器实例（如 DNS 服务器、安全服务器），可以节省硬件成本和管理开销。
*   **云计算**：云服务提供商（如 AWS）可以动态地在物理硬件上分配和迁移虚拟机，实现资源的高效利用和灵活管理。
*   **内核开发与调试**：在虚拟机中运行和调试操作系统内核（如本课程使用 QEMU 运行 xv6）比在物理机上更方便、安全。
*   **检查点与迁移**：可以对整个运行中的虚拟机状态进行快照保存，之后恢复或克隆。还可以将运行中的虚拟机迁移到另一台物理主机，实现高可用性或维护。
*   **强隔离与安全**：虚拟机提供了比传统进程更严格的隔离，适合运行不受信任的代码，因为客户机很难突破其虚拟环境去访问主机或其他虚拟机的资源。

虚拟机技术有着悠久的历史，其思想在 20 世纪 60 年代就已提出。如今，许多操作系统领域的研究和创新也转移到了虚拟机监视器这一层。

---

## 如何构建虚拟机监视器？

上一节我们介绍了虚拟机的概念和用途，本节中我们来看看如何实现一个基本的虚拟机监视器。我们将以模拟 RISC-V 硬件来运行为 RISC-V 设计的操作系统（如 xv6）为例。

我们的目标是：客户软件完全无法察觉自己运行在虚拟机中，也无法逃逸出其虚拟环境。

### 陷阱与仿真策略

一种直观但低效的方法是纯软件解释执行每一条客户机指令。但更主流的策略是**直接在真实 CPU 上运行客户机指令**，同时通过“陷阱与仿真”来处理特权操作。

基本思路是：**让客户机内核代码在宿主机的用户模式下运行**。

*   当客户机执行普通非特权指令（如加法、访存）时，这些指令在硬件上全速执行。
*   当客户机尝试执行任何特权指令（如修改页表寄存器 `satp`、访问控制状态寄存器）时，由于它在宿主机的用户模式下，这会触发一个硬件陷阱，将控制权交还给虚拟机监视器。

虚拟机监视器会截获这个陷阱，查看是哪条指令引起的，然后**在软件中模拟**这条特权指令的效果。为此，虚拟机监视器需要为每个客户机维护一份**虚拟硬件状态**（例如虚拟的 `stvec`、`sepc`、`scause` 等寄存器）。

以下是虚拟机监视器需要处理的关键部分：

1.  **模式跟踪**：虚拟机监视器需要记录客户机当前是处于“客户主管模式”还是“客户用户模式”，因为对同一特权指令（如用户模式下的非法指令）的处理方式可能不同。
2.  **系统调用与中断模拟**：当客户机用户程序执行 `ecall` 进行系统调用时，会陷入虚拟机监视器。监视器会更新虚拟状态（如将虚拟模式改为主管，虚拟 `scause` 设为系统调用），然后跳转到客户机操作系统的陷阱处理程序地址（由虚拟 `stvec` 指定）。

---

### 内存虚拟化：影子页表

内存隔离是虚拟机安全的关键。客户机操作系统认为自己设置并控制着页表，将虚拟地址映射到“客户物理地址”。但虚拟机监视器必须控制“客户物理地址”到真实“主机物理地址”的映射。

**策略如下**：
当客户机操作系统尝试通过 `satp` 寄存器加载一个新页表时，这会触发陷阱。虚拟机监视器不会直接使用客户机的页表，而是根据以下两者创建一个**影子页表**：
*   客户机提供的页表（客户虚拟地址 -> 客户物理地址）
*   虚拟机监视器维护的映射表（客户物理地址 -> 主机物理地址）

影子页表将客户虚拟地址直接映射到主机物理地址。然后，虚拟机监视器将这个影子页表设置到真实的 `satp` 寄存器中。这样，客户机只能访问虚拟机监视器分配给它的主机物理内存。

如果客户机直接修改其页表项（PTE），在 RISC-V 中，为了确保硬件能注意到修改，它必须执行 `sfence.vma` 指令。这是一条特权指令，会触发陷阱。虚拟机监视器借此机会重新扫描客户机页表的更改，并更新影子页表。

---

### 设备虚拟化

客户机操作系统期望能与各种硬件设备（如磁盘、网卡、控制台）交互。虚拟机监视器需要提供这些设备的仿真。

主要有三种策略：

1.  **完全仿真**：虚拟机监视器软件模拟一个真实存在的设备（如 16550A UART）。客户机通过内存映射寄存器与设备“通信”，每次访问都会触发陷阱，由监视器模拟设备行为。这种方法简单，但性能较低，适用于低速设备。
2.  **准虚拟化**：设计一套高效的、专为虚拟化环境设计的虚拟设备接口（如 VirtIO）。客户机操作系统需要安装特定的驱动程序，通过共享内存队列等机制与虚拟机监视器通信，大大减少了陷阱次数，性能更高。
3.  **设备直通**：将物理设备（如支持 SR-IOV 的网卡）的一部分直接分配给客户机。客户机驱动程序可以直接与硬件对话，性能最高，但需要硬件支持且失去了设备共享的灵活性。

实现设备仿真是构建实用虚拟机监视器的主要工作之一。

---

## 现代硬件虚拟化支持

上一节我们探讨了基于“陷阱与仿真”的软件虚拟化方案，其性能瓶颈在于频繁的陷阱。本节中我们来看看现代处理器（如 Intel VT-x, AMD-V）提供的硬件虚拟化支持如何解决这个问题。

其核心动机是减少虚拟机环境下的陷阱开销，并简化虚拟机监视器的实现。

### 基本原理：根模式与非根模式

硬件虚拟化引入了新的 CPU 执行模式：
*   **根模式**：虚拟机监视器运行的模式，对硬件有完全控制权。
*   **非根模式**：客户机运行的模式。

关键改进在于，硬件为**非根模式**维护了完整且独立的一套“虚拟”控制寄存器副本。当 CPU 处于非根模式时：
*   客户机操作系统执行的大多数特权指令（如读写控制寄存器）会直接作用于这套虚拟寄存器，而**不会触发陷阱**。
*   硬件会自动检查这些操作，确保客户机无法越界。

虚拟机监视器通过一个名为 **VMCS** 的数据结构来配置每个虚拟机的初始状态。通过 `VMLAUNCH`/`VMRESUME` 指令切换到非根模式运行客户机。客户机可以通过 `VMCALL` 指令主动陷入根模式，而外部中断（如定时器中断）也会强制退出非根模式，让虚拟机监视器重新获得调度权。

### 扩展页表

内存虚拟化也得到硬件加速。传统的影子页表方案需要由软件维护和更新，开销大。硬件支持引入了**扩展页表**。

其工作原理是**两级地址翻译**：
1.  客户机页表完成第一级翻译：客户虚拟地址 -> 客户物理地址。
2.  EPT 完成第二级翻译：客户物理地址 -> 主机物理地址。

EPT 由虚拟机监视器设置。客户机可以自由设置自己的页表，但其最终能访问的内存范围始终受 EPT 限制。这一切都由硬件内存管理单元自动完成，无需软件介入，效率极高。

---

## 案例研究：沙丘论文

上一节我们了解了现代硬件为高效虚拟化提供的支持。本节中我们来看看一篇名为“沙丘”的研究论文，它创造性地将这些为虚拟机设计的硬件特性，用于增强传统的**进程抽象**。

沙丘的核心思想是：**让一个用户进程能够以“非根模式”运行，从而安全地使用部分硬件虚拟化功能**。

### 沙丘的两种主要用途

沙丘作为一个可加载的 Linux 内核模块运行。它允许进程进入一个特殊的“沙丘模式”。

以下是沙丘提供的两种关键能力：

1.  **安全沙箱**：一个受信任的应用程序（如 Web 浏览器）可以在沙丘模式下运行。它拥有自己的虚拟控制寄存器，可以设置自己的页表。然后，它可以加载一个不受信任的插件（如视频解码器），并让插件代码在进程内的“客户用户模式”下运行。
    *   插件对内存的访问受到该进程页表的限制，无法随意访问浏览器的所有内存。
    *   插件尝试进行系统调用时，会陷入进程内的“客户主管模式”代码（即浏览器的一部分），而不是真正的 Linux 内核，从而被浏览器完全控制。

2.  **高效垃圾回收**：对于使用垃圾回收的语言（如 Java），追踪对象引用时，如果与用户线程并发运行，可能会遇到“对象被修改”的问题。垃圾回收器需要知道哪些内存页被修改了。
    *   在沙丘模式下，进程可以拥有自己的页表，并能直接、快速地读取页表中的“脏位”。
    *   垃圾回收器完成一轮追踪后，可以快速扫描脏页，只重新检查那些被修改过的页面中的对象，这比传统方法（如系统调用查询脏位）要高效得多。

### 沙丘的意义

沙丘展示了，原本为虚拟机设计的硬件特性，可以被重新用于构建更强大、更高效的进程级隔离和内存管理工具。它提供了一种不同于传统进程或容器的抽象，在某些场景下能带来显著的性能和安全优势。

---

## 总结

本节课中我们一起学习了虚拟机的完整图景。

我们首先定义了虚拟机，并探讨了其多种应用场景。接着，我们深入分析了实现虚拟机监视器的经典方法——**陷阱与仿真**，理解了如何通过软件截获和模拟特权指令、通过**影子页表**实现内存虚拟化，以及设备仿真的不同策略。

然后，我们看到了性能瓶颈如何驱动了**硬件虚拟化支持**（如 Intel VT-x）的发展，其通过引入根/非根模式和第二套硬件寄存器，以及**扩展页表**，极大地提升了虚拟化的效率。

最后，我们通过**沙丘**这篇论文，看到了如何跳出虚拟机的框架，将这些强大的硬件特性创新性地应用于增强普通进程的能力，例如实现高性能的安全沙箱和垃圾回收机制。

虚拟化技术是现代计算基础设施的基石，它深刻地改变了我们部署、管理和利用计算资源的方式。