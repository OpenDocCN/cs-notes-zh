# P18：Lecture 19 - Virtual Machines 英文版 - MCATIN-麦可汀留学 - BV1rS4y1n7y1

![](img/496f15b8d05eec6abd21a1b61e7d39d1_0.png)

所有的权利，我想开始了，嗯，今天我想谈谈虚拟机，我要去的讲座真的要分成三块，一个是我要从，嗯，所谓的陷阱和仿真虚拟化，它基本上概述了如何构建自己的虚拟机方案，风险五（单位：亩）。

现在我要谈谈最近的硬件支持，和微处理器用于虚拟化，嗯，然后今天的纸沙丘，它使用这种现代硬件支持，所有的权利，所以呃首先，什么是虚拟机，你真的可以把它想象成计算机的模拟，这足够精确，可以运行操作系统。

所以q mu是一个例子，你可以考虑作为一个虚拟机的例子，我要谈论这件事的方式，就是，到硬件上的最低层，我们将想象一个虚拟机监视器或VMM，这或多或少地取代了标准操作系统内核，虚拟机监视。

工作是为客户操作系统模拟一堆计算机，所以在这里，你知道在我们通常的图表中，用户空间是什么，但现在是客人空间，所以这是，把这个叫做客人空间下面叫做主人空间，我们将有一堆一个或多个来宾操作系统内核。

所以我们可能有一个Linux内核，正如人们所猜测的那样，这个Linux内核将，你知道这只是一个，它认为自己是一个普通的内核，它运行一堆进程，也许是VI和C编译器，我们可能会有其他客人，嗯。

可能还有其他客人，在这里运行的虚拟机，那可能是另一个Linux，或者甚至是其他操作系统，像窗户一样，嗯，都在同一台机器上运行，就会有，Windows进程在此来宾操作系统中运行，所以有了宿主。

虚拟机监视器运行的主机世界，在这些普通操作系统运行的来宾世界上，并进一步，我们会谈论很多关于嘉宾世界的事情，客人主管模式，也就是，内核运行的模式，客核跑进来了，和来宾用户模式，又是。

虚拟机监视器的经典目标，就是提供一个如此优秀的机器的仿真，你可以不加修改地启动普通的Linux或普通的Windows，让它在里面运行，这个虚拟机从来没有怀疑过任何有趣的事情正在发生，所以说，比如说。

虚拟机监视器必须处于，模拟主管模式和用户模式之间的差异，以一种完全令人信服的方式模拟实际硬件是如何做到的，即使那是，你知道的，不可能是真的发生了什么事，所以这就是为什么我们谈论客人主管模式和用户模式。

这是虚拟机对这两种模式的仿真，那么为什么要使用虚拟机，原来，有很多理由运行很多不同的，单台计算机上的来宾操作系统，嗯，有时也许你在经营一家大公司，而你，你知道你需要有很多很多的服务器。

也许是一个名称服务器和安全服务器，谁知道是什么，他们中的每一个都不使用很多资源，所以说，为它买一台物理机器有点浪费时间，但你想逃跑，你知道你，你想在一个硬件上运行很多这样的低强度服务器。

所以你可以通过使用虚拟机来省钱，事实证明虚拟机也非常，在云计算中应用非常广泛，在那里它是一个像亚马逊一样的机构，亚马逊，ews，他们不想把物理机器出租给人们，因为这很难管理，他们想做的是出租他们的客户。

他们的云客户，只是一台亚马逊可以在飞行中使用的机器，你知道决定在哪个哈佛运行它，是在更大还是更小的机器上运行，亚马逊可以决定，哦，你知道吗，它是它现在的客户，也许它有两个客户在这个硬件上。

但是他们不怎么用电脑，也许你可以把第三或第四个客户打包到同一件硬件上，而且不花额外的钱，但获得更多的收入，所以这个虚拟机允许额外的灵活性，你知道这是一种被使用的把戏，我们正在改变现有的操作系统。

用户空间中的内核，并在下面添加一个新层以提供这种灵活性，原来有一些，你知道的，人们使用虚拟机还有其他原因，一个当然是内核开发，这就是为什么我们都用Q木，在一种虚拟环境中运行XV Six的能力。

而不是在真正的电脑上，使这门课对我们大家都方便多了，它也使调试变得更容易一点，我们可以证明，一旦你运行XV6，在QMU提供的虚拟机环境中，提供GDB访问更容易，那么它将在物理计算机上。

人们使用虚拟机的最后一个原因，有一堆把戏可以玩，使用虚拟机监视器提供的额外间接层，比如说，嗯，您可以检查点整个正在运行的操作系统和用户进程，你可以在它的一个检查站，把它藏在某个地方，也许在磁盘上。

然后恢复该检查点，操作系统及其进程的确切状态，就像检查站时一样，它对调试的可靠性很有用，也许克隆虚拟机的映像，所以你可以多次运行它，你可以玩的另一个游戏是，您可以迁移来宾，整个客人到另一台计算机，嗯。

如果在物理计算机上运行来宾操作系统，你需要关闭或更换物理计算机，你其实可以，原来，嗯，因此，在不干扰另一台物理计算机的情况下运行虚拟机映像，这样你就可以关闭第一个。

有一些例子说明了为什么人们真的喜欢虚拟机，人们真的做虚拟机是非常，应用非常广泛，他们也有悠久的历史，这个想法最初是在二十世纪六十年代提出的，它们是随着时间的推移而发展起来的，直到它们非常普遍和易于使用。

对于本课程，我们调查他们的原因是，虚拟机监视器提供了一种关于操作系统可以是什么的不同视图，你知道吗，而不是过程抽象，我们都习惯了，你知道吗，我们这里有一些类似的结构，但是嗯，它提供了一种不同的容器。

这不是一个过程，它是一种模拟机器，和，所以说，它让我们思考我们一直在谈论的所有事情，你知道的，内存分配，调度，保护，从不同的角度，也许会给我们一些想法，我们可以把这些想法带回传统的操作系统内核，事实上。

大部分的行动，那种发展，设计，发展，研究活动已经从传统的内核转移到虚拟机监视器本身，随着它们变得越来越普遍，所以在某种意义上，操作系统的话题正在向下一层漂移，好的，在本讲座的第一部分。

我想谈谈我们如何实现自己的虚拟机，嗯，我会用风险五作为，假设我们试图模拟风险五硬件，所以我们可以运行为风险五设计的操作系统，就像十六，只是为了重复特定的目标，我们想要的或者经典的虚拟机，我们想建造什么。

客户软件完全不知道，它在虚拟机中运行，我们想建立一些东西，使客户软件无法区分决定，我是在真机上运行还是在虚拟机上运行，对呀，我们希望仿真有那么好，原因是我们不想，我们希望能够运行它。

我们希望能够在虚拟机中运行任何东西，任何操作系统，甚至可能是一个我们没听说过的操作系统，这意味着你知道操作系统做的任何有趣的事情，在它使用硬件的方式上，虚拟机必须提供，你知道硬件的仿真。

所以在真正的硬件上工作的任何技巧，也将在虚拟机中工作，我们想要的一个类似的目标是我们希望没有办法，客人不仅无法决定它是否运行在虚拟机上，但是客人无法逃离虚拟机。

人们使用虚拟机的很多原因是为了提供严格的限制，对于不受信任的软件，即使是在虚拟机内运行的不受信任的操作系统，比如说，如果你是亚马逊，你在销售云服务，通常是您的客户提供在虚拟机中运行的操作系统。

以及应用程序和所有人的天哪，你知道的，您的客户运行的不是普通的Linux，他们正在运行一个特殊的黑客攻击版本的Linux，谁是谁打算试图突破它的虚拟机，闯入亚马逊的，我要么是亚马逊其他客户的虚拟机。

或者嗯，所以客人很重要，无法突破他们的虚拟机，能够使用，虚拟机监视器允许它们使用的内存，比如说，但不是其他记忆，和，同样地，他们不应该未经允许就伸出手来，并使用存储设备或网络接口卡之类的东西。

所以我们希望有非常严格的隔离，在许多方面，虚拟机提供了比普通UNIX进程更严格的隔离，普通的UNIX进程经常可以交互，你知道的，他们可以互相残杀，或者他们都可以读写相同的文件或通过管道通信。

在一种普通的虚拟机系统中，这一切都不可能，在同一台计算机上运行的不同虚拟机中，通过虚拟机监视器彼此完全隔离，所以人们喜欢他们的安全，对呀，这是一种能够运行不受信任的软件的方法。

不必担心它是否有缺陷或恶意，对物理机器的一种完全忠实的模拟，事实上，嗯，事实证明，出于性能原因，这个经常是模糊的，你会发现，比如说，那个，嗯，Linux和最常见的虚拟机监视器已经共同发展了一点。

所以在现实生活中，Linux可能实际上知道它运行在虚拟机监视器上，并且使用虚拟机监视效率权限，嗯，Linux有时会明知故犯地与虚拟机监视器对话，以做以下事情，获得对设备的高速访问。

但这是一个精心控制的例外，总体策略是，好的，那么我们如何构建自己的虚拟机监视器，嗯好吧，一种可能性是完全用软件来完成，你可以想象写像Q穆这样的东西，解释了机器指令，你可以写一个程序来打开XV6。

读取包含XV六条指令的文件，你的程序可以查看每一条指令并说，哦，那是一个，那是加载指令或移动指令，你的程序可以模拟风险5状态，可能在软件中实现了三个两个寄存器，当你的软件读取每一条指令并将其分开时。

它计算出什么样的指令是，它将把该指令的效果应用于三个，它在软件中模拟的两个寄存器和控制寄存器，人们这样做，概念上简单，使其工作，尽管要把所有的细节都弄对可能需要很多工作，为什么，一种纯软件。

解释性虚拟机应用不广泛，他们很慢，如果你玩这个游戏，您的虚拟机将以，您正在使用的硬件，因为对于每一个你的虚拟机监视器软件必须查看每一条指令，因为它在这里执行，你的机器显示器可能会运行几十条指令。

在解释每一个客人指示的过程中，所以它会慢一个数量级，嗯，比一个真正的电脑，对于云计算这样的东西，我真的不实际，所以人们不会使用软件解释来为生产系统构建虚拟机，嗯，呃，那种嗯的核心。

广泛使用的主要策略之一是运行，在真正的CPU上运行来宾指令，所以如果你要在你的，虚拟机监视器，你实际上会加载XV的指令，内核，一开始你知道内存中的整个XV六个指令，然后跳转到XV中的第一条指令，对呀。

嗯，为了让你的计算机实际运行XV中的指令，当然，这需要你的计算机有相同的微处理器，XV6正在期待，但这很容易安排，事实证明你不能真的这么做，你会遇到麻烦的地方是，当您的来宾操作系统首次执行特权指令时。

对如果它，你知道这就是内核和普通用户代码的区别，就是内核，这就是我们试图在虚拟机上运行的内容，内核使用特权指令，所以嗯客人，你的客人上校可能，比如说，尝试在风险5的SAT P寄存器中加载一个新的页表。

所以这开始提出一个难题。

![](img/496f15b8d05eec6abd21a1b61e7d39d1_2.png)

嗯，如果我们将客户机内核作为普通用户进程执行，在Linux中，比如说，男孩加载SAP是用户模式下的非法指令，所以我们的程序要崩溃了，如果我们愚蠢到把我们的客户机内核加载到，并在主管模式下运行，嗯。

不知何故，我们的来宾内核现在将能够修改真正的页表，并且能够逃离它的虚拟机，因为它可以控制传播和写入的内容，嗯，任何记忆，所以说，我们不能用策略，这就像直接运行来宾内核一样简单，相反。

我们要开始玩一些把戏，第一步是在用户模式下运行来宾内核，所以说，这有点像，这里的基本策略，我将运行来宾内核和用户模式，你知道吗，在风险五用户模式下，这意味着什么，你知道我们在写。

我们正在编写自己的虚拟机监视器，当我们告诉它看，请启动XV6，它会在内存的某个地方加载x vsix的内核指令，嗯，也许可以适当地设置页表，这使得它看起来像十六，比如它的内存从零开始。

然后上升到任何高内存，嗯，然后虚拟机监视器将使用一个陷阱，你知道吗，It’红色指令，就像你们在XV中遇到的那样，跳转到来宾OS的第一个指令，在用户模式下，因此来宾操作系统将沿着，现在很多指令都很好用。

如果来宾操作系统只是将两个寄存器添加在一起，甚至从内存中加载或存储，一旦来宾操作系统使用特权指令，会发生的是它会诱捕，五个硬件会导致它的风险，因为它是在用户模式下运行的。

不监督或模式将导致它陷阱回到我们的虚拟机监视器，我们会得到控制，所以，如果来宾操作系统，比如说，尝试更改SAP页表指针臂，风险五CPU会困住我们的虚拟机监视器，我们的软件会夺回控制权。

我们的软件将能够查看并看到是什么指令导致了陷阱，做一些适当的事情，但这里很酷的是，来宾操作系统实际上并没有设置页表指针，但是VNN是如何拦截这个的，就像它必须把陷阱处理程序设置好一样。

这难道不是只有特权进程才能做到的吗，是啊，是啊，vmm，是主机上的用户程序，是对的，好的，我想的是，嗯，所以在这张简单的照片中，虚拟机监视器是在此硬件上引导的内核，所以你不用启动Linux或其他什么。

而是启动这个虚拟机监视器，它在主管模式下启动，它是对硬件的完全控制，这样我们就可以建立，你知道的，电视和所有其他的东西，然而，就像现在有意义了，实际上，一些虚拟机监视器正是这样工作的。

你只需在硬件上引导它们，只有虚拟机监视器在主管模式下运行，事实上，也有很多很多虚拟机方案，事实上引导Linux，然后一旦Linux启动并运行，你加载，您加载虚拟，要么Linux，我是说。

实际上Linux附带了一个虚拟机监视器，或者将虚拟机监视器加载为，这就是所谓的可加载到Linux中的内核模块，它在内核中以主管模式运行，这就是今天报纸的工作方式，你启动Linux。

然后运行这个小的可加载内核模块，重点是虚拟机监控软件，你知道的，我们信任的软件重写以主管模式运行，我们将在用户模式下运行guest，让它看起来像是在主管模式下运行的，就它而言，好消息是，在风险5中。

一切都很危险，嗯，如果您尝试在用户模式下进行，这就是主管模式可以做的所有特权事情，嗯，除了与页表有关的东西，或者我们一会儿再谈，但基本上每个主管都只指示，如果尝试在用户模式下执行，会导致陷阱。

这意味着每次来宾操作系统执行类似读取的操作时，s原因或读写TC，或者做任何xv六的事情，比如说，做什么来配置，风险五硬件的特权部分会导致进入虚拟机监视器的陷阱，我们会得到控制。

然后游戏将是虚拟机监视器将维护，嗯，虚拟状态，一整张虚拟状态信息表，为了客人，因此虚拟机监视器将具有，比如说，嗯，一个虚拟的STVEC寄存器只是在软件中实现了它作为一个变量，你知道的，虚拟的。

epc寄存器和所有这些受保护的寄存器，下面会有一大堆，由虚拟机监视器实现，当来宾操作系统，比如说，运行读取其中一个寄存器的指令，它会上当，因为它在用户空间中并不违法，虚拟机监视器会检查指令并说，啊哈。

这是一条正在读取SCPC寄存器的指令，因此虚拟机监视器将模拟该指令，此数组中的虚拟SCPC值，嗯，它会把它复制到硬件上，这里真正发生的是，我忘了那个的名字，有一些指令我忘了它的名字，基本上是主管读的。

虽然这不是它的名字，你给出一个普通寄存器的名称，以及特权寄存器的名称，像SCPC，那么将跟踪的虚拟，虚拟机监视器将读取该指令，嗯，我们走着瞧，哦，这是一个s读，虚拟机监视器将复制SCPC的虚拟副本，嗯。

在陷阱框架中变成一个零，毕竟是在进入VMM的时候，这会造成一个陷阱框架，带着所有客人登记册的副本，它将把这个scpc复制到陷阱帧中的azer中，然后从陷阱中返回，你知道的，使用SR，你知道的。

复制陷阱帧寄存器和真实寄存器后，并在s读后从这个陷阱返回到指令，并继续阅读那里，现在一个零设置为，现在来宾操作系统将继续，你知道吗，但不是，我没意识到这里发生了什么有趣的事。

但它会得到虚拟SCPC的副本，VN代表它保存的，所以关于这个有什么问题吗，呃，关于这个策略，VMM如何区分不同的客户，嗯它它，嗯，它是，基本上是一样的，它将为每个来宾保留一个虚拟状态表。

它就像XV6一样知道哪个过程，它把它作为变量运行，也许每个核心变量，说着，以下是我当前正在运行的进程，同样地，虚拟机将有一个每个核心的变量，该变量指示哪个虚拟机，你知道的，是这些状态结构的多个。

NM将知道哪个虚拟机正在执行，我会在合适的虚拟机中寻找，状态结构定义ST PC或它正在寻找的任何东西，它能运行多个，嗯，它能为其中一个来宾分配多个核心吗，是啊，是啊，复杂的虚拟机监视器可以做到这一点。

是呀，所以如果你对不起，去吧，哦对不起，所以客人停止书写系统，它在实际硬件中会有一些寄存器，将是我们客人使用的登记簿，那么为什么我们不使用实际的SCPC，但是用虚拟的，原因是。

虚拟机监视器需要使用这些寄存器来使用真实寄存器，所以说，比如说，所以当陷阱发生时，想想s cos，当你知道会发生什么，当来宾操作系统试图执行几乎任何特权时，陷阱就会出现。

硬件将真实硬件的原因寄存器设置为陷阱的原因，是非法指令或无特权指令，不管是什么，但是如果来宾操作系统，你知道的，假设来宾操作系统刚刚接受了来自来宾用户进程的系统调用，来宾操作系统需要看到一个s。

因为这是正确的，s原因值用于系统调用权限，即使你知道的最后一件事，所以来宾操作系统将读取s cause，你知道在陷阱里，它认为是陷阱处理程序，处理来自其客户进程之一的系统调用。

来宾操作系统需要看到的S调用，是表示系统调用的值，但S的原因将是真实的，原因寄存器，是指非法教学或无特权的原因吗，或者你知道，违反特权规则的指示，所以说，其实有些时候你可以，一般来说，VMM，你知道的。

VMM是一个需要看到真实的，VMM需要在，在真实寄存器中，比操作系统在其verin中应该看到的要多，这是寄存器的愿景，这有道理吗，谢谢。是啊，是啊，因此，这被称为这种类型的虚拟机实现的名称。

其中guest在用户级别运行，因此，每当它试图做任何特权时，它就会陷阱，VMM可以模拟特权指令，它的名字是陷阱和模仿，这很好，因为你可以，你可以为自己建造这个，实际上，你可以完全用软件为自己构建这个。

你可以修改十六，例如，作为虚拟机，风险五监测，运行小虚拟机，也许普通的XV 6只需编写软件，当然，你的软件必须在主管模式下运行，这里的状态，所有以…开头的寄存器What’所有那些主管控制寄存器，嗯。

必须是这个虚拟状态的一部分，还有一些其他的东西是不能直接访问的，嗯，从那些需要在该州下降的登记册中，其中之一就是模式，虚拟机监视器需要知道，虚拟机是以来宾用户模式还是来宾操作系统模式运行，因为，比如说。

如果用户代码执行特权指令，比如试着阅读，因为这肯定也会导致一个陷阱进入VMM，但在这种情况下，VMM不应该只是模拟指令作为回报，因为这不是用户模式下的合法指令，所以VMM必须跟踪。

客人是在客人主管模式还是客人用户模式，所以这里也会有一个模式槽，VMM会知道，因为当来宾操作系统跳入用户空间时，它会执行红色指令，It’红色是特殊指令，所以VMM实际上会在那里得到控制，我们拭目以待。

哦，客人正在运行一个红色指令，除其他外，我要把虚拟模式从主管改为用户，另一个隐藏的状态是心号，这是核心数字，你不能直接得到那个，即使有特权指令，嗯，但是VMMS，需要跟踪它现在在模仿哪个心脏，风险五。

原来，不同的CPU有不同的难度，写一个陷阱并在上面模拟虚拟机有多难，风险副特别适合它，因为设计者在设计指令集时就考虑到了这一点，所以他们知道陷阱和仿真虚拟机的要求是什么，和，比如说，嗯。

他们一直很努力地确保每一个，主管代码可以做的特权事情会导致陷阱，如果您尝试在用户模式下进行，这就是您需要的，以确保虚拟机监视器看到一个陷阱，对于每一个特权指令，我有个小问题，呃。

那么在guest os本身中运行的任何东西，还是总是困在虚拟机监视器里，就像如果你有一个添加指令，你知道广告，4。我不知道怎样写这个冒五次险的程序集，但我们只能说你在1上加一个零，你想把结果放在二。

该指令直接在硬件上以全硬件速度执行，如果您进行函数调用，只是一个普通的函数调用，在客人的世界里，没有任何特别的执行，它只是一个普通的，你知道的，在用户代码中关于非特权操作的所有合法说明。

只需在来宾操作系统执行它们时直接全速执行，好的，那么在客户操作系统中是否有类似用户模式和内核模式的外观，是呀，客户操作系统很好，来宾操作系统不变，所以我们在这里运行的正是Linux内核。

或者确切地说是XV Six内核，当然还有十六，这就是你所知道的，对呀，就是这样就是这样，当然不在这里，但就守则而言，它只是绝对运行在主管模式下，它只是做各种特权的事情，并期望它们发挥作用。

然后它知道什么时候执行s red进入用户空间，它知道啊哈，我现在要进入用户空间，你知道，VMM让一切看起来都像是正在发生的事情，好的，即使它实际上是在真正的机器里，它在两个地方都处于用户模式。

但这看起来就像主管模式，这看起来就像你，好的，所以当呃，所以说，比如说，当客人，当我们执行S威胁进入用户空间时，特权威胁，幸运的是，它捕获了虚拟机监视器，虚拟机监视器将虚拟模式更改为用户，即使。

当然真正的模式还是主管，因为我们还在这里，将虚拟模式更改为用户，就在它从陷阱里回来之前，虚拟机监视器设置真实的SCPC，um到虚拟SCPC，因为当虚拟机监视器使用自己的SR返回时。

它返回的程序计数器值是程序值，是来宾操作系统要返回的程序计数器，嗯，所以这里有一个例子，非常简短地设置了真正的SCPC，等于，呃，虚拟SCPC，嗯，我一会儿再谈这个，但是虚拟机监视器也将切换页表。

当它回到虚拟机中时，当来宾用户代码想要使其，然后来宾用户代码，如果它对于普通指令只是执行机器，直接全速执行，当来宾代码要进行系统调用时，你知道吗，执行导致陷阱的e call指令，在此方案中。

该陷阱指向虚拟机监视器，虚拟机监视器说啊哈，在那里你知道，咨询虚拟模式，它的虚拟模式是用户空间，它看指令，呃，困住了断层，是个电话，然后虚拟机监视器做所有的虚拟更改。

在虚拟状态下进行模拟称为陷阱的系统所需的所有更改，进入来宾操作系统，所以它将把虚拟scpc设置为任何程序计数器，e呼叫指令在，它会把虚拟模式换回主管，它将把虚拟的原因设置为系统调用嗯。

它会设置真正的EPC，等于虚拟ST VAC，然后叫srat，这样它就会跳转到来宾操作系统的陷阱处理程序中，哪个是什么或者蹦床页，不管它是什么这就是虚拟电视所指向的，我们还有两件很重要的事，一个是页表。

另一个是设备，页表有两个部分，一个是在不同的地方，来宾操作系统将修改SAT P寄存器，你当然知道那会变成一个陷阱，虚拟机监视器和虚拟机监视器有机会做一些事情，但我们不想要的。

虚拟机监视器要做的只是让客人设置真实的SAT PE，嗯，然后在更改实集后执行，因为这会让客人获得任何记忆，不仅仅是虚拟机监视器分配给它的内存，所以我们不能让来宾操作系统简单地设置SAT PE。

但我们确实需要对布景做些什么，因为我们需要给来宾操作系统提供一个错觉，是的，页表确实被更改了，当客户软件运行时，这不仅仅是一种幻觉，加载和存储指令或或获取要执行的指令，我们需要这些来自正确的地方。

从来宾操作系统指向其页表项的位置，那么当客人设置卫星小便时会发生什么，嗯，我们，你知道吗，我们不能让它，我们不能直接使用来宾操作系统页表，但是虚拟机监视器会生成一个新的页表。

所以现在页面翻译的情况有点不同，我们有客人，客人试图将页表设置为什么，这是来宾页表，当然是当前，你知道来宾内核，这地图，从猜测的虚拟地址到我所说的客户物理地址，当然，猜测物理地址是虚拟机监视器是。

你知道的，给客人，你知道三个2G字节，或，无论多么相似，你知道物理记忆，嗯，供其使用，大概是从一个告诉开始的，其物理地址从零开始的来宾操作系统，上升三到两兆字节。

但你当然知道他们在现实生活中不会在真正的硬件上，他们只有三个，价值2GB的页面，不毗连的地方，所以我们不能，你不能直接使用客人的物理地址，因为它们与真实的物理地址不一致，所以取而代之的是，VMM将维护。

将客户物理地址映射到实际物理地址的um虚拟机，我所说的主机物理地址，所以这张地图是，你知道吗，它就像一个页表，每个页面都有一个条目，客人认为存在的每一个物理部分，并指示什么是真正的物理页面。

客人物理地址指的是，VM是为它分配的，然后呃，当客人写了一个新的页表，在陷阱处理程序中，VMM创建了所谓的阴影页表，这将是VMM在真正的，这个阴影页表是由这两个页表的组合构造的，因此。

它映射来宾虚拟地址，物理地址，然后通过获取来宾页面表中的每个条目来构建它，查看客人想要的客人物理地址，使用VMM映射将来宾地址转换为真实的主机物理地址，把虚拟物理对等点放在阴影页表上。

然后虚拟机监视器将其设置为SAT P中的真实页表，在返回之前，给客人上校，所以来宾内核认为它设置了一个页表，但实际上真正的硬件是使用这个阴影页表，这样就有了，这是防止来宾从内存中逃逸的原因。

它被允许使用，嗯，的，影子页表只能包含主机物理地址，VM为该客户机分配的，客人，客人不能把任何东西放在页表里，它要求，这将允许它访问没有分配给它的页面，由虚拟机监视器。

这是这里与世隔绝故事的一个关键部分，所以关于陷阱和仿真的分页设置有什么问题吗，对不起，所以如果是操作系统，客人只是想要一个新的，一个新进程和该进程的新页表，它做了什么就像发生了什么，客人们，客人照常做。

就像Linux或XVSix现在做的那样，它将页表项格式化为，制作页表，然后执行以下指令，并将页表的地址签入SAT，这就是来宾操作系统所做的，当但是它实际上不能赋值给设置p，因为这是一个特权操作。

所以有一个陷阱进入虚拟机监视器，虚拟机监视器检查陷阱看到的指令，哦天啊，那个客人想在小便时分配给，然后呢，虚拟机监视器将创建这个新的阴影页表，从页表的组合，客人试图设置，虚拟机监视器查看页表。

页表中的所有P，客人试图让它运行，它通过这个地图翻译每个客户页表条目中的物理地址，获取真实的物理地址，或者造成真正的错误，如果客人试图使用不允许使用的物理地址。

然后虚拟机监视器在真实的SAT P中安装阴影页表，回到客人身边，哦，好的，好的，我明白了，我明白了，好的，谢谢。好的，所以这是这个，这个阴影页表的东西当然是，实现虚拟机监视器，其实还有一件事，呃。

来宾操作系统还有另一种方式可以与页表交互，来宾操作系统实际上可能，你知道的，xv6，有时直接读写页表中的页表项，你知道的，所以XP6可以修改页表条目或读取脏的部分，例如，在页表条目中，现在关于风险五。

如果软件修改页表条目，如果你读了风险五规范，风险五在这一点上不需要做任何事情，因此，如果修改页表项，嗯，风险五，微处理器不保证立即观察到对页表项的修改，你可以暂时完全忽略它，而是，手册上说。

如果你修改页表条目，你真的想让硬件看到它们，你必须执行S围栏，点v m指令，规格上只说，只有这个指令才会使硬件关注你的博士修改，因此，如果您正在构建虚拟机监视器，风险五上的虚拟机监视器可以完全忽略，嗯。

对页表项的来宾修改，但既然你知道客人会发出，它要执行一个S围栏，修改页表项后的指令，这是一个特权指令，你可以看出来，因为它是以S嗯开始的，这将进入虚拟机监视器，虚拟机监视器将，嗯，知道一个围栏被处决了。

它看指令，它将重新扫描客人，当前页表和当前页表的来宾版本，并查找已更改并反映这些更改的页表项，如果他们是合法的，嗯，到阴影页表中，嗯，重置执行，真正的栅栏，螺柱通过一个得到真正的硬件注意阴影页表。

然后返回到来宾操作系统，所以这意味着，就像MMU实际上只使用一个页表一样，也就是阴影，又不是说，它在使用EPT或类似的东西，还没有办法，好的，所以客人就像，以为它有页表，比如GVA或GPA。

但这实际上并没有做任何翻译，然后VMM，是啊，是啊，制作自己的页表，根据他们两个的结合，这是正确的，这是正确的，只是想说清楚，不同的EPIS部分，完全不同，需要硬件支持的虚拟机设计。

如果我假设这是一个关于如何构建虚拟机的故事，除了捕获特权指令之外，没有特殊的硬件支持，这会以任何方式扰乱直接映射吗，嗯，不会是直接的地图，这样客人就可以，我是说，这将导致来宾内核正确运行。

来宾内核认为是直接映射，但这不是直接的，这是虚拟世界中的直接映射，但这不是直接映射，在真正的机器上，但这并不重要，因为，因为我们在欺骗，让我们的耶，我们在骗客人进入一切看起来就像是一个直接的地图。

还有一个问题，您可能稍后会解决这个问题，但我想知道当我们在学期早些时候讨论陷阱机制时，我们提到了诱捕的高性能成本，哦，这听起来像是有更多的表演热门，当我们使用VMM时，是呀，是呀，所有这些说明。

你知道如果你，如果你是，如果你的手术不是借口，很多特权指令，它可能会，你花了很多时间在操作系统和陷阱上，你可能有不少陷阱，然后这可能会让你损失相当多的性能，这就是一点点的动力，我们将讨论现代硬件支持。

虚拟机，这就是今天报纸用的，陷阱的高成本，是为什么的很多动机，Inl觉得有必要做一个AMD，感到有必要增加硬件支持，以提高效率，对于一个陷阱少得多的虚拟机方案，是呀，那很重要，但这真的跑了。

我是说很多年来，这就是人们为虚拟机所做的，它非常成功，它很有效，它是，你知道，慢得多，嗯，但不会慢到人们不喜欢，人们很喜欢它，好的，关于页表的陷阱和模拟策略的更多问题，好的，让我，呃。

作为陷阱和模仿故事的最后一部分，让我谈谈设备，所以我在这里说的是，呃，你知道的，普通操作系统期望能够脱离磁盘驱动器，将其文件系统存储在，也许还有网络接口卡，也许如果是xsix，你艺术。

这样它就可以和它的控制台对话，你知道，谁知道声卡，图形适配器，一只老鼠，键盘，各种各样的东西，所以我们需要的操作系统，我们的虚拟机方案必须有一些规定，允许客人。

至少骗他们认为他们需要的所有这些设备都真的存在，人们使用的主要策略有三种，一个是在课堂上挑选一些你需要的非常常用的设备，比如说磁盘驱动器，只是做一个仿真，这不算什么，你实际上没有一个真正的设备。

VMM只是让它看起来像这种特殊的描述存在，客人在和它说话，嗯，你驱动这种仿真的方式，呃，通常，来宾操作系统将尝试通过内存与设备对话，映射控制寄存器，这就是xpsix对你说话的方式，你就是，你知道的。

串口，键入字符并向您显示字符的，xpsix正在与一些映射的控制寄存器对话，它假设硬件已映射到已知地址，在内核地址空间中的地址中，因此，在虚拟机监视器中模拟它的方式是，您实际上没有在来宾中映射这些页面。

相反，您将允许这些页面无效，因此，每次来宾操作系统试图使用UART硬件时，或任何设备硬件，VM虚拟机监视器会得到一个陷阱，和虚拟机监视器，我们可以看看说明书，说，哦。

它试图在U艺术上发送一个字符或从磁盘上读取，或者谁知道是什么，虚拟机监视器会有一些磁盘的模拟，或串行设备的模拟，嗯，你知道，调用它的模拟来，弄清楚如何响应客人的指示，然后让客人继续。

所以这基本上是Q MU如何实现，XVSix使用的UART控制台设备，它只是有一个，实际上看不到物理串行端口，但是q穆为了让xv六开心模仿了一个，所以这是一个常见的策略，它的性能可能很低，不过。

因为它涉及到操作系统的陷阱，对于来宾和设备硬件之间的每一次交互，但对于低速的东西，它工作得很好，第二个常用的策略，嗯，实际上，但如果你，如果你的目标是提供能够引导操作系统，他们在虚拟机上运行，嗯。

这几乎是你必须走的路，真的没有别的选择，但是在现代世界里，你知道，这种情况经常发生，操作系统意识到它们实际上是在低水平上运行的，至少知道它们运行在虚拟机的顶部，因此，一个不同的策略是提供虚拟设备。

而不是，试着模仿一个真实的设备，但要为提供的人设计一个特别有效的设备接口，客户机中设备驱动程序的有效方法，能够与虚拟机监视器内的设备支持对话，嗯，所以你可能没有内存映射控制寄存器。

并说你可能在内存中有一个命令结构队列，其中，来宾操作系统将把它的命令写入辩论，事实上，xp six也使用了其中的一个，如果你看XP 6 Vert IO光盘，贝里奥是C，你会看到一个客人的尽头。

用于与由Q MU实现的磁盘虚拟设备对话的设备驱动程序，它要么很少使用，要么几乎不使用，很少或没有内存映射控制寄存器，所以它并不真正依赖陷阱，相反，它格式化了这个，这种命令和内存队列，正如我提到的。

然后qmu在内存中查看这些命令并应用它们，不是到真正的磁盘，而是像我们这样的文件，这是FS图像，q mu将这些命令应用于fs图像，而不是使用真正的设备硬件，这是另一种策略，人们使用的第三种策略。

所以这是更高的性能和直接的仿真，因为你可以设计界面，所以不需要很多陷阱，人们使用的最终策略，嗯是嗯，真实设备的传递，这种典型的情况是网络接口控制器，你知道，提供访问网络和现代。

实际上有硬件支持与在虚拟机监视器下运行的多个来宾操作系统对话，所以你可以配置一个现代尼克来实际作用，好像它是多个独立的，显然是独立的尼克斯队，每个客户操作系统一个，然后来宾操作系统可以直接对话。

它可以由虚拟机监视器配置，这样它就可以直接说话了，到它的网络接口卡硬件的一小部分，效率非常高，所以这是现代高性能的方式，客户操作系统可能在理论上，我想你可以设计，你可以设置这个。

所以来宾操作系统并不真正意识到，或者发生了什么奇怪的事情，但我认为在实践中，客户操作系统设备驱动程序知道，他们正在和一个特殊的网络接口卡通话，所有的权利，所以这些是设备的选项，事实上。

我相信今天实现虚拟机监视器的大部分困难，以试图编造设备仿真和设备驱动程序的形式出现，呃，足够好，像那样，它们实际上会正确地与真正的客户操作系统一起工作，这可能是大部分工作的地方。

特别是如果您需要使用此仿真，那么到底是什么，我不太明白虚拟和仿真之间的区别，因为他们不喜欢他们，他们很相似，他们很相似，这里有一种思考的方式，如果您引导的操作系统对虚拟机一无所知。

所以它可能有很多磁盘驱动器，但它们都是真正的硬件，你可以出去，比如你可以出去买的物理硬件块，这意味着如果你想在你的虚拟机上启动这种操作系统，嗯，你需要有一个精确的仿真，你需要选择一个真正的硬件。

并有一个精确的，对那个硬件的超精确仿真，所以我的意思是人们完全这样做，所以那是有效的，然而，那就没问题了，除了大多数用于真正的硬件，设备接口没有设计，硬件接口的设计不是高效的。

带有陷阱和仿真虚拟机监视器，和，所以通常情况下，真正的设备只需要你阅读，并大量写入其控制寄存器，但是虚拟机监视器必须控制设备控制寄存器的每一个权利，因为你知道它需要模仿它。

这意味着设备控制寄存器的每一个权利都会导致一个陷阱，进入虚拟机监视器，你知道，这可能需要数百个循环，这意味着这是缓慢的，这是低效的，所以这里的区别是，而不是盲目地模仿真实的设备。

一些设计师想出了一个设备接口，这不是由任何真正的硬件实现的，但只能由虚拟机监视器实现，它只是碰巧被设计成一种方式，那不需要很多陷阱，而是用控制寄存器聊天，并期望设备立即响应，这真的需要一个陷阱，相反。

该设备，司机，这种虚拟硬件是解耦的，而且永远不需要即时的互动，所以在这种情况下客人需要自己的就像一个新司机，所以就像客人会有一个司机，就像这个磁盘模型和那个磁盘模型，它也有一个虚拟列表的驱动程序，是的。

所以XP6确实这样做了，所以在功能层面上，你玩这个游戏，也许你可以引导任何操作系统，而如果你玩这个游戏，您只能引导关于虚拟设备的操作系统，如果你想用，你知道虚拟设备，事实证明。

这实际上是一个由多种不同虚拟机方案提供的标准，所以有了这个，你知道的，除了我们从来没有在Q MU以外的任何东西上测试过，这个描述符和XV 6可能会工作，可能会被修改以在其他虚拟机上工作。

所以如果每一个xp6都是为那个板编译的，你在一开始的某个时候展示的，嗯，在这种情况下，它必须有一个不同的磁盘驱动器，根据运行正确的磁盘，是啊，是啊，是啊，是啊，是啊，是啊，我想你也许可以买到磁盘接口。

现在支持此接口的实际硬件磁盘接口，但后来，但大多数是大多数磁盘驱动器不，我们将不得不实施一个新的，就像你说的，我们必须为一个真正的硬件实现一个新的磁盘驱动器，关于设备的其他问题。

下一个话题我想谈谈硬件支持，特别是，英特尔的VT方案，那么动机是什么，什么动机，英特尔和其他硬件提供商将为虚拟机增加直接硬件支持，是一个，虚拟机使用的事实是普遍的，所以他们的很多客户都在运行很多虚拟机。

和b，陷阱和模仿的事实，正如我刚才所描述的，它经常涉及很多昂贵的陷阱，所以效率不是特别高，第三种不太有趣，也许动机是，尽管风险五非常适合陷阱和模拟虚拟化，x86英特尔的微处理器有许多详细的功能。

这使得它实际上很难成为可能，但很难虚拟化，所以英特尔也有动力试图解决这个问题，因为他的许多客户想运行虚拟机监视器，好的，所以这个硬件是，嗯嗯，重点是让它，允许您使用此硬件支持构建更快的虚拟机。

另一个动机是让实现虚拟机变得更容易，这种支持可能已经存在了十年，而且现在非常，非常广泛地用于构建虚拟机，好的，所以基本策略是在我的陷阱和模拟方案中所有的虚拟状态，虚拟机监视器维护的所有虚拟状态。

只是在软件上，所有的虚拟状态都将在硬件中实现，在这些硬件支持的方案中，这将允许来宾软件执行特权指令，直接影响这些虚拟硬件支持的寄存器，而不是如此诱捕，目标是现在他们的客人将能够执行特权指令，但不是陷阱。

你之所以知道，工作方式是，我们再次有一个虚拟机监视器，客户操作系统和用户级别，和硬件，现在你知道我们在硬件上有一个，你知道的，stvac，所有你知道的硬件寄存器，当我们在虚拟中运行时，在这些新计划中。

硬件运动场景，当我们运行虚拟机监视器时，我们只是使用这些寄存器的真实版本，但是当虚拟机监视器告诉硬件外观时，请切换到客人模式，硬件有一套完整的独立寄存器，UM专用于客人模式。

所以来宾模式可以读写这些寄存器，但它不是，你知道吗，它在阅读，它是阅读和写作，它是这些寄存器的这些版本的硬件副本，而不是真正的寄存器，硬件有，你知道吗，有一些额外的支票，它在来宾操作系统上可以做的。

以确保它不会滥用这些寄存器来逃离虚拟机，这是基本的，这是大部分的基本策略，用这些硬件支持的虚拟机方案的术语来说，名字至少变成一个，来宾模式的名称是，主机模式，我们使用真实寄存器作为根，所以有一组非。

要使用的虚拟机的根寄存器或虚拟寄存器，当我们在root中时，有一组寄存器被使用，模式，所以现在当我们在来宾内核中运行时，不诱捕，所以如果它想读或写STC啊，硬件只允许它读写硬件的非根副本。

TVAC寄存器，所以所有这些东西都在全速进行，而不必把它困在VMF里，因此，对于正在发生的代码来说，它要快得多，很多陷阱，你还是要，配置这个涉及到一大堆东西，虚拟机监视器想要创建新虚拟机的时间。

它实际上必须告诉硬件，嗯，所以在虚拟机监控内存中有一个，有这种结构，虚拟机监视器和用于通信的VTX硬件，它被称为VM CS或VM控制结构，当虚拟机监视器想要创建一个新的虚拟机时，它在内存中创建其中一个。

并填充一堆配置标志，以及所有这些寄存器的初始值，然后告诉VTX硬件外观，你知道，我想开始运行一个新的虚拟机，这是初始状态，所以有这些新的指示，报纸上提到的，有虚拟机启动，就像一个新的，你知道。

新机器指令，你告诉它，这个的地址，它开始运行，你知道，从这些寄存器开始，比如开始运行来宾内核，还有这个VM简历，因为有时会从内核中爆发出来，将内核捕获到VMM中，您需要恢复它。

然后这里的代码可以运行一个名为VM调用的新指令，它故意退出非根模式，基本上是陷阱进入虚拟机，莫宁根模式，嗯好吧，因此，当虚拟机监视器使用以下指令之一跳转到来宾时，它可能回来的方式。

我是说客人们现在把普通的特权指令连接到你身上而不用陷阱，但有一堆原因让你可能，尽管如此，还是返回到虚拟机模式，一个是故意退出，而且如果设备中断中断，就像计时器中断一样。

微处理器会迫使一个陷阱脱离非根模式，在虚拟机监视器中退出来宾进入根模式，所以在一般设备中断中，陷阱返回虚拟机监视器，这意味着客户机操作系统不能占用CPU，每次计时器硬件计时器滴答作响。

虚拟机监视器获得控制，如果有多个猜测，它现在基本上可以分时使用机器，利用它在所有不同客人之间打断的时间，好的，所以这是基本策略，基本上有第二组寄存器，另一个我，VTX提供的另一个重要功能是页表支持。

我们在客人世界里运作，你知道我们还需要一张页表，现在我们需要页表有两个原因，一个是来宾内核希望能够配置自己的页表，希望能够装载CR 3，这是英特尔的SAT P寄存器，所以我们希望能够。

或者VTX允许来宾内核加载任何值，它喜欢进入CR 3寄存器来设置页表，硬件实际上会服从来宾内核加载的页表，但我们知道这不可能是太棒了，因为现在来宾可以在不困住VMMap的情况下提升页表，嗯。

但我们知道我们，我们不能让来宾内核把它喜欢的任何东西放在它的页表中，没有，因为这将允许它读写任意内存，所以这个VTX方案实际上有另一个重要的寄存器，也就是，事实上，一部分真实的。

谁知道我应该把它画在哪里，但我会把它画在这里，延长的，寄存器和虚拟的，它指向页表，那是一种地址或另一种地址，虚拟机监视器在运行来宾内核时设置，它设置，对于内核，告诉硬件外观，这是，虚拟机我即将运行。

然后跳入虚拟机，然后游戏是，在这台机器上，当它翻译来宾虚拟地址时，它首先将来宾虚拟地址转换为来宾物理地址，来宾设置的页表，然后对该客户物理地址进行另一次翻译，通过EPT获取主机物理地址。

硬件对每个内存引用都自动这样做，客人做这种双重翻译，所以这又是一次，使VM能够控制来宾可以使用的物理内存，客人可以设置任何喜欢的页表，而且可以非常有效地完成它，因为它可以直接执行指令。

但它仍然受到表盘的限制，VMM配置，能够只使用VMM想要使用的物理页面，关于EP有什么问题吗，哦对不起，我有个问题，不是关于，但是关于，嗯，第二组寄存器，所以如果你有两个课程，你想运行两个虚拟机。

它有吗，你给我们拿第三张唱片，每个核心都有自己的一套寄存器，每个核心都有一种独立的，在所有VTX硬件的独立实例中，所以每一个核心，每个核心都有自己的三个，两个通用登记册，它自己的实控寄存器。

和它自己的来宾模式虚拟寄存器，和它自己的和它自己的，e，所以你可以在两个不同的核心上运行两个不同的客户机，他们都有自己的每一个登记册，每个核心都有自己的一个，所以你太需要一个新的虚拟机了。

我是说它可能就像一个普通的操作系统，XV6可以支持多个进程，都是一样的十六，但是尽管就像xpsix有一个结构，每个进程的单独结构过程，我们的虚拟机监视器将有一个单独的结构，结构VM或其他什么。

每个客人都有一个记录，为那位客人猜测信息，好的，我明白了，谢谢。正如我在切换之前提到的，如果你有，你知道一个核心和三个，我猜开关可以由定时器中断驱动，它们将转到虚拟机监视器，不是煤气。

在我切换到虚拟机之前，更多关于虚拟机的问题，这个纸，本文以这个硬件为起点，将其用于其他方面，不是虚拟机，所以他们对报纸很感兴趣，他们更努力地对待这件事，这绝对是为虚拟机设计的，报纸上说，哎呦。

我们可以用这个硬件做一些不是虚拟机的事情，嗯，他们对自己所做的事情的高水平看法是什么，他们只是想实现普通的过程，所以现在我们回到了Linux，否，不再有虚拟机，只有Linux，但是假设VTX硬件是沙丘。

我们有Linux，和，我们假设，我们已经将沙丘可加载内核模块加载到Linux中，而现在，但在很大程度上我们，你知道我们运行Linux，我们希望运行Linux进程。

使用系统调用和Linux进程可以做的所有普通事情，嗯，但是我们想用这个VTX硬件来提供更多，它允许普通过程做一些额外的事情，嗯，所以我们实际上要运行，所以沙丘运行这些过程。

或者你知道允许一个过程切换到沙丘模式，这意味着不仅仅是受到页表的保护和隔离，现在这个过程被完整的VTX设备隔离，所以对于这个过程，沙丘将维持这一过程，现在有这个所有控制寄存器的虚拟集。

就像它自己的CR 3，因此它是自己的页表，因为这个过程将在非路由监督模式下运行，所以它可以运行所有的特权指令，尽管针对BTX实现的虚拟状态，如此如此，这个过程可以做的关键事情之一是。

Dune使用自己的硬件cr three设置自己的页表，当然还有沙丘，你知道的，控制此进程的EPT，所以Epis将被设置为只有条目，对于这个进程是普通的进程内存。

所以这个过程可以把它喜欢的任何东西放在C3中，而是因为mu翻译为epafter通过普通页表翻译，进程仍然无法转义其分配的内存，所以这个过程没有任何额外的力量，相对于其他进程或内核内存。

它现在有了一种更灵活的方式来设置自己的内存好吧，所以沙丘进程可以做的一件事是拥有自己的页表，事实上，它基本上需要有自己的页表，因为否则就行不通了，一个过程可以做的另一件事是，嗯，小虚拟机，能够运行。

能够让监督员代码自己设置，以防止它在来宾用户模式下运行的代码，所以论文真的谈到了这两种不同的用途，你可以对厄运做两件不同的事情，在一个过程中获得的能力，获得对主管与用户模式的硬件支持。

允许他们在沙箱中运行不受信任的插件代码，所以这个想法是，哦，也许你是，也许主程序就像一个网络浏览器，嗯，你知道吗，您可以下载Web浏览器下载插件，您的Web浏览器可能运行一个新的。

视频解码器或新的广告拦截器什么的，但我们并不完全信任那个插件，所以我们想在有限制的特权下运行它，不知何故实际上，这是可能的，但在普通Linux中有点棘手，但是有了沙丘，我们可以把插头插上。

出现在用户空间中，以及在监督者模式下运行在进程中的Web浏览器，可以配置页表，可以绘制不同的页表，呃，用于此用户代码，因为它被允许写c r 3，这可以让它运行这个不受信任的插件代码。

只允许它限制访问Web浏览器内存的某些页面，这样，即使插件代码是恶意的，它不能随意读写，主Web浏览器的内存，如果用户代码，你知道，用户代码可能期望进行系统调用，但是那些系统调用实际上，呃。

过程的主管模式和不进入Linux，所以这个插件代码的用户可能会认为它在调用fork或read，写，或者谁知道是什么，但实际上那些执行系统调用的尝试，在此过程中陷阱进入Web浏览器，它可以为所欲为。

它不能进行系统调用或执行系统调用，或者或者谁知道什么，所以现在，我们的Web浏览器可以完全控制沙箱插件代码，作为一个快速概述，任何关于使用沙丘到沙箱的问题，公平地说，这是什么。

这是一个可以通过使用现有Linux的完全不同的技术来实现的效果，设施，但沙丘可以让你以一种特别优雅和高效的方式提供它，通过使用VTX硬件，报纸上说的另一件事是利用沙丘，是为了让垃圾回收更快，在这里。

它是，嗯，它的方式，即通过允许垃圾收集，所以我们不再做沙箱了，我们实际上甚至没有使用用户模式，我们只有一个节目，嗯，我们假设我们正在编写任何程序，谁知道是什么，而是用垃圾收集的语言，就像，你知道的。

Java或Python之类的，垃圾收集可能很慢，你知道的，有几十个技巧可以让垃圾收集更快，但是垃圾收集器很重要的一点是，垃圾收集器是，是一些许多垃圾收集器的跟踪，找到还活着的记忆。

通过跟踪所有对象的所有指针，它仍然是活动的，从寄存器开始，如果它在完成跟踪后没有找到某个对象，那么那个物体是无法到达的，不被任何指针引用，可以释放，但是许多垃圾收集器同时运行。

就像在不同的线程或主程序中一样，因此，垃圾收集器可能已经开始跟踪指针，你知道吗，可能来自一些寄存器，这跟在指向此对象的指针后面，它有指向这些对象的指针，垃圾收集器跟着它，到这些指向对象树或图的指针。

也许垃圾收集器已经得到了，你知道的，到目前为止在这里，实际上追踪所有这些物体，但是因为垃圾收集器与程序本身并发运行，可能程序修改了这个对象，垃圾收集者已经追踪到了，所以这是一个糟糕的交易，你知道的。

因为现在，垃圾收集器已经确定是活的还是死的对象指针列表，或者任何可能不正确的东西，因为已经看到的对象已经被程序修改了，我也是，使用页表支持，为垃圾收集器提供了一种方法来检测类似的权限，特别是。

沙丘设置UCR三号，你知道的，VTX支持的虚拟CR3指向自己的页表，然后它保留所有这些页表项有效，但它看着D位，你知道的，每个页面标签洗衣都有一个脏的位，指示，有人写信给那一页。

所以如果程序写了一些对象，然后相应页面中的脏位，在页表中，脏位将被设置，因此，垃圾收集器中的政府完成了对对象的跟踪，它返回并查看页表中的d位，查找包含可能已修改的对象的所有页面，并重新扫描这些对象，嗯。

事实证明，这种获取D位的工具既困难又缓慢，使用普通Linux，嗯，我甚至不知道Linux是否支持，在一些操作系统中，您可以进行系统调用来请求d位，但是如果你用沙丘和VTX，那么嗯。

这个过程可以使用普通的加载和存储指令来获得PAND，因此D位，它非常快，所以他们向你展示了这对一些程序来说是一个技巧，你知道的，密集的垃圾收集使程序明显更快，如果沙箱程序会发生什么，嗯。

比如运行自己的垃圾收集器之类的，我明白了，所以我们开始用好的，所有的权利，所以我们有一个嗯，我们用沙丘，嗯，我们有一个沙丘过程，这实际上是使用VTX的主管对用户模式，我们在上面运行一个插件。

在用户模式下和插件，但它也是用垃圾收集的语言写的，并想使用，喜欢有自己的页表，它自己的CR 3，指向自己的页表，有自己的V位，现在不管用了，因为我们要运行，沙丘希望您运行插件的方式，沙箱插件。

就是运行它们并在，不允许来宾用户模式，就像用户模式一样，在用户模式下，不允许考虑CR 3等，在来宾用户模式下，我们没有自己的页表，所以我们不能快速访问比特，只有在客人监督模式下，我们才能有自己的C3。

所以你不能，有，没有明显的方法将这两个技巧结合起来，沙丘允许的两种技巧，怎么样，假设有人写了一个，呃，嗯，浏览器，呃，实际上用沙丘，嗯，这意味着这将是相当困难的，如果有些电脑不支持沙丘什么的。

就像很难把铬放进，你用沙丘，如果不是的话，每个人都有内核模块，所以说，首先呢，您必须运行在支持VTX的计算机上，你知道的，底层计算机支持BTX，这意味着许多英特尔芯片，很多，所以你需要VTX来运行沙丘。

你和沙丘必须加载才能在浏览器中运行，利用曲调的优势，所以是的，你得正确地解决这个问题，嗯，你知道的，我是说，这是一个研究项目，它是，你知道的，它是，它的目的是，让人们思考可以在现实世界中部署的东西。

如果他们是，如果它们看起来足够有价值，所以和，你知道的，就像Linux一样，Linux有成百上千的功能，所以如果有人决定在Linux中添加DOE，你知道作为一个标准功能，然后我想你可以开始依赖它。

Chrome可以直接使用它，不会有问题，但后来，对不起，所以在高水平上，就像我们喜欢做VM一样，但是您运行的不是VM，而是进程，或者是的，或者是的，你可以用任何一种方式来表达，这是我的意思，是的是的。

这是一篇报道，主要是过程抽象，因为，但是它使用而不是使用页表硬件，你知道它使用CPU硬件来支持进程抽象，但不是那样，它使用的特殊CPU硬件是VTX硬件，你知道它有一些额外的功能。

就像建立自己的体育课的能力一样，我明白了，我记得我在报纸上读过过程级抽象，但我不明白那是什么意思，但现在我明白了，谢谢。你知道的，时间到了，我很高兴继续，如果有人还有问题，我很乐意回答，是啊，是啊。

所以我有一个特别的问题关于报纸上说的，呃呃，如果像沙丘一样的处理器在里面处理，沙丘叉，它变成了一个不做的过程，在某种程度上，这不是像一只安全苍蝇吗，或者是什么攻击，好吧，你运行的东西作为一个厄运过程。

以为现在安全了，但它可以跑，它可以抓或逃跑，所以有可能，是啊，是啊，好的，所以如果让我们在主管模式下看到下面的代码，你知道这没有安全问题，你知道关于这个代码，因为它已经有了任何特权，在可能的情况下。

它已经，它不会获得任何额外的支柱，就像猪肉一样对吧，好的，编码，但你知道，也许它是用沙丘来沙箱和插件，我们这里有不可信的代码，让它毫无厄运地运行是危险的，因为它不被信任，我们用厄运来沙箱。

所以如果我们分叉，你什么都知道，好的，所以这段代码不能正确分叉，您可以尝试调用fork系统调用，但是如果一个系统在这里调用指令，陷阱进入此过程的主管部分，大概主管流程这个流程的一部分是仔细写的。

不要上当，所以它实际上不是叉子，所以那不起作用，如果主管代码，允许叉子，允许进行此系统调用，使用相同的内存映像获得此进程的分叉，所以我们要把插头插在这里，我看它有没有意识到叉子把沙丘关掉了，它做到了。

我是说很难想象这怎么会发生，但如果它现在恢复了插件的执行，那将是非常愚蠢的，因为现在插头在沙箱里，你知道事实上，我想这个，你知道跳入沙箱的代码涉及特权指令，就像在风险5中一样，因为它打开了来宾模式。

如果你问你这里的指示，那是非法指令，所以我想我想我误解的是，我认为插件不是一个过程，就像沙丘过程是沙箱，插头就在里面，学生进程只是启用了使用功能，让插头和运行得更快，基本上是对的。

我们绝对假设下面的这个软件很聪明，他对预防的谨慎，你知道之前要打的沙箱，它可以是一个生命，也不是，它不是，对沙丘进程的安全有监督模式，因为它实际上是非根模式下的主管模式。

这是相同的主管模式和客人OS权利，所以就像，你可以让它做任何事情，只是因为它因为ATX，它将像一个虚拟机，所以它不会伤害我们，这是正确的，它无法逃离它的地址空间，是一组BT，将其约束到其地址空间。

那是有道理的，所以我的最后一件事，嗯，我，我有像一个段落，呃在EPS上，它说用户页表可以扩展地址，把它们重新映射到原来的布局，我就是不明白，整段，所以我不明白，也许这有点具体，我想是怎么回事，是那个嗯。

物理地址在x8上，6位比虚拟地址少，所以我猜，所以这意味着你知道的，普通页表映射，虚拟地址到物理地址，物理地址的位更少，因此压缩了，那意味着，嗯，当Dune为进程设置地址空间时，或者从一个角度来看。

是在为进程设置地址空间时，进程地址空间必须适合，沙丘进程的较少位数，好的，可以使用常规流程，我不知道数字是多少，让我们说，四个八位虚拟地址，但也许物理地址又只有3个6位，这是我编的，好的。

普通进程可以使用所有四个八位作为虚拟地址，一个沙丘过程只能使用三个，六个什么的，但就像有不同的规则，事情必须适应，我有一个关于BTX计划的问题，以及我们如何访问页表，所以，嗯，当喜欢的方式。

我们正在访问页表，因为我们要去EP，然后在这里做第二层翻译，从来宾物理地址到主机物理地址，um是访问页表的延迟，实际上更低，需要更多的时间，可能需要更多的时间，可能有更多的时间来转移硬件。

MMU来翻译它并穿衣服，因为现在我们必须做得太好了，最坏的情况要糟糕得多，因为你知道，关于风险五，页表有多个级别，所以Mu s或是从这个页面进入的，从这个pcp，然后x和x，每一个。

XE 6也有多个关卡，所以在x8中，查找中的六个，在第一个，在主页表中，还必须进行多个内存引用，这些多个内存引用中的每一个都必须经过ep和epis，还有一个多级页表，是啊，是啊。

所以我甚至不知道内存引用的最坏情况是多少，但在VTX下比在非VTX下更糟糕，那就是普通案件了，所以有一个潜力，事实上有很多缓存，所以通常你不会遇到最坏的情况，但是好吧，好的，嗯，所以虚拟机是。

他们今天还是很慢，如果是这样，我想我在想，AWS是如何工作的，如果嗯，它似乎很快，似乎工作得很好，所以我相信他们使用VTX硬件，他们使用我们所说的支持，它也是高效设备访问的聪明设备方案。

结果是AWS虚拟机，或者我们不比真正的电脑慢多少，酷，非常感谢，是呀，我还有一个关于影子咖啡的问题，特朗普，所以你说它就像，我明白你会怎么做，但它真的会让咖啡的影子，还是只是，我想一定是版权的阴影。

因为它必须允许过程自己做，不喜欢去陷阱的速度，但每次都这么做，它还记得以前的井吗，好的，是啊，是啊，如此如此是的，是的，是的，虚拟机监视器必须创建一个新的页表，或者在那里你知道是的。

它必须创建一个新的页表，它是虚拟机监视器，你知道页表，它格式化了，这就是现在真正的硬件使用的，当然，有很多缓存和重用的机会，所以如果和聪明的虚拟机监控，如果他们注意到哦客人变了，就一个PTE，然后呢。

虚拟机监视器可能能够做相应的事情，更新其阴影页表的工作量有限，它也可以让你知道什么时候，如果它是在多个虚拟机之间多路复用分时，虚拟机监视器将保持在阴影页表周围，对于不运行的虚拟机。

这样当它切换回虚拟机时，它就可以直接重用它们，好的，我明白了，所以这并不意味着你有喜欢，你必须记住一个影子副本，就像，每个虚拟机的每个进程，是呀，有很多很多对，虚拟机中有很多很多的页表。

虚拟机知道客户机所做的所有页表切换，是啊，是啊，这是一个，维护阴影页表的具体问题，嗯，消耗了大量的工作，之前太谢谢你了，你知道的，这是硬件支持的虚拟机让许多事情之一，好的，好的，我明白了，我明白了。

好的，因为BT意味着你，不必编造你自己的影子页，对对，对呀，是啊，是啊，那很好，是啊，是啊，谢谢。是呀，所有的权利，我要去头，但我们星期三见，谢谢。谢谢。拜拜拜拜，谢谢。可以吗，你还有时间再问一个问题。

是呀，拜托了，啊，这一个是关于垃圾收集如何像重新扫描，嗯，看看是否喜欢肮脏的部分，嗯喜欢，这像是一种持续的过程吗，就像它无限期地继续重新扫描一样，因为嗯不能，你在问，哦，是啊，是啊，它会终止吗？假设。

哦，总有一些新的修改，所以事实上潜在的问题，事实上，垃圾收集器所做的，是吗它做到了一次通过一次通过完成，然后它冻结了其他一切，但是垃圾收集器，所以没有其他事情发生，然后它回去看看脏页。

但当然其他一切都冻结了，所以不再有肮脏的页面出现，然后是垃圾，所以这里的垃圾查看所有的脏页面，然后它知道它做到了，你知道做任何它应该做的事情来完成并创建免费列表，然后它恢复它拥有的所有线程，然后就停了。

好的，是啊，是啊，好的，这就更有意义了，我知道它长出了其他一切，但是是的，这是一个复杂的东西，当然，报纸上没有足够的空间做纸，来解释所有的和分析，让捡垃圾的停下来太悲伤地，所有的权利，是啊，是啊。

非常感谢。